<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub SLAP</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Palette: SLAP Brand Colors: #F1D24B (Yellow), #FF5C3D (Orange), #84C7DF (Blue), #8671D1 (Purple) -->
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            line-height: 1.25;
        }
        .nav-item.active {
            background-color: #FFFBEB; /* yellow-50 */
            color: #F1D24B;
            font-weight: 600;
        }
        .tab-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background-color: #f9fafb;
            color: #6b7280;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        .tab-btn.active {
            background-color: #F1D24B;
            color: #44403c;
            border-color: #F1D24B;
            font-weight: 600;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e7e5e4; padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h4 { font-size: 1.25rem; font-weight: 700; color: #44403c; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: #a8a29e; }

        .base-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s; }
        .base-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .status-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-aprovado, .status-presencial, .status-ativo { background-color: #D1FAE5; color: #065F46; }
        .status-online, .status-em-andamento, .status-inativo { background-color: #DBEAFE; color: #1E40AF; }
        .status-concluída { background-color: #F3F4F6; color: #4B5563; }
        .status-pendente, .status-em-espera { background-color: #FEF3C7; color: #92400E; }
        .status-vip { background-color: #F1D24B; color: #1f2937; font-weight: 700; }
        .status-turma { background-color: #84C7DF; color: #1f2937; font-weight: 700; }
        .status-dupla { background-color: #8671D1; color: #ffffff; font-weight: 700; }
        .status-rejeitado, .status-cancelado { background-color: #FEE2E2; color: #991B1B; }

        .status-financeiro { background-color: #D1FAE5; color: #065F46; }
        .status-pedagógico { background-color: #DBEAFE; color: #1E40AF; }
        .status-comercial { background-color: #FEF3C7; color: #92400E; }
        .status-marketing { background-color: #FEE2E2; color: #991B1B; }

        .sector-tag, .keyword-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1.5px solid #F1D24B;
            color: #44403c;
            background-color: transparent;
        }

        .task-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s ease; }
        .task-card.completed { background-color: #f9fafb; border-color: #e5e7eb; }
        .task-card.completed p { text-decoration: line-through; color: #9ca3af; }
        .task-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .user-tag { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .tag-admin { background-color: #E5E7EB; color: #374151; }
        .tag-break { background-color: #374151; color: #FFFFFF; }
        .deadline-text { font-weight: 600; color: #57534e; }
        .deadline-overdue { color: #b91c1c; }
        .task-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        .task-delete-btn:hover { color: #ef4444; }

        .page-number-btn { padding: 0.25rem 0.75rem; border: 1px solid #d6d3d1; background-color: #ffffff; color: #44403c; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .page-number-btn:hover { background-color: #f5f5f4; border-color: #F1D24B; }
        .page-number-btn.active { background-color: #F1D24B; border-color: #F1D24B; color: #44403c; font-weight: 600; }

        .grade-select-container { margin-bottom: 1.5rem; max-width: 400px; }
        .grade-select { width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #d6d3d1; background-color: #ffffff; font-weight: 600; color: #44403c; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; cursor: pointer; }
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .day-column { background-color: #f9fafb; border-radius: 0.75rem; padding: 1rem; border: 1px solid #f3f4f6; }
        .day-column-header { font-weight: 700; color: #44403c; font-size: 1.25rem; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 2px solid #F1D24B; }
        .class-entry { background-color: #ffffff; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .class-entry:hover { transform: translateY(-2px); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .class-tag { font-size: 0.625rem; font-weight: 700; padding: 2px 8px; border-radius: 9999px; color: white; margin-bottom: 4px; display: inline-block; text-transform: uppercase; }
        .tag-turma { background-color: #FF5C3D; }
        .tag-vip { background-color: #8671D1; }
        .tag-dupla { background-color: #F1D24B; color: #1f2937; }

        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { font-weight: 600; font-size: 0.875rem; color: #6b7280; }
        .data-table tbody tr.paid { background-color: #f9fafb; color: #9ca3af; }
        .data-table tbody tr.paid .font-medium { text-decoration: line-through; }
        .data-table tbody tr:not(.paid):hover { background-color: #f9fafb; cursor: pointer; }
        .data-total { margin-top: 1.5rem; text-align: right; }
        .data-total p { font-size: 1.25rem; font-weight: 700; color: #1f2937; }

        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .form-input select, select.form-input { 
            -webkit-appearance: none; 
            appearance: none; 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); 
            background-position: right 1rem center; 
            background-repeat: no-repeat; 
            background-size: 1.25em 1.25em; 
            padding-right: 3rem; 
            cursor: pointer; 
        }
        .form-input:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        .primary-btn { background-color: #F1D24B; color: #44403c; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; border: none; cursor: pointer; display: inline-flex; align-items: center; white-space: nowrap; }
        .primary-btn:hover { background-color: #eab308; }
        .primary-btn.full-width { width: 100%; justify-content: center; }
        .secondary-btn { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .secondary-btn:hover { background-color: #e5e7eb; }
        .secondary-btn.active { background-color: #F1D24B; color: #44403c; border-color: #F1D24B;}
        .danger-btn { background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; border: none; cursor: pointer; }
        .danger-btn:hover { background-color: #dc2626; }

        .cp-level-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cp-level-content { padding: 0 1.5rem; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding-bottom 0.3s ease-out; }
        .cp-level-card.open .cp-level-content { max-height: 6000px; padding-bottom: 1.5rem; }
        .cp-lesson-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; }
        .cp-lesson-item:nth-child(odd) { background-color: #f9fafb; }



        /* --- PEF Styles (Integrated) --- */
        .pef-lesson-row { display: grid; grid-template-columns: 80px 150px 1fr; align-items: start; gap: 1rem; padding: 1rem 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .pef-lesson-row:last-child { border-bottom: none; }
        .pef-student-attendance-row { display: flex; align-items: center; justify-content: space-between; margin-left: 1rem; padding: 0.5rem 0; }
        .pef-status-btn-group button { width: 2.5rem; height: 2.5rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background-color: #f9fafb; }
        .pef-status-btn-group button:hover { border-color: #a8a29e; }
        .pef-status-btn-group button.active.P { background-color: #10B981; color: white; border-color: #10B981; }
        .pef-status-btn-group button.active.F { background-color: #EF4444; color: white; border-color: #EF4444; }
        .pef-status-btn-group button.active.PP { background-color: #F59E0B; color: white; border-color: #F59E0B; }

        /* --- Calendar Styles --- */
        .calendar-container { max-width: 1200px; margin: 0 auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .calendar-nav-btn { background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .calendar-nav-btn:hover { background-color: #e5e7eb; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .calendar-day-header { background-color: #f9fafb; padding: 1rem; text-align: center; font-weight: 700; color: #44403c; }
        .calendar-day { background-color: white; min-height: 120px; padding: 0.5rem; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .calendar-day:hover { background-color: #fffbeb; }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-day.today { background-color: #fef3c7; border: 2px solid #F1D24B; }
        .calendar-day-number { font-weight: 600; margin-bottom: 0.25rem; }
        .calendar-event { background-color: #F1D24B; color: #44403c; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.75rem; margin-bottom: 0.125rem; cursor: pointer; display: block; }
        .calendar-event:hover { background-color: #eab308; }
        .calendar-event.gravacao { background-color: #10B981; color: white; }
        .calendar-event.lembrete { background-color: #F59E0B; color: white; }
        .calendar-event.evento { background-color: #8671D1; color: white; }
        .calendar-event.aula-extra { background-color: #FF5C3D; color: white; }
        .calendar-event.data-comemorativa { background-color: #84C7DF; color: white; }
        .calendar-event.reuniao { background-color: #6B7280; color: white; }
        .marketing-event { background-color: #84C7DF !important; color: white !important; }
        .marketing-event:hover { background-color: #6ba3c7 !important; }
        .marketing-event .event-tipos { display: block; font-size: 0.65rem; opacity: 0.9; margin-top: 2px; }
        
        .holiday-event { 
            background-color: #8671D1 !important;
            color: white !important;
            cursor: default !important;
            border: 1px solid #a855f7;
        }
        .holiday-event:hover { 
            background-color: #7c3aed !important;
            transform: none !important;
        }
        .event-country {
            background: rgba(255,255,255,0.2);
            padding: 1px 3px;
            border-radius: 2px;
            font-size: 8px;
            margin-left: 2px;
        }

        /* --- Monthly Highlight Styles --- */
        .highlight-card { display: flex; gap: 1rem; align-items: center; }
        .highlight-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #F1D24B; }
        .highlight-info h5 { font-size: 1.125rem; font-weight: 700; color: #44403c; margin-bottom: 0.25rem; }
        .highlight-info p { color: #6b7280; font-size: 0.875rem; line-height: 1.4; }
        .highlight-award { color: #059669; font-size: 0.875rem; margin-top: 0.5rem; }
        .highlight-empty { text-align: center; padding: 2rem; color: #9ca3af; }

        /* --- Pedagogical Challenge Styles --- */
        .pedagogical-quiz-option {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            text-align: left;
            background-color: #f5f5f4;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .pedagogical-quiz-option:hover:not(:disabled) {
            background-color: #e7e5e4;
            border-color: #F1D24B;
        }
        .pedagogical-quiz-option:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        .pedagogical-quiz-option.correct {
            background-color: #D1FAE5;
            border-color: #34D399;
            color: #065F46;
            font-weight: 600;
        }
        .pedagogical-quiz-option.incorrect {
            background-color: #FEE2E2;
            border-color: #F87171;
            color: #991B1B;
            font-weight: 600;
        }
        .audio-player-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 450px;
            background-color: #f5f5f4;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
        }
        .play-pause-button {
            background-color: #F1D24B;
            color: #44403c;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .play-pause-button:hover { background-color: #eab308; }
        .play-pause-button svg { width: 20px; height: 20px; }
        .progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #e7e5e4; border-radius: 3px; outline: none; cursor: pointer; }
        .progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #44403c; border-radius: 50%; cursor: pointer; }
        .progress-bar::-moz-range-thumb { width: 16px; height: 16px; background: #44403c; border-radius: 50%; cursor: pointer; }
        .time-display { font-size: 0.875rem; color: #57534e; min-width: 80px; text-align: center; }
        #certificate {
            background: linear-gradient(45deg, #fffbeb, #f0f9ff);
        }

        /* --- Guidelines Styles --- */
        .guidelines-search { width: 100%; max-width: 400px; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 2rem; }
        .guideline-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.2s; }
        .guideline-card.good-practice { border-left: 4px solid #10B981; }
        .guideline-card.prohibited { border-left: 4px solid #EF4444; }
        .guideline-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .guideline-icon { margin-right: 0.75rem; }
        .guideline-header { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .guideline-title { font-size: 1.125rem; font-weight: 700; color: #44403c; }
        .guideline-description { color: #6b7280; line-height: 1.5; }
        .guideline-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; margin-left: auto; padding: 0.25rem; }

        /* --- Pagination Styles --- */
        .pagination-controls { margin-top: 1rem; }
        .pagination-btn { 
            padding: 0.5rem; 
            border: 1px solid #d1d5db; 
            background: #ffffff; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pagination-btn:hover:not(.disabled) { 
            background: #f3f4f6; 
            border-color: #9ca3af; 
        }
        .pagination-btn.disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background: #f9fafb;
        }
        .pagination-number { 
            padding: 0.5rem 0.75rem; 
            border: 1px solid #d1d5db; 
            background: #ffffff; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .pagination-number:hover { 
            background: #f3f4f6; 
            border-color: #9ca3af; 
        }
        .pagination-number.active { 
            background: #F1D24B; 
            border-color: #F1D24B; 
            color: #1f2937;
            font-weight: 700;
        }
        .guideline-delete-btn:hover { color: #ef4444; }

        /* --- BrainFlip Game Styles --- */

        /* BrainFlip Flashcard Styles */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 400px;
            height: 250px;
            margin: 0 auto;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background-color: #ffffff;
            border: 2px solid #84C7DF;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #44403c;
            line-height: 1.4;
        }
        .flashcard-front {
            background: linear-gradient(135deg, #F1D24B 0%, #FF5C3D 100%);
        }
        .flashcard-back {
            background: linear-gradient(135deg, #84C7DF 0%, #8671D1 100%);
            transform: rotateY(180deg);
            color: white;
        }
        .navigation-button-game {
            background-color: #F1D24B;
            color: #44403c;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .navigation-button-game:hover {
            background-color: #eab308;
        }
        .navigation-button-game:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <!-- Login, Pending, and Hub Views -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <!-- O conteúdo do login será gerado pelo JS -->
    </div>

    <div id="pending-view" class="hidden items-center justify-center min-h-screen">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold" style="color: #F1D24B;">Aguardando Aprovação</h2>
            <p class="text-stone-600 mt-2">Sua conta foi criada e está aguardando aprovação de um administrador.</p>
            <button id="pending-logout" class="mt-6 secondary-btn w-auto">Sair</button>
        </div>
    </div>

    <div id="hub-view" class="hidden">
        <div id="app-container" class="min-h-screen md:flex bg-stone-50">
            <aside class="md:w-64 bg-white md:border-r border-b border-stone-200 p-4 md:p-6 flex flex-col h-screen md:h-auto">
                <div class="mb-4 text-center">
                    <div>
                        <img id="profile-picture" src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Foto de Perfil" class="w-24 h-24 mx-auto rounded-full object-cover border-4 border-stone-200">
                    </div>
                </div>
                <h1 class="text-xl font-bold text-stone-800 text-center">Hub SLAP</h1>
                <p id="welcome-message" class="text-center text-sm text-stone-600 mb-6"></p>
                <nav id="main-navigation" class="space-y-1 flex-1 overflow-y-auto">
                    <!-- Menu items are dynamically generated here -->
                </nav>
                <div class="pt-4 border-t border-stone-200 mt-4">
                    <button id="logout-button" class="nav-item w-full text-left px-4 py-2.5 rounded-lg text-stone-700 hover:bg-red-50 hover:text-red-600 transition-colors flex items-center font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Sair
                    </button>
                </div>
            </aside>

            <main class="flex-1 relative">
                <div class="bg-[#F1D24B] block w-full p-4 sm:p-6 md:p-8 absolute top-0 left-0 right-0 z-10">
                    <div class="flex justify-between items-start">
                        <header id="main-header" class="flex items-center gap-4">
                            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1751163691/SLAP_TIPO_PRETO_1_xarnpe.png" alt="SLAP Logo" class="h-12 w-auto">
                            <div>
                                <h2 id="main-title" class="text-3xl font-bold text-stone-800"></h2>
                                <p id="main-description" class="mt-1 text-stone-700"></p>
                            </div>
                        </header>
                        <div id="header-welcome-message" class="text-right text-stone-800">
                            <!-- Welcome message will be inserted here -->
                        </div>
                    </div>
                </div>
                <div id="content-area" class="pt-32 pb-4 px-4 sm:pt-36 sm:pb-6 sm:px-6 md:pt-40 md:pb-8 md:px-8"></div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="form-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-header-container" class="modal-header">
                <h4 id="form-modal-title"></h4>
                <button class="modal-close-btn" data-action="close-modal" style="padding: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="form-modal-content-area"></div>
        </div>
    </div>

    <!-- Fortune Cookie section - no modal needed -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, serverTimestamp, query, setDoc, getDoc, updateDoc, orderBy, limit, where, arrayUnion, arrayRemove, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

        // --- GLOBAL VARIABLES ---
        const contentArea = document.getElementById('content-area');
        const mainHeader = document.getElementById('main-header');
        const loginView = document.getElementById('login-view');
        const hubView = document.getElementById('hub-view');
        const pendingView = document.getElementById('pending-view');

        let db, auth, storage, userId, currentUserName, currentUserRole;
        let usersData = [], students = [], turmas = [], vips = [], attendance = [], tasks = [], events = [], collaborators = [], schedules = [], expenses = [], dojoRanking = [], dojoMissions = [];
        let userProfiles = {};
        let monthlyHighlight = {
            name: 'João Silva',
            photo: 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg',
            description: 'Parabéns ao João pelo excelente desempenho este mês! Destaque em dedicação e resultados excepcionais.',
            award: 'Voucher de R$ 200 para compras'
        };
        let allUnsubscribers = [];
        const appId = 'hub-gestao-slap';

        // Pagination state
        let currentPage = 1;
        let itemsPerPage = 20;

        // --- DEVELOPMENT MODE FUNCTIONS ---
        function startAppInDevelopmentMode() {
            window.isDevelopmentMode = true;
            // Set up basic user data for development
            currentUserName = "Admin SLAP";
            currentUserRole = "admin";
            userId = "demo-user";

            // Set profile picture
            document.getElementById('profile-picture').src = 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg';

            // Initialize with demo data
            // loadDemoData(); // Function removed with CPs cleanup
            updateWelcomeMessages(currentUserName);
            showHubView();
            renderInicioSection();
            renderMenu();
        }




        function safeDeleteItem(collection, id, itemName = 'item') {
            
            // Continuar com a operação de deletar
            deleteItem(collection, id);
        }



        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                    ? JSON.parse(__firebase_config)
                    : (typeof window.firebaseConfig !== 'undefined' ? window.firebaseConfig : {});

                if (!firebaseConfig.apiKey) {
                    console.warn("Configuração do Firebase não encontrada. Executando em modo de desenvolvimento local.");
                    // Initialize in development mode with localStorage
                    window.isDevelopmentMode = true;
                    startAppInDevelopmentMode();
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        await initializeAppWithUser(user);
                    } else {
                        showLoginView();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        async function initializeAppWithUser(user) {
            userId = user.uid;
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                currentUserName = userData.name || user.displayName;
                currentUserRole = userData.role;

                if (['admin', 'am', 'ap', 'pedagogico', 'financeiro', 'teacher'].includes(currentUserRole)) {
                    setupFirestoreListeners();
                    updateWelcomeMessages(currentUserName);
                    showHubView();
                } else {
                    showPendingView();
                }
            } else {
                showPendingView();
            }
        }

        // --- FIRESTORE LISTENERS ---
        function setupFirestoreListeners() {
            if (!db || !userId) return;
            allUnsubscribers.forEach(unsub => unsub && unsub());
            allUnsubscribers = [];

            const getCollectionListener = (collectionName, targetArray, renderFunc, q) => {
                const collRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                const finalQuery = q ? q(collRef) : query(collRef);
                const unsubscribe = onSnapshot(finalQuery, (snapshot) => {
                    targetArray.length = 0;
                    snapshot.docs.forEach(doc => targetArray.push({ id: doc.id, ...doc.data() }));

                    const activePageId = contentArea.firstElementChild?.id;
                    if (renderFunc && activePageId) {
                        const pageBaseName = activePageId.replace('-section', '');
                         if (pageBaseName.startsWith(collectionName.slice(0, -1).replace('_', '-').toLowerCase()) || pageBaseName === 'inicio') {
                            renderFunc();
                        }
                    }
                }, (error) => console.error(`Error on ${collectionName} listener:`, error));
                allUnsubscribers.push(unsubscribe);
            };

            getCollectionListener('users', usersData, null);
            getCollectionListener('students', students, () => {
                if (contentArea.firstElementChild?.id === 'alunos-section') {
                    resetPagination();
                    renderAlunosSection();
                }
                if (contentArea.firstElementChild?.id === 'turmas-section') renderTurmasSection();
                if (contentArea.firstElementChild?.id === 'vips-section') renderVipsSection();
            });
            getCollectionListener('turmas', turmas, renderTurmasSection);
            getCollectionListener('vips', vips, renderVipsSection);
            getCollectionListener('attendance', attendance, () => {
                const activeModal = document.querySelector('.modal-overlay.visible');
                if (activeModal && activeModal.querySelector('[data-pef-modal="true"]')) {
                    const pefType = activeModal.dataset.pefType;
                    const unitId = activeModal.dataset.unitId;
                    if (pefType === 'turma') {
                        openTurmaPefModal(unitId);
                    } else if (pefType === 'vip') {
                        openVipPefModal(unitId);
                    }
                }
            });
            getCollectionListener('tasks', tasks, renderTarefasSection);

            getCollectionListener('collaborators', collaborators, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'grade-section') renderGradeSection();
                if (activePageId === 'tasks-section') renderTarefasSection();
                if (activePageId === 'colaboradores-section') renderColaboradoresSection();

                if (activePageId === 'inicio-section') renderInicioSection();
            });
            getCollectionListener('events', events, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'campanhas-section') renderCampanhasSection();
            });
            getCollectionListener('schedules', schedules, () => {
                 if (contentArea.firstElementChild?.id === 'grade-section') renderGradeSection();
            });
            getCollectionListener('expenses', expenses, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'folha-pagamento-section') renderFolhaPagamentoSection();
            });




            getCollectionListener('dojo_ranking', dojoRanking, renderDojoSection);
            getCollectionListener('dojo_missions', dojoMissions, renderDojoSection, (ref) => query(ref, orderBy("points", "desc")));
            // getCollectionListener('fluxos', fluxos, renderFluxosSection); // Fluxos section removed

            
            // Load monthly highlight with real-time updates
            if (db) {
                const highlightRef = doc(db, `artifacts/${appId}/public/data/monthly-highlight`, 'current');
                const unsubscribeHighlight = onSnapshot(highlightRef, (docSnap) => {
                    console.log('Monthly highlight snapshot received:', docSnap.exists());
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        console.log('Monthly highlight data:', data);
                        monthlyHighlight = data;
                        
                        // Re-render if we're on the dashboard
                        const activePageId = contentArea.firstElementChild?.id;
                        if (activePageId === 'inicio-section') {
                            renderMonthlyHighlight();
                        }
                    } else {
                        console.log('No monthly highlight document found');
                    }
                }, (error) => {
                    console.error('Error listening to monthly highlight:', error);
                });
                allUnsubscribers.push(unsubscribeHighlight);
            }
        }

        // --- AUTH, VIEW, and MENU FUNCTIONS ---
        function showLoginView() {
            hubView.classList.add('hidden');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            loginView.classList.remove('hidden');
            loginView.classList.add('flex');
            loginView.innerHTML = `
                <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-lg">
                    <div class="text-center">
                        <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Logo SLAP" class="w-24 h-auto mx-auto rounded-lg mb-4">
                        <h2 class="text-2xl font-bold text-stone-900">Acesse sua conta</h2>
                        <p class="mt-2 text-sm text-stone-600">Bem-vindo(a) de volta!</p>
                    </div>
                    <form id="login-form" class="mt-8 space-y-6">
                        <div>
                            <label for="login-email" class="sr-only">E-mail</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="form-input" placeholder="Endereço de e-mail">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">Senha</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="form-input" placeholder="Senha">
                        </div>
                        <p id="login-error" class="text-sm text-red-600 text-center"></p>
                        <div>
                            <button type="submit" class="primary-btn full-width">Entrar</button>
                        </div>
                    </form>
                    <p class="text-sm text-center text-stone-600">
                        Não tem uma conta?
                        <button data-action="open-signup" class="font-medium" style="color: #F1D24B;">Cadastre-se</button>
                    </p>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function showHubView() { 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            hubView.classList.remove('hidden'); 
            const firstName = (currentUserName || '').split(' ')[0];
            document.getElementById('welcome-message').textContent = `Bem-vindo(a), ${firstName}`;
            renderMenu(); 
            
            // FORCE dashboard load and prevent interference from Firebase listeners
            setTimeout(() => {
                renderInicioSection(); 
                setActiveNavItem(document.querySelector('[data-target="inicio"]')); 
            }, 50);
            
            // Additional safeguard - force dashboard after Firebase data loads
            setTimeout(() => {
                renderInicioSection(); 
                setActiveNavItem(document.querySelector('[data-target="inicio"]')); 
            }, 500);
        }
        function showPendingView() { 
            hubView.classList.add('hidden'); 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.remove('hidden'); 
            pendingView.classList.add('flex');
        }
        function setActiveNavItem(element) { document.querySelectorAll('#main-navigation .nav-item').forEach(item => item.classList.remove('active')); if (element) element.classList.add('active'); }
        async function handleLogin(event) {
            event.preventDefault();
            const email = event.target.email.value;
            const password = event.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                const errorElement = document.getElementById('login-error');
                if(errorElement) errorElement.textContent = "E-mail ou senha inválidos.";
            }
        }
        async function handleSignUp(event) { event.preventDefault(); const name = event.target.name.value; const email = event.target.email.value; const password = event.target.password.value; try { const cred = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(cred.user, { displayName: name }); await setDoc(doc(db, "users", cred.user.uid), { name, email, role: "pending", createdAt: serverTimestamp() }); await signOut(auth); showSuccessMessage("Cadastro Concluído!", "Sua conta foi criada. Aguarde aprovação de um administrador para acessar."); } catch (error) { showErrorMessage("Erro", "Erro ao criar conta. Verifique o e-mail e a senha."); } }
        async function handleLogout() { 
            await signOut(auth);
        }

        // --- LOCATION TOGGLE FUNCTION ---
        function toggleLocationFields() {
            const foraBrasilCheckbox = document.getElementById('aluno-fora-brasil');
            const estadoSelect = document.getElementById('aluno-estado');
            const continenteSelect = document.getElementById('aluno-continente');
            const locationLabel = document.getElementById('location-label');
            
            if (foraBrasilCheckbox.checked) {
                estadoSelect.style.display = 'none';
                continenteSelect.style.display = 'block';
                locationLabel.textContent = 'Continente';
                estadoSelect.value = ''; // Clear estado value
            } else {
                estadoSelect.style.display = 'block';
                continenteSelect.style.display = 'none';
                locationLabel.textContent = 'Estado';
                continenteSelect.value = ''; // Clear continente value
            }
        }

        // Initialize location fields when modal opens
        window.initializeLocationFields = function() {
            const foraBrasilCheckbox = document.getElementById('aluno-fora-brasil');
            if (foraBrasilCheckbox) {
                toggleLocationFields();
            }
        };

        // --- CONTENT RENDERING ---
        function renderInicioSection() {
            document.getElementById('main-title').textContent = 'Dashboard';
            document.getElementById('main-description').textContent = 'Visão geral das suas atividades e da equipe.';

            // Calculate statistics based on user role
            const isTeacher = currentUserRole === 'teacher';
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'Ativo').length;
            const totalTurmas = turmas.length;
            const totalRevenue = students.reduce((sum, s) => sum + (parseFloat(s.amountReceived || s.amountPaid) || 0), 0);

            // Check if user can see financial information
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);

            contentArea.innerHTML = `
                <div id="inicio-section" class="space-y-6">
                    <!-- Welcome Header removed - now integrated in main header -->

                    <!-- Compact Statistics -->
                    <div class="grid ${
                        isTeacher ? 'grid-cols-2' : 
                        canViewFinancialInfo ? 'grid-cols-2 md:grid-cols-4' : 'grid-cols-2 md:grid-cols-3'
                    } gap-4">
                        ${!isTeacher ? `
                        <div class="base-card bg-gradient-to-r from-stone-50 to-stone-100 border-stone-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-stone-600">Total de Alunos</p>
                                    <p class="text-2xl font-bold text-stone-700 mt-1">${totalStudents}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-stone-200 rounded-full">
                                        <svg class="w-5 h-5 text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>` : ''}
                        <div class="base-card bg-gradient-to-r from-green-50 to-green-100 border-green-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-green-600">Alunos Ativos</p>
                                    <p class="text-2xl font-bold text-green-700 mt-1">${activeStudents}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-green-200 rounded-full">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="base-card bg-gradient-to-r from-purple-50 to-purple-100 border-purple-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-purple-600">Turmas</p>
                                    <p class="text-2xl font-bold text-purple-700 mt-1">${totalTurmas}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-purple-200 rounded-full">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${canViewFinancialInfo ? `
                        <div class="base-card bg-gradient-to-r from-blue-50 to-blue-100 border-blue-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-blue-600">Receita Total</p>
                                    <p class="text-2xl font-bold text-blue-700 mt-1">${formatCurrencyBR(totalRevenue)}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-blue-200 rounded-full">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Employee Highlight and Top 3 Dojo Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Fortune Cookie Section - Compact -->
                        <div class="bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-600">
                            <div class="mb-3">
                                <h4 class="text-base font-semibold text-white">🥠 Biscoito da Sorte</h4>
                            </div>
                            <div id="fortune-cookie-content" class="text-sm">
                                <!-- Fortune cookie content will be rendered here -->
                            </div>
                        </div>

                        <!-- Top 3 Dojo Section -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200">
                            <h4 class="text-base font-semibold text-stone-800 mb-3">Top 3 Dojo</h4>
                            <div class="space-y-2">
                                ${getTop3DojoRanking().map((item, index) => `
                                    <div class="flex items-center justify-between p-2 rounded-lg" style="background-color: ${
                                        index === 0 ? '#F1D24B20' : 
                                        index === 1 ? '#84C7DF20' : 
                                        '#FF5C3D20'
                                    }">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-lg font-bold" style="color: ${
                                                index === 0 ? '#F1D24B' : 
                                                index === 1 ? '#84C7DF' : 
                                                '#FF5C3D'
                                            }">${
                                                index === 0 ? 
                                                    `<svg class="inline-block w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="12" cy="8" r="6" fill="#FFD700" stroke="#DAA520" stroke-width="2"/>
                                                        <rect x="10" y="14" width="4" height="8" fill="#DAA520"/>
                                                        <text x="12" y="10" text-anchor="middle" fill="#DAA520" font-size="8" font-weight="bold">1</text>
                                                    </svg>` : 
                                                index === 1 ? 
                                                    `<svg class="inline-block w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="12" cy="8" r="6" fill="#C0C0C0" stroke="#A8A8A8" stroke-width="2"/>
                                                        <rect x="10" y="14" width="4" height="8" fill="#A8A8A8"/>
                                                        <text x="12" y="10" text-anchor="middle" fill="#666666" font-size="8" font-weight="bold">2</text>
                                                    </svg>` : 
                                                    `<svg class="inline-block w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="12" cy="8" r="6" fill="#CD7F32" stroke="#8B4513" stroke-width="2"/>
                                                        <rect x="10" y="14" width="4" height="8" fill="#8B4513"/>
                                                        <text x="12" y="10" text-anchor="middle" fill="#654321" font-size="8" font-weight="bold">3</text>
                                                    </svg>`
                                            }</span>
                                            <span class="font-medium text-stone-700">${item.name}</span>
                                        </div>
                                        <span class="text-sm font-semibold text-stone-700">${item.points || 0} pts</span>
                                    </div>
                                `).join('')}
                                ${getTop3DojoRanking().length === 0 ? '<p class="text-sm text-stone-500 text-center py-4">Ainda não há ranking</p>' : ''}
                            </div>
                        </div>
                    </div>



                    <!-- Teacher-specific Weekly Schedule Preview -->
                    ${isTeacher ? `
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-stone-800">Minha Grade da Semana</h3>
                            <button class="text-sm font-medium hover:underline nav-item" style="color: #F1D24B;" data-target="grade">Ver grade completa →</button>
                        </div>
                        <div class="grid grid-cols-5 gap-3">
                            ${["Segunda", "Terça", "Quarta", "Quinta", "Sexta"].map(day => `
                                <div class="text-center">
                                    <p class="text-sm font-semibold text-stone-700 mb-3">${day.substring(0, 3)}</p>
                                    <div class="space-y-2">
                                        ${getTeacherDaySchedule(day, currentUserName).slice(0, 2).map(schedule => `
                                            <div class="text-xs p-2 rounded-lg shadow-sm border" style="background-color: #F1D24B20; border-color: #F1D24B30; color: #8B6914;">
                                                <div class="font-medium">${schedule.startTime}</div>
                                                <div class="text-stone-600">${schedule.student}</div>
                                            </div>
                                        `).join('')}
                                        ${getTeacherDaySchedule(day, currentUserName).length > 2 ? `<div class="text-xs text-stone-500 font-medium">+${getTeacherDaySchedule(day, currentUserName).length - 2}</div>` : ''}
                                        ${getTeacherDaySchedule(day, currentUserName).length === 0 ? '<div class="text-xs text-stone-400 p-2 bg-stone-50 rounded-lg border border-stone-200">Livre</div>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}

                    <!-- Redes SLAP & Destaque do Mês -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Redes SLAP -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                            <h4 class="text-lg font-bold text-black mb-4">Redes SLAP</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <a href="https://instagram.com/speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors text-black" style="background-color: #F1D24B;">
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                                    </svg>
                                    <p class="text-xs font-medium">Instagram</p>
                                </a>
                                <a href="https://youtube.com/@speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors text-black" style="background-color: #F1D24B;">
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                    </svg>
                                    <p class="text-xs font-medium">YouTube</p>
                                </a>
                                <a href="https://tiktok.com/@speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors text-black" style="background-color: #F1D24B;">
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/>
                                    </svg>
                                    <p class="text-xs font-medium">TikTok</p>
                                </a>
                                <a href="https://linkedin.com/company/speaking-like-a-pro" target="_blank" class="p-3 rounded-lg text-center transition-colors text-black" style="background-color: #F1D24B;">
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                    </svg>
                                    <p class="text-xs font-medium">LinkedIn</p>
                                </a>
                            </div>
                        </div>

                        <!-- Destaque do Mês -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-bold text-stone-800">Destaque do Mês</h4>
                                ${currentUserRole === 'admin' ? `
                                    <button class="text-sm" style="color: #F1D24B;" data-action="edit-monthly-highlight">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                        Editar
                                    </button>
                                ` : ''}
                            </div>
                            <div id="monthly-highlight-content">
                                <!-- Monthly highlight content will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize monthly highlight and fortune cookie
            renderMonthlyHighlight();
            renderFortuneCookie();
        }

        // Monthly Highlight functions
        function renderMonthlyHighlight() {
            const content = document.getElementById('monthly-highlight-content');
            if (!content) return;

            content.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img src="${monthlyHighlight.photo}" alt="${monthlyHighlight.name}" class="w-16 h-16 rounded-full object-cover border-2 border-stone-200">
                    <div class="flex-1">
                        <h5 class="font-semibold text-stone-800 text-lg">${monthlyHighlight.name}</h5>
                        <p class="text-sm text-stone-600 mt-1 leading-relaxed">${monthlyHighlight.description}</p>
                        ${monthlyHighlight.award ? `<div class="mt-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: #F1D24B20; color: #B45309;">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            ${monthlyHighlight.award}
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        function openMonthlyHighlightForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = "Editar Destaque do Mês";
            
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="monthly-highlight-form" class="space-y-4">
                    <div>
                        <label class="font-medium text-sm">Nome do Funcionário</label>
                        <input type="text" id="highlight-name" class="form-input" required value="${monthlyHighlight.name}">
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Link da Foto (Cloudinary)</label>
                        <input type="url" id="highlight-photo" class="form-input" required value="${monthlyHighlight.photo}" placeholder="https://res.cloudinary.com/...">
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Descrição</label>
                        <textarea id="highlight-description" class="form-input" rows="4" required placeholder="Descreva os motivos do destaque...">${monthlyHighlight.description}</textarea>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Premiação (Opcional)</label>
                        <input type="text" id="highlight-award" class="form-input" value="${monthlyHighlight.award || ''}" placeholder="Ex: Voucher de R$ 200, Dia de folga, etc.">
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button type="button" data-action="close-modal" class="secondary-btn">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Salvar Destaque</button>
                    </div>
                </form>
            `;

            document.getElementById('monthly-highlight-form').onsubmit = saveMonthlyHighlight;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveMonthlyHighlight(event) {
            event.preventDefault();
            
            const data = {
                name: document.getElementById('highlight-name').value,
                photo: document.getElementById('highlight-photo').value,
                description: document.getElementById('highlight-description').value,
                award: document.getElementById('highlight-award').value
            };

            if (!data.name || !data.photo || !data.description) {
                showErrorMessage("Erro", "Todos os campos são obrigatórios.");
                return;
            }

            try {
                if (!db) {
                    // Development mode - update local variable only
                    console.log('Development mode: updating local monthly highlight');
                    monthlyHighlight = data;
                    renderMonthlyHighlight();
                    document.getElementById('form-modal').classList.remove('visible');
                    showSuccessMessage("Sucesso!", "Destaque do mês atualizado localmente (modo desenvolvimento).");
                    return;
                }

                console.log('Saving monthly highlight to Firebase:', data);
                const highlightRef = doc(db, `artifacts/${appId}/public/data/monthly-highlight`, 'current');
                
                // Add timestamp for better tracking
                const dataWithTimestamp = {
                    ...data,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUserName || 'Admin'
                };
                
                await setDoc(highlightRef, dataWithTimestamp);
                console.log('Monthly highlight saved successfully to Firebase');
                
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso!", "Destaque do mês atualizado para todos os usuários!");
                
                // Note: renderMonthlyHighlight will be called automatically by the onSnapshot listener
            } catch (error) {
                console.error("Error saving monthly highlight:", error);
                showErrorMessage("Erro", "Erro ao salvar destaque: " + error.message);
            }
        }













        // Dashboard helper functions
        function getPendingTasks() {
            return tasks.filter(task => !task.completed);
        }

        function getUpcomingEvents() {
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            return events.filter(event => {
                const eventDate = new Date(event.dataEvento + 'T00:00:00');
                return eventDate >= today && eventDate <= nextWeek;
            }).sort((a, b) => new Date(a.dataEvento) - new Date(b.dataEvento));
        }

        function getTeacherDaySchedule(day, teacherName) {
            const actualTeacherName = findTeacherByName(teacherName) || teacherName;
            return schedules.filter(s => s.day === day && s.teacher === actualTeacherName && s.type !== 'break')
                           .sort((a, b) => a.startTime.localeCompare(b.startTime));
        }

        function getNewStudentsThisMonth() {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return students.filter(student => {
                if (!student.createdAt) return false;
                const createdDate = new Date(student.createdAt);
                return createdDate >= firstDayOfMonth;
            }).length;
        }

        function getCancellationsThisMonth() {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return cancellations.filter(cancellation => {
                const cancellationDate = new Date(cancellation.cancellationDate + 'T00:00:00');
                return cancellationDate >= firstDayOfMonth;
            }).length;
        }

        function getCompletedTasksThisWeek() {
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            return tasks.filter(task => {
                if (!task.completed || !task.completedAt) return false;
                const completedDate = new Date(task.completedAt);
                return completedDate >= weekStart;
            }).length;
        }

        function getTotalTeachingHours() {
            return schedules.filter(s => s.type !== 'break').length;
        }

        function getTop3DojoRanking() {
            return dojoRanking.sort((a, b) => b.points - a.points).slice(0, 3);
        }

        function getCurrentMonthName() {
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return months[new Date().getMonth()];
        }

        function getCurrentDayName() {
            const days = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 
                         'Quinta-feira', 'Sexta-feira', 'Sábado'];
            return days[new Date().getDay()];
        }

        function initializeChart() {
            const ctx = document.getElementById('studentsChart');
            if (!ctx) return;

            const statusCounts = students.reduce((acc, student) => {
                const status = student.status || 'Pendente';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#10B981', // Green for Ativo
                            '#EF4444', // Red for Cancelado
                            '#F59E0B', // Yellow for Pendente
                            '#8B5CF6', // Purple for others
                            '#06B6D4'  // Cyan for others
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderAlunosSection() {
            document.getElementById('main-title').textContent = 'Gestão de Alunos';
            document.getElementById('main-description').textContent = 'Cadastre e gerencie todos os alunos da escola.';
            const canAdd = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);

            const totalCount = students.length;
            const activeCount = students.filter(s => s.status === 'Ativo').length;
            const cancelledCount = students.filter(s => s.status === 'Cancelado').length;
            const pendingCount = students.filter(s => s.status === 'Pendente').length;
            const totalRevenue = students.reduce((sum, student) => {
                return sum + parseFloat(student.amountReceived || student.amountPaid || 0);
            }, 0);

            contentArea.innerHTML = `
                <section id="alunos-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <div class="base-card bg-gradient-to-r from-stone-50 to-stone-100 border-stone-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-stone-600">Total de Alunos</p>
                                    <p class="text-2xl font-bold text-stone-700 mt-1">${totalCount}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-stone-200 rounded-full">
                                        <svg class="w-5 h-5 text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="base-card bg-gradient-to-r from-green-50 to-green-100 border-green-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-green-600">Alunos Ativos</p>
                                    <p class="text-2xl font-bold text-green-700 mt-1">${activeCount}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-green-200 rounded-full">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="base-card bg-gradient-to-r from-yellow-50 to-yellow-100 border-yellow-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-yellow-600">Alunos Pendentes</p>
                                    <p class="text-2xl font-bold text-yellow-700 mt-1">${pendingCount}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-yellow-200 rounded-full">
                                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="base-card bg-gradient-to-r from-red-50 to-red-100 border-red-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-red-600">Alunos Cancelados</p>
                                    <p class="text-2xl font-bold text-red-700 mt-1">${cancelledCount}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-red-200 rounded-full">
                                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${canViewFinancialInfo ? `
                        <div class="base-card bg-gradient-to-r from-blue-50 to-blue-100 border-blue-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-4">
                                    <p class="text-sm font-medium text-blue-600">Receita Total</p>
                                    <p class="text-2xl font-bold text-blue-700 mt-1">${formatCurrencyBR(totalRevenue)}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <div class="p-2 bg-blue-200 rounded-full">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    <div class="mb-6">
                        <input type="search" id="aluno-search" placeholder="Pesquisar por nome..." class="form-input w-full sm:w-1/2">
                    </div>

                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="flex gap-2" id="alunos-filter-buttons">
                            <button class="secondary-btn filter-btn active" data-filter="todos">Todos</button>
                            <button class="secondary-btn filter-btn" data-filter="ativo">Ativos</button>
                            <button class="secondary-btn filter-btn" data-filter="pendente">Pendentes</button>
                            <button class="secondary-btn filter-btn" data-filter="cancelado">Cancelados</button>
                        </div>
                        <div class="flex gap-2">
                            <button class="secondary-btn w-auto" data-action="export-alunos-doc">Exportar Documento</button>
                            ${canAdd ? `<button class="primary-btn w-auto" data-action="add-aluno">+ Adicionar Aluno</button>` : ''}
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table" id="alunos-table">
                            <thead>
                                <tr>
                                    <th>Nome do Aluno</th>
                                    <th>Status</th>
                                    ${canViewFinancialInfo ? '<th>Valor Pago</th>' : ''}
                                    ${canViewFinancialInfo ? '<th>Valor Recebido</th>' : '<th>Responsável</th>'}
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="alunos-list"></tbody>
                        </table>
                    </div>

                    <!-- Controles de Paginação -->
                    <div id="pagination-controls" class="flex justify-between items-center mt-6 pt-4 border-t border-stone-200">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-stone-600">Itens por página:</label>
                            <select id="items-per-page" class="form-input !py-1 !px-2 w-20">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>

                        <div id="pagination-info" class="text-sm text-stone-600"></div>

                        <div class="flex gap-1">
                            <button id="prev-page" class="secondary-btn !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <div id="page-numbers" class="flex gap-1"></div>
                            <button id="next-page" class="secondary-btn !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </section>
            `;

            const searchInput = document.getElementById('aluno-search');
            const filterButtons = document.querySelectorAll('#alunos-filter-buttons .filter-btn');

            const performUpdate = () => {
                const currentFilter = document.querySelector('#alunos-filter-buttons .filter-btn.active').dataset.filter;
                updateAlunosList(currentFilter);
            };

            searchInput.addEventListener('input', performUpdate);
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    performUpdate();
                });
            });

            // Configurar paginação
            const itemsPerPageSelect = document.getElementById('items-per-page');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');

            itemsPerPageSelect.addEventListener('change', () => {
                itemsPerPage = parseInt(itemsPerPageSelect.value);
                currentPage = 1;
                performUpdate();
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    performUpdate();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalItems = getFilteredStudents().length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    performUpdate();
                }
            });

            updateAlunosList('todos');
        }

        function getFilteredStudents() {
            const filter = document.querySelector('#alunos-filter-buttons .filter-btn.active')?.dataset.filter || 'todos';
            const searchTerm = document.getElementById('aluno-search')?.value.toLowerCase() || '';

            let filteredStudents = students;
            if (filter !== 'todos') {
                filteredStudents = students.filter(s => s.status && s.status.toLowerCase() === filter);
            }

            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchTerm));
            }

            return filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
        }

        function getFilteredTurmas() {
            const searchTerm = document.getElementById('turma-search')?.value.toLowerCase() || '';
            const teacherFilter = document.getElementById('turma-teacher-filter')?.value || '';
            let filteredTurmas = turmas;

            if (currentUserRole === 'teacher') {
                // Find the teacher's name in collaborators to ensure correct mapping
                const teacherCollaborator = collaborators.find(c => 
                    c.sectors && c.sectors.includes('professor') && 
                    (c.name === currentUserName || c.email === currentUserName || c.id === userId)
                );
                const originalTeacherName = teacherCollaborator ? teacherCollaborator.name : currentUserName;
                
                // Use smart name matching to find the actual teacher name in turmas
                const teacherNames = [...new Set(turmas.map(t => t.teacherName))];
                const exactMatch = teacherNames.find(name => name === originalTeacherName);
                let teacherNameToFilter = exactMatch;
                
                if (!exactMatch && originalTeacherName) {
                    // Try first name matching
                    const searchFirstName = originalTeacherName.trim().split(' ')[0].toLowerCase();
                    const firstNameMatch = teacherNames.find(name => {
                        const nameFirstName = name.trim().split(' ')[0].toLowerCase();
                        return nameFirstName === searchFirstName;
                    });
                    teacherNameToFilter = firstNameMatch;
                }
                
                teacherNameToFilter = teacherNameToFilter || originalTeacherName;
                // For teachers, only show turmas assigned to them
                filteredTurmas = turmas.filter(t => t.teacherName === teacherNameToFilter);
            } else if (teacherFilter) {
                // Apply teacher filter for non-teacher users
                filteredTurmas = turmas.filter(t => t.teacherName === teacherFilter);
            }

            if (searchTerm) {
                filteredTurmas = filteredTurmas.filter(t => 
                    t.name.toLowerCase().includes(searchTerm) ||
                    t.teacherName.toLowerCase().includes(searchTerm) ||
                    t.level.toLowerCase().includes(searchTerm)
                );
            }

            return filteredTurmas.sort((a, b) => a.name.localeCompare(b.name));
        }

        function getFilteredVips() {
            const searchTerm = document.getElementById('vip-search')?.value.toLowerCase() || '';
            const teacherFilter = document.getElementById('vip-teacher-filter')?.value || '';
            const statusFilter = document.querySelector('#vips-filter-buttons .filter-btn.active')?.dataset.filter || 'todos';
            
            // Only show students who have actual VIP records, not just VIP modality
            const vipStudents = students.filter(s => {
                const hasVipRecord = vips.find(v => v.studentId === s.id);
                return s.modalidade === 'VIP' && hasVipRecord;
            });
            let filteredVips = vipStudents;

            // Apply role-based filtering first
            if (currentUserRole === 'teacher') {
                // Find the teacher's name in collaborators to ensure correct mapping
                const teacherCollaborator = collaborators.find(c => 
                    c.sectors && c.sectors.includes('professor') && 
                    (c.name === currentUserName || c.email === currentUserName || c.id === userId)
                );
                const originalTeacherName = teacherCollaborator ? teacherCollaborator.name : currentUserName;
                
                // Use smart name matching to find the actual teacher name in VIPs
                const teacherNames = [...new Set(vips.map(v => v.teacherName).filter(name => name))];
                const exactMatch = teacherNames.find(name => name === originalTeacherName);
                let teacherNameToFilter = exactMatch;
                
                if (!exactMatch && originalTeacherName) {
                    // Try first name matching
                    const searchFirstName = originalTeacherName.trim().split(' ')[0].toLowerCase();
                    const firstNameMatch = teacherNames.find(name => {
                        const nameFirstName = name.trim().split(' ')[0].toLowerCase();
                        return nameFirstName === searchFirstName;
                    });
                    teacherNameToFilter = firstNameMatch;
                }
                
                teacherNameToFilter = teacherNameToFilter || originalTeacherName;
                
                // For teachers, only show VIPs assigned to them
                filteredVips = vipStudents.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    return vipRecord && vipRecord.teacherName === teacherNameToFilter;
                });
            } else if (teacherFilter) {
                // Apply teacher filter for non-teacher users
                filteredVips = vipStudents.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    return vipRecord && vipRecord.teacherName === teacherFilter;
                });
            }

            // Apply status filter for "A Finalizar" - VIPs with 30 days or less to end
            if (statusFilter === 'a-finalizar') {
                const today = new Date();
                const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                
                filteredVips = filteredVips.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    if (!vipRecord || !vipRecord.endDate) return false;
                    
                    const endDate = new Date(vipRecord.endDate);
                    return endDate <= thirtyDaysFromNow && endDate >= today;
                });
            }
            
            // Apply status filter for "Expirados" - VIPs with contracts that have passed the end date
            if (statusFilter === 'expirados') {
                const today = new Date();
                
                filteredVips = filteredVips.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    if (!vipRecord || !vipRecord.endDate) return false;
                    
                    const endDate = new Date(vipRecord.endDate);
                    return endDate < today;
                });
            }

            if (searchTerm) {
                filteredVips = filteredVips.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    const teacher = vipRecord ? collaborators.find(c => c.id === vipRecord.teacherId) : null;
                    return student.name.toLowerCase().includes(searchTerm) ||
                           (teacher && teacher.name.toLowerCase().includes(searchTerm)) ||
                           (vipRecord && vipRecord.level && vipRecord.level.toLowerCase().includes(searchTerm));
                });
            }

            return filteredVips.sort((a, b) => a.name.localeCompare(b.name));
        }

        function updateTurmasList() {
            const filteredTurmas = getFilteredTurmas();
            const turmasGrid = document.getElementById('turmas-grid');
            
            if (!turmasGrid) return;

            turmasGrid.innerHTML = filteredTurmas.map(t => {
                // Count TURMA and DUPLA modality students in the class
                const turmaStudents = students.filter(s => 
                    (t.studentIds || []).includes(s.id) && (s.modalidade === 'TURMA' || s.modalidade === 'DUPLA')
                );
                // Separate students by modality
                const turmaOnlyStudents = turmaStudents.filter(s => s.modalidade === 'TURMA');
                const duplaStudents = turmaStudents.filter(s => s.modalidade === 'DUPLA');
                
                const canManage = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);
                return `
                <div class="base-card flex flex-col">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-stone-800">${t.name}</h3>
                            <span class="text-sm font-semibold text-stone-600">${turmaStudents.length} aluno(s)</span>
                        </div>
                        <p class="text-sm text-stone-500 mb-2">Professor: ${t.teacherName}</p>
                        <p class="text-sm text-stone-600"><strong>Nível:</strong> ${t.level}</p>
                        <p class="text-sm text-stone-600"><strong>Semestre:</strong> ${t.semestre || 'N/A'}</p>
                        
                        ${turmaStudents.length > 0 ? `
                        <div class="mt-3 pt-3 border-t border-stone-100">
                            <p class="text-xs font-medium text-stone-500 mb-2">Alunos:</p>
                            <div class="space-y-1">
                                ${turmaOnlyStudents.map(s => `
                                    <div class="text-xs text-stone-700">${s.name}</div>
                                `).join('')}
                                ${duplaStudents.map(s => `
                                    <div class="flex items-center justify-between text-xs">
                                        <span class="text-stone-700">${s.name}</span>
                                        <span class="status-tag status-dupla !text-xs !py-1 !px-2">DUPLA</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="mt-auto pt-4 border-t border-stone-100 flex gap-2">
                        ${canManage ? `<button class="secondary-btn !text-sm flex-1" data-action="edit-turma" data-id="${t.id}">Editar</button>` : ''}
                        <button class="primary-btn !text-sm flex-1 flex items-center justify-center" data-action="open-turma-pef" data-id="${t.id}">PEF</button>
                        <button class="secondary-btn !text-sm flex-1 flex items-center justify-center" data-action="open-turma-notas" data-id="${t.id}">Notas</button>
                    </div>
                </div>`}).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhuma turma encontrada.</p>';
        }

        // Function to calculate VIP status tags based on contract dates
        function getVipStatusTag(vipRecord) {
            if (!vipRecord || !vipRecord.endDate) return '';
            
            const today = new Date();
            const endDate = new Date(vipRecord.endDate);
            const diffTime = endDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                // Contract expired
                const expiredDays = Math.abs(diffDays);
                return `<div class="mt-2"><span class="status-tag" style="background-color: #FEE2E2; color: #991B1B; font-weight: 600;">Contrato expirado há ${expiredDays} dia${expiredDays !== 1 ? 's' : ''}</span></div>`;
            } else if (diffDays <= 30) {
                // Contract ending within 30 days
                return `<div class="mt-2"><span class="status-tag" style="background-color: #FEF3C7; color: #92400E; font-weight: 600;">${diffDays} dia${diffDays !== 1 ? 's' : ''} para finalizar</span></div>`;
            }
            
            return '';
        }

        let currentVipPage = 1;
        let vipsPerPage = 6;

        function updateVipsList() {
            const allFilteredVips = getFilteredVips();
            const vipsGrid = document.getElementById('vips-grid');
            
            if (!vipsGrid) return;

            // Pagination logic
            const totalVips = allFilteredVips.length;
            const totalPages = Math.ceil(totalVips / vipsPerPage);
            
            // Reset to page 1 if current page is beyond total pages
            if (currentVipPage > totalPages && totalPages > 0) {
                currentVipPage = 1;
            }
            
            // Calculate pagination
            const startIndex = (currentVipPage - 1) * vipsPerPage;
            const endIndex = startIndex + vipsPerPage;
            const paginatedVips = allFilteredVips.slice(startIndex, endIndex);

            vipsGrid.innerHTML = paginatedVips.map(student => {
                const vipRecord = vips.find(v => v.studentId === student.id);
                const teacher = vipRecord ? collaborators.find(c => c.id === vipRecord.teacherId) : null;
                const canManage = ['admin', 'pedagogico', 'ap', 'financeiro', 'teacher'].includes(currentUserRole);
                
                // Can show PEF if user is admin/pedagogico/ap/financeiro OR if user is the assigned teacher
                const canShowPef = ['admin', 'pedagogico', 'ap', 'financeiro'].includes(currentUserRole) || 
                    (currentUserRole === 'teacher' && vipRecord && vipRecord.teacherName === currentUserName);
                
                // Get status tag for contract expiration/ending
                const statusTag = getVipStatusTag(vipRecord);
                
                return `
                <div class="base-card flex flex-col">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-xl font-bold text-stone-800">${student.name}</h3>
                            </div>
                        </div>
                        <p class="text-sm text-stone-600 mb-2"><strong>Status:</strong> <span class="status-tag status-${(student.status || 'pendente').toLowerCase()}">${student.status || 'Pendente'}</span></p>
                        ${vipRecord ? `<p class="text-sm text-stone-500 mb-2">Professor: ${teacher?.name || 'N/A'}</p>` : ''}
                        ${vipRecord ? `<p class="text-sm text-stone-600"><strong>Nível:</strong> ${vipRecord.level || 'N/A'}</p>` : ''}
                        ${vipRecord && vipRecord.endDate ? `<p class="text-sm text-stone-600"><strong>Finaliza em:</strong> ${formatDateBR(vipRecord.endDate)}</p>` : ''}
                        ${student.indicacao ? `<p class="text-sm text-stone-600"><strong>Indicação:</strong> ${student.indicacao}</p>` : ''}
                        ${vipRecord && vipRecord.observacoes ? `
                            <div class="mt-3 pt-2 border-t border-stone-100">
                                <p class="text-sm text-stone-600"><strong>Observações:</strong></p>
                                <p class="text-sm text-stone-500 mt-1 italic">${vipRecord.observacoes}</p>
                            </div>
                        ` : ''}
                        ${statusTag}
                    </div>
                    <div class="mt-auto pt-4 border-t border-stone-100 flex gap-2">
                        ${vipRecord ? `
                            <button class="primary-btn !text-sm flex-1 flex items-center justify-center" data-action="open-vip-pef" data-id="${vipRecord.id}">PEF</button>
                            <button class="secondary-btn !text-sm flex-1 flex items-center justify-center" data-action="open-vip-notas" data-id="${vipRecord.id}">Notas</button>
                            ${currentUserRole !== 'teacher' ? `<button class="secondary-btn !text-sm flex-1" data-action="edit-vip" data-id="${vipRecord.id}">Configurar</button>` : ''}
                        ` : ''}
                    </div>
                </div>`}).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhum aluno VIP encontrado.</p>';
            
            // Update pagination controls
            updateVipsPaginationControls(totalVips, totalPages, startIndex, endIndex);
        }

        function updateAlunosList(filter) {
            const listBody = document.getElementById('alunos-list');
            if (!listBody) return;
            const canEdit = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);

            const filteredStudents = getFilteredStudents();
            const totalItems = filteredStudents.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Reset to page 1 if current page is beyond total pages
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = 1;
            }

            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedStudents = filteredStudents.slice(startIndex, endIndex);

            if (filteredStudents.length === 0) {
                const colspanCount = canViewFinancialInfo ? 5 : 4;
                listBody.innerHTML = `<tr><td colspan="${colspanCount}" class="text-center py-10 text-stone-500">Nenhum aluno encontrado.</td></tr>`;
                updatePaginationControls(0, 0, 0);
                return;
            }

            listBody.innerHTML = paginatedStudents.map(student => {
                const vipRecord = student.modalidade === 'VIP' ? vips.find(v => v.studentId === student.id) : null;
                return `
                <tr data-action="view-aluno" data-id="${student.id}" class="cursor-pointer">
                    <td class="font-medium">
                        <div class="flex flex-col">
                            <div>${student.name}</div>
                            <div class="mt-1">
                                <span class="status-tag status-${(student.modalidade || 'turma').toLowerCase()} text-xs">${student.modalidade || 'TURMA'}</span>
                                ${student.indicacao ? `<span class="ml-2 text-xs text-stone-500">• ${student.indicacao}</span>` : ''}
                            </div>
                        </div>
                    </td>
                    <td><span class="status-tag status-${(student.status || 'pendente').toLowerCase()}">${student.status || 'Pendente'}</span></td>
                    ${canViewFinancialInfo ? `<td class="font-mono">R$ ${parseFloat(student.amountPaid || 0).toFixed(2)}</td>` : ''}
                    ${canViewFinancialInfo ? `<td class="font-mono">R$ ${parseFloat(student.amountReceived || student.amountPaid || 0).toFixed(2)}</td>` : `<td>${student.responsibleName || 'N/A'}</td>`}
                    <td class="text-center">
                        <div class="flex gap-1 justify-center">
                            ${canEdit ? `<button class="secondary-btn" data-action="edit-aluno" data-id="${student.id}" onclick="event.stopPropagation()">Editar</button>` : `<button class="secondary-btn" data-action="view-aluno" data-id="${student.id}" onclick="event.stopPropagation()">Ver</button>`}
                            ${vipRecord && canEdit ? `<button class="secondary-btn text-xs px-2 py-1" data-action="edit-vip" data-id="${vipRecord.id}" onclick="event.stopPropagation()" title="Editar VIP">✏️</button>` : ''}
                        </div>
                    </td>
                </tr>
                `;
            }).join('');

            updatePaginationControls(totalItems, totalPages, startIndex + 1, Math.min(endIndex, totalItems));
        }

        function updatePaginationControls(totalItems, totalPages, startItem, endItem) {
            const paginationInfo = document.getElementById('pagination-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');

            if (totalItems === 0) {
                paginationInfo.textContent = 'Nenhum item encontrado';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                pageNumbers.innerHTML = '';
                return;
            }

            paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${totalItems} alunos`;

            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;

            // Generate page numbers
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                pageNumbersHTML += `
                    <button class="page-number-btn ${isActive ? 'active' : ''}" data-page="${i}">
                        ${i}
                    </button>
                `;
            }

            pageNumbers.innerHTML = pageNumbersHTML;

            // Add click events to page number buttons
            document.querySelectorAll('.page-number-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentPage = parseInt(btn.dataset.page);
                    const filter = document.querySelector('#alunos-filter-buttons .filter-btn.active').dataset.filter;
                    updateAlunosList(filter);
                });
            });
        }

        // Reset pagination when switching sections
        function resetPagination() {
            currentPage = 1;
        }

        function renderTurmasSection() {
            document.getElementById('main-title').textContent = 'Gestão de Turmas';
            document.getElementById('main-description').textContent = 'Crie turmas, adicione alunos e registre as presenças.';

            const canManage = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);
            let itemsToDisplay = getFilteredTurmas();


            contentArea.innerHTML = `
                <div id="turmas-section">
                    <div class="flex justify-between items-center mb-6 gap-4">
                        <div class="flex gap-4 flex-1">
                            <div class="flex-1 max-w-md">
                                <input type="text" id="turma-search" placeholder="🔍 Pesquisar turmas..." class="form-input" oninput="updateTurmasList()">
                            </div>
                            ${currentUserRole !== 'teacher' ? `
                            <div class="min-w-48">
                                <select id="turma-teacher-filter" class="form-input" onchange="updateTurmasList()">
                                    <option value="">Todos os professores</option>
                                    ${[...new Set(turmas.map(t => t.teacherName))].sort().map(teacher => 
                                        `<option value="${teacher}">${teacher}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            ${canManage ? `<button class="primary-btn w-auto" data-action="add-turma">+ Adicionar Turma</button>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="turmas-grid">
                        ${itemsToDisplay.map(t => {
                            // Count TURMA and DUPLA modality students in the class
                            const turmaStudents = students.filter(s => 
                                (t.studentIds || []).includes(s.id) && (s.modalidade === 'TURMA' || s.modalidade === 'DUPLA')
                            );
                            // Separate students by modality
                            const turmaOnlyStudents = turmaStudents.filter(s => s.modalidade === 'TURMA');
                            const duplaStudents = turmaStudents.filter(s => s.modalidade === 'DUPLA');
                            
                            return `
                        <div class="base-card flex flex-col">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-xl font-bold text-stone-800">${t.name}</h3>
                                    <span class="text-sm font-semibold text-stone-600">${turmaStudents.length} aluno(s)</span>
                                </div>
                                <p class="text-sm text-stone-500 mb-2">Professor: ${t.teacherName}</p>
                                <p class="text-sm text-stone-600"><strong>Nível:</strong> ${t.level}</p>
                                <p class="text-sm text-stone-600"><strong>Semestre:</strong> ${t.semestre || 'N/A'}</p>
                                
                                ${turmaStudents.length > 0 ? `
                                <div class="mt-3 pt-3 border-t border-stone-100">
                                    <p class="text-xs font-medium text-stone-500 mb-2">Alunos:</p>
                                    <div class="space-y-1">
                                        ${turmaOnlyStudents.map(s => `
                                            <div class="text-xs text-stone-700">${s.name}</div>
                                        `).join('')}
                                        ${duplaStudents.map(s => `
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="text-stone-700">${s.name}</span>
                                                <span class="status-tag status-dupla !text-xs !py-1 !px-2">DUPLA</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="mt-auto pt-4 border-t border-stone-100 flex gap-2">
                                ${canManage ? `<button class="secondary-btn !text-sm flex-1" data-action="edit-turma" data-id="${t.id}">Editar</button>` : ''}
                                <button class="primary-btn !text-sm flex-1 flex items-center justify-center" data-action="open-turma-pef" data-id="${t.id}">PEF</button>
                                <button class="secondary-btn !text-sm flex-1 flex items-center justify-center" data-action="open-turma-notas" data-id="${t.id}">Notas</button>
                            </div>
                        </div>`}).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhuma turma encontrada.</p>'}
                    </div>
                </div>`;
        }

        function renderVipsSection() {
            document.getElementById('main-title').textContent = 'Alunos VIP';
            document.getElementById('main-description').textContent = 'Gerencie alunos VIP e registre suas presenças.';

            const canManage = ['admin', 'pedagogico', 'ap', 'financeiro'].includes(currentUserRole);
            
            let itemsToDisplay = getFilteredVips();
            


            contentArea.innerHTML = `
                <div id="vips-section">
                    <div class="flex justify-between items-center mb-6 gap-4">
                        <div class="flex gap-4 flex-1">
                            <div class="flex-1 max-w-md">
                                <input type="text" id="vip-search" placeholder="🔍 Pesquisar VIPs..." class="form-input" oninput="updateVipsList()">
                            </div>
                            ${currentUserRole !== 'teacher' ? `
                            <div class="min-w-48">
                                <select id="vip-teacher-filter" class="form-input" onchange="updateVipsList()">
                                    <option value="">Todos os professores</option>
                                    ${[...new Set(vips.map(v => v.teacherName).filter(name => name))].sort().map(teacher => 
                                        `<option value="${teacher}">${teacher}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            ${canManage ? `<button class="primary-btn w-auto" data-action="add-vip">+ Adicionar VIP</button>` : ''}
                        </div>
                    </div>

                    ${canManage || currentUserRole === 'teacher' ? `
                    <div class="flex gap-2 mb-6" id="vips-filter-buttons">
                        <button class="secondary-btn filter-btn active" data-filter="todos">Todos</button>
                        <button class="secondary-btn filter-btn" data-filter="a-finalizar">A Finalizar</button>
                        <button class="secondary-btn filter-btn" data-filter="expirados">Expirados</button>
                    </div>
                    ` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="vips-grid">
                        <!-- Content will be populated by updateVipsList() -->
                    </div>
                    
                    <!-- VIPs Pagination -->
                    <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4" id="vips-pagination">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-stone-600">VIPs por página:</label>
                            <select id="vips-per-page" class="form-input !py-1 !px-2 text-sm w-auto">
                                <option value="6">6</option>
                                <option value="12">12</option>
                                <option value="24">24</option>
                                <option value="48">48</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-stone-600" id="vips-info">Mostrando 0 de 0</span>
                            <div class="flex items-center gap-2">
                                <button id="vips-prev-page" class="pagination-btn" disabled>Anterior</button>
                                <div class="flex gap-1" id="vips-page-numbers"></div>
                                <button id="vips-next-page" class="pagination-btn" disabled>Próximo</button>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Add event listeners for filter buttons
            if (canManage || currentUserRole === 'teacher') {
                const filterButtons = document.querySelectorAll('#vips-filter-buttons .filter-btn');
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        filterButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        updateVipsList();
                    });
                });
            }

            // Set up VIPs pagination controls
            const vipsPerPageSelect = document.getElementById('vips-per-page');
            const vipsPrevPageBtn = document.getElementById('vips-prev-page');
            const vipsNextPageBtn = document.getElementById('vips-next-page');

            if (vipsPerPageSelect) {
                vipsPerPageSelect.addEventListener('change', () => {
                    vipsPerPage = parseInt(vipsPerPageSelect.value);
                    currentVipPage = 1;
                    updateVipsList();
                });
            }

            if (vipsPrevPageBtn) {
                vipsPrevPageBtn.addEventListener('click', () => {
                    if (currentVipPage > 1) {
                        currentVipPage--;
                        updateVipsList();
                    }
                });
            }

            if (vipsNextPageBtn) {
                vipsNextPageBtn.addEventListener('click', () => {
                    const totalVips = getFilteredVips().length;
                    const totalPages = Math.ceil(totalVips / vipsPerPage);
                    if (currentVipPage < totalPages) {
                        currentVipPage++;
                        updateVipsList();
                    }
                });
            }

            // Initial population of VIPs list
            updateVipsList();
        }

        function updateVipsPaginationControls(totalItems, totalPages, startIndex, endIndex) {
            const vipsInfo = document.getElementById('vips-info');
            const vipsPrevPageBtn = document.getElementById('vips-prev-page');
            const vipsNextPageBtn = document.getElementById('vips-next-page');
            const vipsPageNumbers = document.getElementById('vips-page-numbers');

            if (!vipsInfo || !vipsPrevPageBtn || !vipsNextPageBtn || !vipsPageNumbers) return;

            // Update info text
            const showingEnd = Math.min(endIndex, totalItems);
            vipsInfo.textContent = totalItems > 0 ? 
                `Mostrando ${startIndex + 1}-${showingEnd} de ${totalItems}` : 
                'Mostrando 0 de 0';

            // Update buttons
            vipsPrevPageBtn.disabled = currentVipPage <= 1;
            vipsNextPageBtn.disabled = currentVipPage >= totalPages;

            // Generate page numbers
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentVipPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentVipPage;
                pageNumbersHTML += `
                    <button class="page-number-btn ${isActive ? 'active' : ''}" data-vip-page="${i}">
                        ${i}
                    </button>
                `;
            }

            vipsPageNumbers.innerHTML = pageNumbersHTML;

            // Add click events to VIPs page number buttons
            document.querySelectorAll('[data-vip-page]').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentVipPage = parseInt(btn.dataset.vipPage);
                    updateVipsList();
                });
            });
        }

        async function renderCampanhasSection() {
            document.getElementById('main-title').textContent = 'Gestor de Campanhas';
            document.getElementById('main-description').textContent = 'Planeje e gerencie todas as campanhas de marketing da marca.';
            
            // Load campanhas from Firebase if not in development mode
            if (!window.isDevelopmentMode) {
                await loadCampanhas();
            }
            
            contentArea.innerHTML = `
                <div id="campanhas-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-campanha">+ Adicionar Campanha</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${events.map(c => `
                        <div class="base-card ${c.finalizada ? 'bg-gray-100 opacity-75' : 'bg-white hover:bg-yellow-50'} border-l-yellow-400 border-l-4 shadow-md hover:shadow-lg transition-all duration-200" data-action="view-campanha" data-id="${c.id}">
                            <div class="mb-3">
                                <h3 class="text-xl font-bold ${c.finalizada ? 'text-gray-600 line-through' : 'text-stone-800'} leading-tight">${c.nome || c.title}</h3>
                            </div>
                            <div class="space-y-2 mb-3">
                                ${c.setores && c.setores.length > 0 ? `<div class="flex flex-wrap gap-1">${c.setores.map(setor => `<span class="status-tag status-${setor.toLowerCase()} text-xs ${c.finalizada ? 'opacity-60' : ''}">${setor}</span>`).join('')}</div>` : ''}
                                <p class="text-sm ${c.finalizada ? 'text-gray-500' : 'text-stone-500'}"><strong>Responsável:</strong> ${c.responsavel || 'N/A'}</p>
                                <p class="text-sm ${c.finalizada ? 'text-gray-500' : 'text-stone-600'}"><strong>Plataforma:</strong> ${c.plataforma && c.plataforma.length > 0 ? c.plataforma.join(', ') : (c.foco && c.foco.length > 0 ? c.foco.join(', ') : 'N/A')}</p>
                                <p class="text-sm ${c.finalizada ? 'text-gray-500' : 'text-stone-600'}"><strong>Foco:</strong> ${c.focoObjetivo && c.focoObjetivo.length > 0 ? c.focoObjetivo.join(', ') : 'N/A'}</p>
                            </div>
                            <div class="space-y-1">
                                ${c.referencia1 || c.referencia2 ? `<p class="text-sm ${c.finalizada ? 'text-gray-500' : 'text-stone-600'}"><strong>Referências:</strong> ${[c.referencia1, c.referencia2].filter(Boolean).length} link(s)</p>` : ''}
                                ${c.local ? `<p class="text-sm ${c.finalizada ? 'text-gray-500' : 'text-stone-600'}"><strong>Local:</strong> ${c.local}</p>` : ''}
                                ${c.horario ? `<p class="text-sm ${c.finalizada ? 'text-gray-500' : 'text-stone-600'}"><strong>Horário:</strong> ${c.horario}</p>` : ''}
                            </div>
                            <div class="flex items-center justify-between mt-3 pt-2 border-t">
                                <div class="flex items-center">
                                    <input type="checkbox" id="finalizada-${c.id}" ${c.finalizada ? 'checked' : ''} 
                                           class="h-4 w-4 rounded finalizada-checkbox" 
                                           data-campanha-id="${c.id}"
                                           onchange="event.stopPropagation(); console.log('Checkbox changed for campaign:', '${c.id}', this.checked); toggleCampanhaFinalizada('${c.id}', this.checked);">
                                    <label for="finalizada-${c.id}" class="ml-2 text-sm text-stone-600 cursor-pointer">
                                        ${c.finalizada ? 'Finalizada' : 'Marcar como finalizada'}
                                    </label>
                                </div>
                                ${c.finalizada ? `<span class="text-xs text-green-600 font-medium">✓ Finalizada</span>` : ''}
                            </div>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhuma campanha encontrada.</p>'}
                    </div>
                </div>`;
        }



        function renderTarefasSection() { 
            document.getElementById('main-title').textContent = 'Lista de Tarefas'; 
            document.getElementById('main-description').textContent = 'Gerencie e acompanhe as tarefas da equipe.'; 

            const isAdmin = currentUserRole === 'admin';
            let filterHtml = '';

            if (isAdmin) {
                // Admin vê todos os filtros incluindo colaboradores
                const collaboratorOptions = collaborators.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                filterHtml = `
                    <div class="grade-select-container flex-grow">
                        <label for="task-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por colaborador:</label>
                        <select id="task-filter" class="grade-select">
                            <option value="all">Todos</option>
                            ${collaboratorOptions}
                        </select>
                    </div>
                `;
            } else {
                // Usuários não-admin veem apenas abas para suas tarefas e delegadas por eles
                filterHtml = `
                    <div class="flex gap-2 mb-4">
                        <button id="tab-minhas-tarefas" class="tab-btn active" onclick="switchTaskTab('minhas')">Minhas Tarefas</button>
                        <button id="tab-delegadas-por-mim" class="tab-btn" onclick="switchTaskTab('delegadas')">Delegadas por Mim</button>
                    </div>
                `;
            }

            contentArea.innerHTML = `
                <div id="tasks-section">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        ${filterHtml}
                        <div class="flex gap-2">
                            <button class="primary-btn w-auto" data-action="add-task">+ Adicionar Tarefa</button>
                        </div>
                    </div>
                    <div id="task-list-container" class="space-y-4"></div>
                </div>`; 
            
            if (isAdmin) {
                document.getElementById('task-filter').addEventListener('change', () => updateTaskList());
            }
            updateTaskList(); 
        }

        let currentTaskTab = 'minhas'; // Para usuários não-admin

        function switchTaskTab(tabType) {
            currentTaskTab = tabType;
            // Update tab visual state
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const targetTab = document.getElementById(`tab-${tabType === 'minhas' ? 'minhas-tarefas' : 'delegadas-por-mim'}`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            updateTaskList();
        }

        function updateTaskList() { 
            const container = document.getElementById('task-list-container'); 
            if (!container) return; 

            const isAdmin = currentUserRole === 'admin';
            let filteredTasks = [...tasks];

            if (isAdmin) {
                // Admin vê filtro por colaborador
                const filterValue = document.getElementById('task-filter')?.value || 'all';
                if (filterValue !== 'all') {
                    filteredTasks = tasks.filter(task => task.assignedTo && task.assignedTo.includes(filterValue));
                }
            } else {
                // Usuários não-admin veem suas tarefas ou delegadas por eles
                if (currentTaskTab === 'minhas') {
                    // Tarefas atribuídas para o usuário atual
                    filteredTasks = tasks.filter(task => 
                        task.assignedTo && task.assignedTo.includes(currentUserName)
                    );
                } else {
                    // Tarefas delegadas pelo usuário atual
                    filteredTasks = tasks.filter(task => 
                        task.assignedBy === currentUserName
                    );
                }
            }

            filteredTasks.sort((a, b) => a.completed - b.completed || new Date(a.deadline) - new Date(b.deadline)); 
            
            if (filteredTasks.length === 0) { 
                let message;
                if (isAdmin) {
                    message = 'Nenhuma tarefa encontrada para este filtro.';
                } else if (currentTaskTab === 'minhas') {
                    message = 'Você não tem tarefas atribuídas no momento.';
                } else {
                    message = 'Você não delegou nenhuma tarefa ainda.<br><br>Clique em "+ Adicionar Tarefa" para delegar uma nova tarefa para sua equipe.';
                }
                container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg"><p class="text-stone-500">${message}</p></div>`; 
                return; 
            } 
            
            container.innerHTML = filteredTasks.map(task => { 
                const deadlineDate = new Date(task.deadline + 'T00:00:00'); 
                const isOverdue = !task.completed && deadlineDate < new Date(); 
                const deadlineClass = isOverdue ? 'deadline-overdue' : ''; 
                const formattedDate = formatDateBR(task.deadline); 
                const priorityTagsMap = {
                    'urgente': { 
                        text: 'Urgente', 
                        class: 'bg-red-100 text-red-800',
                        icon: '<svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L13.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L10.91 8.26L12 2Z"/></svg>'
                    },
                    'prioridade': { 
                        text: 'Prioridade', 
                        class: 'bg-yellow-100 text-yellow-800',
                        icon: '<svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>'
                    },
                    'curto-prazo': { 
                        text: 'Curto Prazo', 
                        class: 'bg-orange-100 text-orange-800',
                        icon: '<svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20M12.5 7H11V13L16.25 16.15L17 14.92L12.5 12.25V7Z"/></svg>'
                    },
                    'longo-prazo': { 
                        text: 'Longo Prazo', 
                        class: 'bg-blue-100 text-blue-800',
                        icon: '<svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H18V1H16V3H8V1H6V3H5C3.89 3 3.01 3.9 3.01 5L3 19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M19 19H5V8H19V19Z"/></svg>'
                    },
                    'importante': { 
                        text: 'Importante', 
                        class: 'bg-purple-100 text-purple-800',
                        icon: '<svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L13.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L10.91 8.26L12 2Z"/></svg>'
                    },
                    'rotina': { 
                        text: 'Rotina', 
                        class: 'bg-gray-100 text-gray-800',
                        icon: '<svg class="w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/></svg>'
                    }
                };
                const priorityTag = task.priority && priorityTagsMap[task.priority] ? 
                    `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${priorityTagsMap[task.priority].class}">${priorityTagsMap[task.priority].icon}${priorityTagsMap[task.priority].text}</span>` : '';
                
                const canEdit = currentUserRole === 'admin' || task.assignedBy === currentUserName;
                return `<div class="task-card flex items-start gap-4 ${task.completed ? 'completed' : ''}" data-action="view-task" data-id="${task.id}"><input type="checkbox" data-action="toggle-task" data-id="${task.id}" class="mt-1.5 h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${task.completed ? 'checked' : ''} onclick="event.stopPropagation()"><div class="flex-1 cursor-pointer"><div class="flex items-start justify-between mb-1"><h4 class="text-stone-800 font-semibold">${task.title || 'Sem título'}</h4>${priorityTag}</div><p class="text-stone-600 text-sm mb-2">${task.description}</p><div class="flex flex-wrap justify-between items-center gap-4"><div class="flex items-center gap-2 flex-wrap"><span class="text-xs text-stone-500">Para:</span>${(task.assignedTo || []).map(name => `<span class="user-tag" style="background-color: #e5e7eb; color: #374151;">${name}</span>`).join('')}${task.assignedBy ? `<span class="text-xs text-stone-500 ml-3">Adicionado por:</span><span class="user-tag" style="background-color: #F1D24B; color: #44403c;">${task.assignedBy}</span>` : ''}</div><div class="text-right"><span class="text-xs text-stone-500">Prazo</span><p class="deadline-text ${deadlineClass}">${formattedDate}</p></div></div></div><div class="flex gap-1">${canEdit ? `<button class="text-stone-400 hover:text-stone-600" data-action="edit-task" data-id="${task.id}" onclick="event.stopPropagation()" title="Editar tarefa"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg></button>` : ''}<button class="task-delete-btn" data-action="delete-item" data-collection="tasks" data-id="${task.id}" onclick="event.stopPropagation()" title="Excluir tarefa"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></div>`; 
            }).join(''); 
        }

        function renderGradeSection() {
            document.getElementById('main-title').textContent = 'Grade de Horários';
            document.getElementById('main-description').textContent = 'Visualize e gerencie a grade de aulas da equipe.';

            const isTeacher = currentUserRole === 'teacher';
            let filterHtml = '';

            if (!isTeacher) {
                const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                filterHtml = `
                    <div class="grade-select-container flex-grow">
                        <label for="teacher-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por professor:</label>
                        <select id="teacher-filter" class="grade-select">
                            <option value="all">Todos</option>
                            ${teacherOptions}
                        </select>
                    </div>
                `;
            }

            const addAulaButton = ['admin', 'ap', 'pedagogico'].includes(currentUserRole)
                ? `<div class="flex gap-2">
                     <button class="primary-btn w-auto" data-action="add-schedule">+ Adicionar Aula</button>
                     <button class="secondary-btn w-auto" data-action="add-break">+ Adicionar Break</button>
                   </div>`
                : '';

            contentArea.innerHTML = `
                <section id="grade-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        ${filterHtml}
                        <div class="flex gap-2 ml-auto">
                           ${addAulaButton}
                        </div>
                    </div>
                    <div id="weekly-hours-container" class="mb-6"></div>
                    <div id="schedule-grid-container"></div>
                </section>
            `;

            if (isTeacher) {
                // Find the teacher's name in collaborators to ensure correct mapping
                const teacherCollaborator = collaborators.find(c => 
                    c.sectors && c.sectors.includes('professor') && 
                    (c.name === currentUserName || c.email === currentUserName || c.id === userId)
                );
                const originalTeacherName = teacherCollaborator ? teacherCollaborator.name : currentUserName;

                // Use smart name matching to find the actual teacher name in schedules
                const teacherNameToFilter = findTeacherByName(originalTeacherName) || originalTeacherName;

                // Show debug info if teacher has no schedules
                const teacherSchedules = schedules.filter(s => s.teacher === teacherNameToFilter);
                if (teacherSchedules.length === 0) {
                    console.log('DEBUG: Teacher schedule mapping', {
                        currentUserName,
                        originalTeacherName,
                        teacherNameToFilter,
                        availableTeachersInSchedules: [...new Set(schedules.map(s => s.teacher))],
                        collaboratorTeachers: collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => c.name),
                        smartMappingResult: findTeacherByName(originalTeacherName)
                    });

                    // Show helper message for teachers
                    const availableTeachers = [...new Set(schedules.map(s => s.teacher))];
                    if (availableTeachers.length > 0) {
                        document.getElementById('schedule-grid-container').innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                                <div class="mb-4">
                                    <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.662-.833-2.464 0L4.732 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Grade não encontrada</h3>
                                <p class="text-yellow-700 mb-4">Não encontramos horários para o seu nome de usuário.</p>
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <p class="text-sm text-gray-600 mb-2"><strong>Seu nome no sistema:</strong> ${currentUserName}</p>
                                    <p class="text-sm text-gray-600 mb-2"><strong>Professores com horários cadastrados:</strong></p>
                                    <div class="text-sm text-gray-800 font-medium">${availableTeachers.join(', ')}</div>
                                </div>
                                <p class="text-yellow-700 text-sm">Entre em contato com o administrador para ajustar o mapeamento do seu nome.</p>
                            </div>
                        `;
                        return;
                    }
                }

                renderScheduleGrid(teacherNameToFilter);
            } else {
                const teacherFilter = document.getElementById('teacher-filter');
                if (teacherFilter) {
                    teacherFilter.addEventListener('change', () => renderScheduleGrid(teacherFilter.value));
                }
                renderScheduleGrid('all');
            }
        }

        // Helper function to find teacher by first name matching
        function findTeacherByName(searchName) {
            if (!searchName) return null;

            // First try exact match
            const exactMatch = schedules.find(s => s.teacher === searchName);
            if (exactMatch) return searchName;

            // Then try first name matching
            const searchFirstName = searchName.trim().split(' ')[0].toLowerCase();
            const teachers = [...new Set(schedules.map(s => s.teacher))];

            const firstNameMatch = teachers.find(teacher => {
                const teacherFirstName = teacher.trim().split(' ')[0].toLowerCase();
                return teacherFirstName === searchFirstName;
            });

            return firstNameMatch || null;
        }

        function calculateWeeklyHours(teacherName) {
            const actualTeacherName = findTeacherByName(teacherName) || teacherName;
            const teacherSchedules = schedules.filter(s => s.teacher === actualTeacherName && s.type !== 'break');

            // Debug específico para Anael
            if (teacherName.toLowerCase().includes('anael')) {
                console.log('DEBUG ANAEL - Cálculo de horas:', {
                    teacherName,
                    actualTeacherName,
                    allSchedules: schedules.length,
                    anaelSchedules: teacherSchedules,
                    allTeachers: [...new Set(schedules.map(s => s.teacher))]
                });
            }

            let totalHours = 0;
            teacherSchedules.forEach(schedule => {
                const duration = calculateClassDuration(schedule.startTime, schedule.endTime);
                totalHours += duration;
                
                // Debug para Anael
                if (teacherName.toLowerCase().includes('anael')) {
                    console.log(`DEBUG ANAEL - Aula: ${schedule.day} ${schedule.startTime}-${schedule.endTime}, Duração: ${duration}h`);
                }
            });

            // Log final para Anael
            if (teacherName.toLowerCase().includes('anael')) {
                console.log(`DEBUG ANAEL - Total final: ${totalHours} horas`);
            }

            return totalHours;
        }

        function calculateClassDuration(startTime, endTime) {
            // Convert time strings (HH:MM) to minutes
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);

            const startTotalMinutes = startHour * 60 + startMinute;
            const endTotalMinutes = endHour * 60 + endMinute;

            // Calculate duration in hours
            const durationMinutes = endTotalMinutes - startTotalMinutes;
            const durationHours = durationMinutes / 60;

            return durationHours;
        }

        function checkTimeConflict(teacher, day, startTime, endTime, excludeId = null) {
            return schedules.some(s => 
                s.teacher === teacher && 
                s.day === day && 
                s.id !== excludeId &&
                ((startTime >= s.startTime && startTime < s.endTime) || 
                 (endTime > s.startTime && endTime <= s.endTime) ||
                 (startTime <= s.startTime && endTime >= s.endTime))
            );
        }

        function renderScheduleGrid(teacherFilter) {
            const gridContainer = document.getElementById('schedule-grid-container');
            const hoursContainer = document.getElementById('weekly-hours-container');
            if (!gridContainer) return;

            const days = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta"];
            let filteredSchedules = [...schedules];

            if (teacherFilter !== 'all') {
                const actualTeacherName = findTeacherByName(teacherFilter) || teacherFilter;
                filteredSchedules = filteredSchedules.filter(s => s.teacher === actualTeacherName);
            }

            // Debug log for teachers to help identify mapping issues
            if (currentUserRole === 'teacher' && teacherFilter !== 'all') {
                console.log('DEBUG: Grade filtering for teacher', {
                    teacherFilter,
                    currentUserName,
                    currentUserRole,
                    filteredSchedulesCount: filteredSchedules.length,
                    allSchedulesCount: schedules.length,
                    uniqueTeachers: [...new Set(schedules.map(s => s.teacher))]
                });
            }

            // Show weekly hours for specific teacher or all teachers summary
            const canViewAllHours = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);

            if (teacherFilter !== 'all' && hoursContainer) {
                const weeklyHours = calculateWeeklyHours(teacherFilter);
                hoursContainer.innerHTML = `
                    <div class="rounded-lg p-4 text-center border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                        <div class="text-sm font-medium uppercase tracking-wide text-stone-700">Carga Horária Semanal</div>
                        <div class="text-3xl font-bold mt-1 text-stone-800">${weeklyHours} horas</div>
                        <div class="text-xs mt-1 text-stone-600">${teacherFilter}</div>
                    </div>
                `;
            } else if (teacherFilter === 'all' && canViewAllHours && hoursContainer) {
                // Show summary of all teachers' hours
                const teacherHours = {};
                const teachers = collaborators.filter(c => c.sectors && c.sectors.includes('professor'));

                teachers.forEach(teacher => {
                    teacherHours[teacher.name] = calculateWeeklyHours(teacher.name);
                });

                const totalHours = Object.values(teacherHours).reduce((sum, hours) => sum + hours, 0);

                hoursContainer.innerHTML = `
                    <div class="rounded-lg p-4 border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                        <div class="text-sm font-medium text-stone-700 uppercase tracking-wide mb-3 text-center">Resumo da Carga Horária Semanal</div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-3">
                            ${Object.entries(teacherHours).map(([name, hours]) => `
                                <div class="rounded-lg p-3 text-center border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                                    <div class="text-sm font-medium uppercase tracking-wide text-stone-700">Carga Semanal</div>
                                    <div class="text-2xl font-bold mt-1 text-stone-800">${hours} horas</div>
                                    <div class="text-xs mt-1 text-stone-600">${name}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-center pt-3" style="border-top: 1px solid #F1D24B40;">
                            <div class="text-sm text-stone-700">Total Geral</div>
                            <div class="text-2xl font-bold text-stone-800">${totalHours} horas</div>
                        </div>
                    </div>
                `;
            } else if (hoursContainer) {
                hoursContainer.innerHTML = '';
            }

            // Show message if no schedules found for teacher role
            if (currentUserRole === 'teacher' && filteredSchedules.length === 0) {
                return; // Already handled above
            }

            let gridHtml = `<div class="schedule-grid">`;
            days.forEach(day => {
                gridHtml += `<div class="day-column"><h3 class="day-column-header">${day}</h3>`;
                const dayClasses = filteredSchedules.filter(s => s.day === day).sort((a, b) => a.startTime.localeCompare(b.startTime));
                if (dayClasses.length > 0) {
                    dayClasses.forEach(c => {
                        let tagClass, tagText;
                        if (c.type === 'break') {
                            tagClass = 'tag-break';
                            tagText = 'BREAK';
                        } else if (c.type === 'vip') {
                            tagClass = 'tag-vip';
                            tagText = 'VIP';
                        } else {
                            tagClass = 'tag-turma';
                            tagText = 'TURMA';
                        }

                        const teacherName = teacherFilter === 'all' ? `<p class="text-xs text-stone-500"><em>(${c.teacher})</em></p>` : '';
                        const studentInfo = c.type === 'break' ? 
                            `<p class="font-bold text-stone-600">Intervalo</p>` : 
                            `<p class="font-bold text-stone-800">${c.student}</p><p class="text-sm text-stone-700">${c.level}</p>`;

                        gridHtml += `
                            <div class="class-entry" data-action="view-schedule" data-id="${c.id}">
                                <span class="class-tag ${tagClass}">${tagText}</span>
                                <p class="text-xs text-stone-600">${c.startTime} - ${c.endTime}</p>
                                ${studentInfo}
                                ${teacherName}
                            </div>`;
                    });
                } else {
                    gridHtml += `<p class="text-sm text-center text-stone-400 mt-4">Nenhuma aula</p>`;
                }
                gridHtml += `</div>`;
            });
            gridHtml += `</div>`;
            gridContainer.innerHTML = gridHtml;
        }

        function renderFolhaPagamentoSection() {
            document.getElementById('main-title').textContent = 'Folha de Pagamento';
            document.getElementById('main-description').textContent = 'Gerencie as despesas e contas a pagar do mês.';

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthName = now.toLocaleString('pt-BR', { month: 'long' });

            const monthlyExpenses = expenses.map(exp => {
                let dueDate;
                if (exp.isFixedSalary && exp.dueDay) {
                    const day = parseInt(exp.dueDay, 10);
                    if (day > 0 && day < 32) {
                       dueDate = new Date(currentYear, currentMonth, day);
                    }
                } else if (exp.dueDate) {
                    // Create date as UTC to avoid timezone issues with date-only strings
                    const parts = exp.dueDate.split('-');
                    dueDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                }

                if (dueDate && dueDate.getUTCMonth() === currentMonth && dueDate.getUTCFullYear() === currentYear) {
                    return { ...exp, effectiveDueDate: dueDate };
                }
                return null;
            }).filter(Boolean).sort((a, b) => a.effectiveDueDate - b.effectiveDueDate);

            // Calcular valor total de todas as despesas
            const totalExpensesBase = monthlyExpenses
                .reduce((sum, exp) => sum + Number(exp.amount) + Number(exp.extraAmount || 0), 0);

            // Calcular todos os valores pagos (incluindo valores parciais digitados)
            const totalPaidValues = monthlyExpenses
                .reduce((sum, exp) => {
                    if (exp.paidAmount && exp.paidAmount > 0) {
                        return sum + Number(exp.paidAmount);
                    }
                    return sum;
                }, 0);

            // Total a pagar = Total das despesas - Valores já pagos
            const totalToPay = totalExpensesBase - totalPaidValues;
            
            // Total despesas pendentes (apenas não pagas) - para exibição no card
            const totalExpenses = monthlyExpenses
                .filter(exp => !exp.isPaid)
                .reduce((sum, exp) => sum + Number(exp.amount) + Number(exp.extraAmount || 0), 0);

            const totalPaid = monthlyExpenses
                .filter(exp => exp.isPaid)
                .reduce((sum, exp) => sum + Number(exp.paidAmount || exp.amount), 0);

            // Calcular receita total usando o mesmo método da seção de alunos
            const totalRevenue = students.reduce((sum, student) => {
                return sum + parseFloat(student.amountReceived || student.amountPaid || 0);
            }, 0);

            // CORREÇÃO: Lucro real = Receita - TODAS as despesas efetivas (pagas + valores pagos parciais + despesas pendentes)
            const totalEffectiveExpenses = totalPaidValues + totalExpenses;
            const profit = totalRevenue - totalEffectiveExpenses;

            contentArea.innerHTML = `
                <!-- Cards de Resumo Financeiro -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="base-card bg-gradient-to-r from-green-50 to-green-100 border-green-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0 pr-4">
                                <p class="text-sm font-medium text-green-600">Receita Total</p>
                                <p class="text-2xl font-bold text-green-700 mt-1">${totalRevenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="p-2 bg-green-200 rounded-full">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="base-card bg-gradient-to-r from-red-50 to-red-100 border-red-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0 pr-4">
                                <p class="text-sm font-medium text-red-600">Despesas Pendentes</p>
                                <p class="text-2xl font-bold text-red-700 mt-1">${totalExpenses.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="p-2 bg-red-200 rounded-full">
                                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="base-card bg-gradient-to-r from-blue-50 to-blue-100 border-blue-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0 pr-4">
                                <p class="text-sm font-medium text-blue-600">Lucro</p>
                                <p class="text-2xl font-bold text-blue-700 mt-1">${profit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="p-2 bg-blue-200 rounded-full">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <section id="folha-pagamento-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                         <h3 class="text-xl font-bold text-stone-800">Despesas de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>
                         <button class="primary-btn w-auto" data-action="add-expense">+ Nova Despesa</button>
                    </div>
                    
                    <div class="flex gap-2 mb-6" id="expenses-filter-buttons">
                        <button class="secondary-btn filter-btn active" data-filter="todos">Todos</button>
                        <button class="secondary-btn filter-btn" data-filter="fixo">Fixos</button>
                        <button class="secondary-btn filter-btn" data-filter="variavel">Variáveis</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pago</th>
                                    <th>Descrição</th>
                                    <th>Vencimento</th>
                                    <th class="text-right">Valor Base (R$)</th>
                                    <th class="text-right">Valor Extra (R$)</th>
                                    <th class="text-right">Valor Pago (R$)</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-list">
                                ${monthlyExpenses.length > 0 ? monthlyExpenses.map(exp => `
                                    <tr class="${exp.isPaid ? 'paid' : ''}" data-expense-type="${exp.tipo || 'variavel'}">
                                        <td class="text-center"><input type="checkbox" data-action="toggle-expense" data-id="${exp.id}" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${exp.isPaid ? 'checked' : ''}></td>
                                        <td class="font-medium cursor-pointer" data-action="view-expense" data-id="${exp.id}">
                                            ${exp.description} 
                                            ${exp.isFixedSalary && exp.employeeRole ? `<span class="sector-tag">${exp.employeeRole}</span>` : ''}
                                            <span class="inline-block ml-2 px-2 py-1 text-xs rounded-full ${exp.tipo === 'fixo' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}">${exp.tipo === 'fixo' ? 'Fixo' : 'Variável'}</span>
                                        </td>
                                        <td class="cursor-pointer" data-action="view-expense" data-id="${exp.id}">${formatDateBR(exp.effectiveDueDate)}</td>
                                        <td class="text-right font-mono cursor-pointer" data-action="view-expense" data-id="${exp.id}">${Number(exp.amount).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                        <td class="text-right font-mono cursor-pointer" data-action="view-expense" data-id="${exp.id}">${Number(exp.extraAmount || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                        <td class="text-right font-mono cursor-pointer" data-action="view-expense" data-id="${exp.id}">${Number(exp.paidAmount || (exp.isPaid ? exp.amount : 0)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                        <td class="text-center">
                                            <button class="task-delete-btn" data-action="delete-item" data-collection="expenses" data-id="${exp.id}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="7" class="text-center py-8 text-stone-500">Nenhuma despesa para este mês.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    <div class="data-total">
                        <p>Total a Pagar: ${totalToPay.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                    </div>
                </section>
            `;
            
            // Adicionar event listeners para os filtros de despesas
            setTimeout(() => {
                const filterButtons = document.querySelectorAll('#expenses-filter-buttons .filter-btn');
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Remove active class from all buttons
                        filterButtons.forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        e.target.classList.add('active');
                        
                        const filter = e.target.dataset.filter;
                        filterExpensesByType(filter);
                    });
                });
            }, 100);
        }
        
        // Function to filter expenses by type
        function filterExpensesByType(filter) {
            const rows = document.querySelectorAll('#expenses-list tr[data-expense-type]');
            rows.forEach(row => {
                const expenseType = row.dataset.expenseType;
                if (filter === 'todos') {
                    row.style.display = '';
                } else {
                    row.style.display = expenseType === filter ? '' : 'none';
                }
            });
        }



        function renderColaboradoresSection() {
            document.getElementById('main-title').textContent = 'Gestão de Colaboradores';
            document.getElementById('main-description').textContent = 'Adicione, edite e defina os setores de cada colaborador.';
            contentArea.innerHTML = `
                <section id="colaboradores-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-collaborator">+ Adicionar Colaborador</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Setores</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${collaborators.map(c => `
                                    <tr>
                                        <td class="font-medium">${c.name}</td>
                                        <td>${(c.sectors || []).map(s => `<span class="sector-tag">${s}</span>`).join('')}</td>
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-collaborator" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="collaborators" data-id="${c.id}">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="3" class="text-center py-10 text-stone-500">Nenhum colaborador encontrado.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }





        function renderDojoSection() {
            document.getElementById('main-title').textContent = 'SLAP Dojo';
            document.getElementById('main-description').textContent = 'Gerencie a pontuação dos competidores e as missões ativas.';
            const canEdit = ['admin', 'ap'].includes(currentUserRole);
            const addCompetitorBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-dojo-competitor">+ Adicionar Competidor</button>` : '';
            const addMissionBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-dojo-mission">+ Adicionar Missão</button>` : '';

            const sortedRanking = [...dojoRanking].sort((a, b) => b.points - a.points);

            contentArea.innerHTML = `
                <section id="dojo-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xl font-bold text-stone-800">Ranking de Competidores</h3>
                        <div class="flex gap-3">
                            ${addCompetitorBtn}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10 text-center">
                        <div class="p-4 rounded-lg border-2 border-stone-300 bg-stone-50 order-2 md:order-1 flex flex-col items-center justify-center">
                            <h4 class="font-bold text-lg text-amber-500 flex items-center justify-center gap-2 mb-2">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="8" r="6" fill="#C0C0C0" stroke="#A8A8A8" stroke-width="2"/>
                                    <rect x="10" y="14" width="4" height="8" fill="#A8A8A8"/>
                                    <text x="12" y="10" text-anchor="middle" fill="#666666" font-size="8" font-weight="bold">2</text>
                                </svg>
                                2º Lugar
                            </h4>
                            <p class="text-stone-600 text-center">Alexa Echo Dot + R$500 </p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-yellow-400 bg-yellow-50 transform md:scale-110 order-1 md:order-2 flex flex-col items-center justify-center">
                            <h4 class="font-bold text-lg text-yellow-500 flex items-center justify-center gap-2 mb-2">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="8" r="6" fill="#FFD700" stroke="#DAA520" stroke-width="2"/>
                                    <rect x="10" y="14" width="4" height="8" fill="#DAA520"/>
                                    <text x="12" y="10" text-anchor="middle" fill="#DAA520" font-size="8" font-weight="bold">1</text>
                                </svg>
                                1º Lugar
                            </h4>
                            <p class="text-stone-700 font-semibold text-center">R$1000 + jantar + folga</p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-amber-600 bg-stone-50 order-3 md:order-3 flex flex-col items-center justify-center">
                            <h4 class="font-bold text-lg text-amber-700 flex items-center justify-center gap-2 mb-2">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="8" r="6" fill="#CD7F32" stroke="#8B4513" stroke-width="2"/>
                                    <rect x="10" y="14" width="4" height="8" fill="#8B4513"/>
                                    <text x="12" y="10" text-anchor="middle" fill="#654321" font-size="8" font-weight="bold">3</text>
                                </svg>
                                3º Lugar
                            </h4>
                            <p class="text-stone-600 text-center">R$250 + mimo</p>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Competidor</th>
                                    <th>Superpower</th>
                                    <th class="text-right">Pontos</th>
                                    ${canEdit ? '<th class="text-center">Ações</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedRanking.map((c, index) => {
                                    const medals = [
                                        `<svg class="inline-block w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="8" r="6" fill="#FFD700" stroke="#DAA520" stroke-width="2"/>
                                            <rect x="10" y="14" width="4" height="8" fill="#DAA520"/>
                                            <text x="12" y="10" text-anchor="middle" fill="#DAA520" font-size="8" font-weight="bold">1</text>
                                        </svg>`,
                                        `<svg class="inline-block w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="8" r="6" fill="#C0C0C0" stroke="#A8A8A8" stroke-width="2"/>
                                            <rect x="10" y="14" width="4" height="8" fill="#A8A8A8"/>
                                            <text x="12" y="10" text-anchor="middle" fill="#666666" font-size="8" font-weight="bold">2</text>
                                        </svg>`,
                                        `<svg class="inline-block w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="8" r="6" fill="#CD7F32" stroke="#8B4513" stroke-width="2"/>
                                            <rect x="10" y="14" width="4" height="8" fill="#8B4513"/>
                                            <text x="12" y="10" text-anchor="middle" fill="#654321" font-size="8" font-weight="bold">3</text>
                                        </svg>`
                                    ];
                                    const medal = index < 3 ? `<span class="text-xl ml-2">${medals[index]}</span>` : '';
                                    return `
                                    <tr>
                                        <td class="font-bold text-stone-500 text-lg">#${index + 1}</td>
                                        <td class="flex items-center gap-3">
                                            <img src="${c.photo}" alt="${c.name}" class="w-10 h-10 rounded-full object-cover">
                                            <span class="font-medium">${c.name}</span>
                                            ${medal}
                                        </td>
                                        <td>
                                            ${c.superpower ? `<span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full border border-purple-200">${c.superpower}</span>` : '<span class="text-stone-400 text-sm">-</span>'}
                                        </td>
                                        <td class="text-right font-mono font-semibold">${c.points || 0}</td>
                                        ${canEdit ? `
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-dojo-competitor" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="dojo_ranking" data-id="${c.id}">X</button>
                                        </td>
                                        ` : ''}
                                    </tr>
                                `}).join('') || '<tr><td colspan="5" class="text-center py-10 text-stone-500">Nenhum competidor no Dojo.</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <!-- Missões Ativas Section -->
                    <div class="mt-12 pt-8 border-t border-stone-200">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-stone-800">Missões Ativas</h3>
                            ${addMissionBtn}
                        </div>
                        <div id="dojo-missions-list" class="space-y-3">
                            ${dojoMissions.length > 0 ? dojoMissions.map(mission => `
                                <div class="base-card !p-4 flex justify-between items-center">
                                    <p class="font-medium text-stone-700 flex-1 pr-4">${mission.description}</p>
                                    <div class="flex items-center gap-4">
                                        <span class="font-bold text-lg text-yellow-500 whitespace-nowrap">${mission.points} pts</span>
                                        ${canEdit ? `<button class="danger-btn !text-xs !py-1 !px-2" data-action="delete-item" data-collection="dojo_missions" data-id="${mission.id}">Excluir</button>` : ''}
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center p-8 bg-stone-50 rounded-lg"><p class="text-stone-500">Nenhuma missão ativa no momento.</p></div>'}
                        </div>
                    </div>
                </section>
            `;
        }


        // --- MODAL & FORM FUNCTIONS ---
        function clearModalHeaderButtons() {
            const header = document.getElementById('modal-header-container');
            if (!header) return;
            
            const title = header.querySelector('#form-modal-title');
            const closeBtn = header.querySelector('.modal-close-btn');
            
            if (title && closeBtn) {
                header.innerHTML = '';
                header.appendChild(title);
                header.appendChild(closeBtn);
            }
        }
        function closeFormModal() { 
            const modal = document.getElementById('form-modal');
            modal.classList.remove('visible'); 
            clearModalHeaderButtons();
            // Clear attributes to prevent listener conflicts
            modal.removeAttribute('data-pef-modal');
            modal.removeAttribute('data-unit-id');
            modal.removeAttribute('data-pef-type');
            modal.removeAttribute('data-student-name');
        }
        function showSuccessMessage(title, message) { 
            playSuccessSound(); // Play success sound
            clearModalHeaderButtons(); 
            const modalTitle = document.getElementById('form-modal-title'); 
            const modalContentArea = document.getElementById('form-modal-content-area'); 
            modalTitle.textContent = title; 
            modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; 
            document.getElementById('form-modal').classList.add('visible'); 
        }
        function showErrorMessage(title, message) { 
            playErrorSound(); // Play error sound
            clearModalHeaderButtons(); 
            const modalTitle = document.getElementById('form-modal-title'); 
            const modalContentArea = document.getElementById('form-modal-content-area'); 
            modalTitle.textContent = title; 
            modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; 
            document.getElementById('form-modal').classList.add('visible'); 
        }
        function showConfirmationModal(title, message, onConfirm) { clearModalHeaderButtons(); const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<p class="text-stone-600">${message}</p><div class="mt-6 flex justify-end gap-4"><button class="secondary-btn" data-action="close-modal">Cancelar</button><button id="confirm-action-btn" class="danger-btn w-auto">Confirmar</button></div>`; document.getElementById('form-modal').classList.add('visible'); document.getElementById('confirm-action-btn').onclick = () => { onConfirm(); closeFormModal(); }; }

        // Função para formatação de data consistente no formato brasileiro
        function formatDateBR(date) {
            if (!date) return 'N/A';
            const dateObj = typeof date === 'string' ? new Date(date + 'T00:00:00') : new Date(date);
            
            // Garante formato brasileiro DD/MM/AAAA independente da configuração do sistema
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        // Função para formatação de valores monetários no padrão brasileiro
        function formatCurrencyBR(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function openSignUpModal() {
            clearModalHeaderButtons();
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');

            modalTitle.textContent = "Criar Nova Conta";
            modalContentArea.innerHTML = `
                <form id="signup-form" class="space-y-4">
                    <div><label for="signup-name" class="font-medium text-sm">Nome Completo</label><input type="text" id="signup-name" name="name" required class="form-input mt-1"></div>
                    <div><label for="signup-email" class="font-medium text-sm">E-mail</label><input type="email" id="signup-email" name="email" required class="form-input mt-1"></div>
                    <div><label for="signup-password" class="font-medium text-sm">Senha (mín. 6 caracteres)</label><input type="password" id="signup-password" name="password" required class="form-input mt-1"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Cadastrar</button></div>
                </form>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            document.getElementById('form-modal').classList.add('visible');
        }

        function openAlunoForm(alunoId = null) {
            clearModalHeaderButtons();
            const aluno = alunoId ? students.find(s => s.id === alunoId) : null;
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);
            document.getElementById('form-modal-title').textContent = aluno ? "Editar Aluno" : "Adicionar Novo Aluno";

            const statusOptions = ['Ativo', 'Inativo', 'Cancelado', 'Pendente'].map(s => `<option value="${s}" ${aluno?.status === s ? 'selected' : ''}>${s}</option>`).join('');
            const paymentTypeOptions = ['Cartão', 'Boleto', 'Permuta', 'Bolsa', 'Assinatura'].map(p => `<option value="${p}" ${aluno?.paymentType === p ? 'selected' : ''}>${p}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="aluno-id" value="${alunoId || ''}">

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2">Informações Básicas</h4>
                    <div><label class="font-medium text-sm">Nome Completo do Aluno</label><input type="text" id="aluno-name" class="form-input" required value="${aluno?.name || ''}"></div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Status</label><select id="aluno-status" class="form-input">${statusOptions}</select></div>
                        <div><label class="font-medium text-sm">Modalidade</label><select id="aluno-modalidade" class="form-input" required><option value="VIP" ${aluno?.modalidade === 'VIP' ? 'selected' : ''}>VIP</option><option value="TURMA" ${aluno?.modalidade === 'TURMA' ? 'selected' : ''}>TURMA</option><option value="DUPLA" ${aluno?.modalidade === 'DUPLA' ? 'selected' : ''}>DUPLA</option></select></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="aluno-startDate" class="form-input" value="${aluno?.startDate || ''}"></div>
                    </div>
                    <div><label class="font-medium text-sm">Indicação</label><input type="text" id="aluno-indicacao" class="form-input" placeholder="Pessoa que indicou ou cupom utilizado" value="${aluno?.indicacao || ''}"></div>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="aluno-fora-brasil" class="h-4 w-4 rounded text-yellow-500 focus:ring-yellow-400" ${aluno?.foraBrasil ? 'checked' : ''} onchange="toggleLocationFields()">
                            <label for="aluno-fora-brasil" class="ml-2 text-sm font-medium text-stone-700">Mora fora do Brasil?</label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="font-medium text-sm">Local (Cidade/País)</label><input type="text" id="aluno-local" class="form-input" placeholder="Ex: São Paulo ou Toronto, Canadá" value="${aluno?.local || ''}"></div>
                            <div>
                                <label class="font-medium text-sm" id="location-label">Estado</label>
                                <select id="aluno-estado" class="form-input">
                                    <option value="">Selecione o estado</option>
                                    <option value="AC" ${aluno?.estado === 'AC' ? 'selected' : ''}>Acre</option>
                                    <option value="AL" ${aluno?.estado === 'AL' ? 'selected' : ''}>Alagoas</option>
                                    <option value="AP" ${aluno?.estado === 'AP' ? 'selected' : ''}>Amapá</option>
                                    <option value="AM" ${aluno?.estado === 'AM' ? 'selected' : ''}>Amazonas</option>
                                    <option value="BA" ${aluno?.estado === 'BA' ? 'selected' : ''}>Bahia</option>
                                    <option value="CE" ${aluno?.estado === 'CE' ? 'selected' : ''}>Ceará</option>
                                    <option value="DF" ${aluno?.estado === 'DF' ? 'selected' : ''}>Distrito Federal</option>
                                    <option value="ES" ${aluno?.estado === 'ES' ? 'selected' : ''}>Espírito Santo</option>
                                    <option value="GO" ${aluno?.estado === 'GO' ? 'selected' : ''}>Goiás</option>
                                    <option value="MA" ${aluno?.estado === 'MA' ? 'selected' : ''}>Maranhão</option>
                                    <option value="MT" ${aluno?.estado === 'MT' ? 'selected' : ''}>Mato Grosso</option>
                                    <option value="MS" ${aluno?.estado === 'MS' ? 'selected' : ''}>Mato Grosso do Sul</option>
                                    <option value="MG" ${aluno?.estado === 'MG' ? 'selected' : ''}>Minas Gerais</option>
                                    <option value="PA" ${aluno?.estado === 'PA' ? 'selected' : ''}>Pará</option>
                                    <option value="PB" ${aluno?.estado === 'PB' ? 'selected' : ''}>Paraíba</option>
                                    <option value="PR" ${aluno?.estado === 'PR' ? 'selected' : ''}>Paraná</option>
                                    <option value="PE" ${aluno?.estado === 'PE' ? 'selected' : ''}>Pernambuco</option>
                                    <option value="PI" ${aluno?.estado === 'PI' ? 'selected' : ''}>Piauí</option>
                                    <option value="RJ" ${aluno?.estado === 'RJ' ? 'selected' : ''}>Rio de Janeiro</option>
                                    <option value="RN" ${aluno?.estado === 'RN' ? 'selected' : ''}>Rio Grande do Norte</option>
                                    <option value="RS" ${aluno?.estado === 'RS' ? 'selected' : ''}>Rio Grande do Sul</option>
                                    <option value="RO" ${aluno?.estado === 'RO' ? 'selected' : ''}>Rondônia</option>
                                    <option value="RR" ${aluno?.estado === 'RR' ? 'selected' : ''}>Roraima</option>
                                    <option value="SC" ${aluno?.estado === 'SC' ? 'selected' : ''}>Santa Catarina</option>
                                    <option value="SP" ${aluno?.estado === 'SP' ? 'selected' : ''}>São Paulo</option>
                                    <option value="SE" ${aluno?.estado === 'SE' ? 'selected' : ''}>Sergipe</option>
                                    <option value="TO" ${aluno?.estado === 'TO' ? 'selected' : ''}>Tocantins</option>
                                </select>
                                <select id="aluno-continente" class="form-input" style="display: none;">
                                    <option value="">Selecione o continente</option>
                                    <option value="América do Norte" ${aluno?.continente === 'América do Norte' ? 'selected' : ''}>América do Norte</option>
                                    <option value="América do Sul" ${aluno?.continente === 'América do Sul' ? 'selected' : ''}>América do Sul</option>
                                    <option value="Europa" ${aluno?.continente === 'Europa' ? 'selected' : ''}>Europa</option>
                                    <option value="Ásia" ${aluno?.continente === 'Ásia' ? 'selected' : ''}>Ásia</option>
                                    <option value="África" ${aluno?.continente === 'África' ? 'selected' : ''}>África</option>
                                    <option value="Oceania" ${aluno?.continente === 'Oceania' ? 'selected' : ''}>Oceania</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Níveis Cursados</label>
                        <div id="aluno-levels-checkboxes" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 max-h-40 overflow-y-auto p-2 border rounded-md">
                            ${[].map(cp => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="level-${cp.id}" name="completedLevels" value="${cp.title}" class="h-4 w-4 rounded text-yellow-500 focus:ring-yellow-400" ${aluno?.completedLevels?.includes(cp.title) ? 'checked' : ''}>
                                    <label for="level-${cp.id}" class="ml-2 text-sm">${cp.title}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${canViewFinancialInfo ? `
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Informações Financeiras</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Tipo de Pagamento</label><select id="aluno-paymentType" class="form-input">${paymentTypeOptions}</select></div>
                        <div><label class="font-medium text-sm">Quantidade de Parcelas</label><input type="number" min="1" max="24" id="aluno-parcelas" class="form-input" placeholder="Ex: 12" value="${aluno?.parcelas || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Valor Pago (R$)</label><input type="number" step="0.01" id="aluno-amountPaid" class="form-input" value="${aluno?.amountPaid || ''}"></div>
                        <div><label class="font-medium text-sm">Valor Recebido (R$)</label><input type="number" step="0.01" id="aluno-amountReceived" class="form-input" value="${aluno?.amountReceived || ''}"></div>
                    </div>
                    ` : ''}

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Responsável</h4>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="aluno-isMinor" class="h-4 w-4 rounded" ${aluno?.isMinor ? 'checked' : ''}>
                        <label for="aluno-isMinor" class="text-sm font-medium">Menor de idade?</label>
                    </div>
                    <div id="responsible-fields" class="${aluno?.isMinor ? '' : 'hidden'} space-y-4">
                        <div><label class="font-medium text-sm">Nome do Responsável</label><input type="text" id="aluno-responsibleName" class="form-input" value="${aluno?.responsibleName || ''}"></div>
                        <div><label class="font-medium text-sm">Telefone do Responsável</label><input type="tel" id="aluno-responsiblePhone" class="form-input" value="${aluno?.responsiblePhone || ''}"></div>
                    </div>

                    <!-- Campos de Cancelamento (aparecem apenas quando status = Cancelado) -->
                    <div id="cancellation-fields" class="${aluno?.status === 'Cancelado' ? '' : 'hidden'} space-y-4">
                        <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Informações do Cancelamento</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="font-medium text-sm">Data do Cancelamento</label><input type="date" id="aluno-cancellationDate" class="form-input" value="${aluno?.cancellationDate || ''}"></div>
                            <div><label class="font-medium text-sm">Processado Por</label><input type="text" id="aluno-processedBy" class="form-input" placeholder="Nome do responsável" value="${aluno?.processedBy || currentUserName || ''}"></div>
                        </div>
                        <div><label class="font-medium text-sm">Motivo do Cancelamento</label><textarea id="aluno-cancellationReason" rows="3" class="form-input" placeholder="Descreva o motivo do cancelamento...">${aluno?.cancellationReason || ''}</textarea></div>
                    </div>

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Outras Informações</h4>
                    <div><label class="font-medium text-sm">Observações</label><textarea id="aluno-notes" rows="3" class="form-input">${aluno?.notes || ''}</textarea></div>

                    <div class="text-right pt-4"><button type="submit" class="primary-btn w-auto">Salvar Aluno</button></div>
                </form>
            `;

            document.getElementById('aluno-isMinor').addEventListener('change', (e) => {
                document.getElementById('responsible-fields').classList.toggle('hidden', !e.target.checked);
            });

            // Show/hide cancellation fields based on status
            document.getElementById('aluno-status').addEventListener('change', (e) => {
                const cancellationFields = document.getElementById('cancellation-fields');
                if (e.target.value === 'Cancelado') {
                    cancellationFields.classList.remove('hidden');
                    // Auto-fill cancellation date with today's date if empty
                    const dateField = document.getElementById('aluno-cancellationDate');
                    if (!dateField.value) {
                        dateField.value = new Date().toISOString().split('T')[0];
                    }
                } else {
                    cancellationFields.classList.add('hidden');
                }
            });

            const form = document.getElementById('form-modal-body');
            if (form) {
                form.onsubmit = saveAluno;
            } else {
                console.error('Form element not found!');
            }
            document.getElementById('form-modal').classList.add('visible');
            
            // Initialize location fields after modal is visible
            setTimeout(() => {
                toggleLocationFields();
            }, 100);
        }

        async function saveAluno(event) {
            event.preventDefault();
            const alunoId = document.getElementById('aluno-id').value;
            const isMinor = document.getElementById('aluno-isMinor').checked;
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);

            const completedLevels = Array.from(document.querySelectorAll('input[name="completedLevels"]:checked')).map(cb => cb.value);

            const status = document.getElementById('aluno-status').value;
            const isCancelled = status === 'Cancelado';

            const data = {
                name: document.getElementById('aluno-name').value,
                status: status,
                modalidade: document.getElementById('aluno-modalidade').value,
                indicacao: document.getElementById('aluno-indicacao').value,
                startDate: document.getElementById('aluno-startDate').value,
                local: document.getElementById('aluno-local').value,
                estado: document.getElementById('aluno-estado').value,
                continente: document.getElementById('aluno-continente').value,
                foraBrasil: document.getElementById('aluno-fora-brasil').checked,
                completedLevels: completedLevels,
                notes: document.getElementById('aluno-notes').value,
                isMinor: isMinor,
                responsibleName: isMinor ? document.getElementById('aluno-responsibleName').value : '',
                responsiblePhone: isMinor ? document.getElementById('aluno-responsiblePhone').value : '',
                // Cancellation fields (only saved if status is Cancelado)
                cancellationDate: isCancelled ? document.getElementById('aluno-cancellationDate').value : '',
                cancellationReason: isCancelled ? document.getElementById('aluno-cancellationReason').value : '',
                processedBy: isCancelled ? document.getElementById('aluno-processedBy').value : '',
            };

            // Only add financial fields if user has permission
            if (canViewFinancialInfo) {
                data.paymentType = document.getElementById('aluno-paymentType').value;
                data.parcelas = document.getElementById('aluno-parcelas').value;
                data.amountPaid = document.getElementById('aluno-amountPaid').value;
                data.amountReceived = document.getElementById('aluno-amountReceived').value;
            }
            if (!data.name) { showErrorMessage("Erro", "O nome do aluno é obrigatório."); return; }
            if (!data.modalidade) { showErrorMessage("Erro", "A modalidade é obrigatória."); return; }
            
            // Validation for cancellation fields
            if (isCancelled) {
                if (!data.cancellationDate) { showErrorMessage("Erro", "A data do cancelamento é obrigatória."); return; }
                if (!data.cancellationReason) { showErrorMessage("Erro", "O motivo do cancelamento é obrigatório."); return; }
                if (!data.processedBy) { showErrorMessage("Erro", "O responsável pelo processamento é obrigatório."); return; }
            }

            try {
                if (window.isDevelopmentMode) {
                    // Development mode - save to localStorage
                    if (alunoId) {
                        const index = students.findIndex(s => s.id === alunoId);
                        if (index !== -1) {
                            students[index] = { ...students[index], ...data, id: alunoId };
                        }
                    } else {
                        data.id = 'student_' + Date.now();
                        data.createdAt = new Date();
                        students.push(data);
                    }
                    localStorage.setItem('students', JSON.stringify(students));
                } else {
                    // Firebase mode
                    if (alunoId) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, alunoId), data);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, `artifacts/${appId}/public/data/students`), data);
                    }
                }
                
                // Show success message and close modal
                const successMsg = alunoId ? "Dados do aluno atualizados." : "Novo aluno cadastrado.";
                showSuccessMessage("Sucesso!", successMsg);
                closeFormModal();
                
                // Re-render the current section if needed
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'alunos-section') {
                    renderAlunosSection();
                }
            } catch (error) {
                console.error("Error saving student:", error);
                showErrorMessage("Erro", "Falha ao salvar os dados do aluno.");
            }
        }

        function openAlunoModal(alunoId) {
            clearModalHeaderButtons();
            const aluno = students.find(s => s.id === alunoId);
            if (!aluno) return;
            document.getElementById('form-modal-title').textContent = `Perfil de ${aluno.name}`;
            const canEdit = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);

            let responsibleHtml = '';
            if (aluno.isMinor && aluno.responsibleName) {
                responsibleHtml = `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-stone-700">Dados do Responsável</h4>
                        <p class="text-sm text-stone-600 mt-1"><strong>Nome:</strong> ${aluno.responsibleName || 'N/A'}</p>
                        <p class="text-sm text-stone-600"><strong>Telefone:</strong> ${aluno.responsiblePhone || 'N/A'}</p>
                    </div>
                `;
            }

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-stone-800">${aluno.name}</h3>
                        <span class="status-tag status-${(aluno.status || 'pendente').toLowerCase()}">${aluno.status || 'Pendente'}</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm text-stone-600">
                        <p><strong>Modalidade:</strong> <span class="status-tag status-${(aluno.modalidade || 'turma').toLowerCase()}">${aluno.modalidade || 'TURMA'}</span></p>
                        <p><strong>Início:</strong> ${formatDateBR(aluno.startDate)}</p>
                        ${canViewFinancialInfo ? `<p><strong>Pagamento:</strong> ${aluno.paymentType || 'N/A'}</p>` : ''}
                        ${canViewFinancialInfo ? `<p><strong>Parcelas:</strong> ${aluno.parcelas ? `${aluno.parcelas}x` : 'Não informado'}</p>` : ''}
                        <p><strong>Indicação:</strong> ${aluno.indicacao || 'Não informado'}</p>
                        ${canViewFinancialInfo ? `<p><strong>Valor Pago:</strong> R$ ${parseFloat(aluno.amountPaid || 0).toFixed(2)}</p>` : ''}
                        ${canViewFinancialInfo ? `<p><strong>Valor Recebido:</strong> R$ ${parseFloat(aluno.amountReceived || 0).toFixed(2)}</p>` : ''}
                    </div>

                    <div class="pt-2">
                        <p class="font-semibold text-sm text-stone-700">Níveis Cursados:</p>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${(aluno.completedLevels && aluno.completedLevels.length > 0) ? aluno.completedLevels.map(level => `<span class="keyword-tag !m-0">${level}</span>`).join('') : '<span class="text-sm text-stone-500">Nenhum</span>'}
                        </div>
                    </div>

                    ${responsibleHtml}

                    ${aluno.status === 'Cancelado' && aluno.cancellationDate ? `
                    <div class="mt-4 pt-4 border-t border-red-200 bg-red-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-red-700 mb-2">Informações do Cancelamento</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-red-700">
                            <p><strong>Data:</strong> ${formatDateBR(aluno.cancellationDate)}</p>
                            <p><strong>Processado por:</strong> ${aluno.processedBy || 'N/A'}</p>
                        </div>
                        ${aluno.cancellationReason ? `<p class="mt-2 text-sm text-red-700"><strong>Motivo:</strong></p><p class="mt-1 p-2 bg-red-100 rounded text-sm text-red-800 whitespace-pre-wrap">${aluno.cancellationReason}</p>` : ''}
                    </div>
                    ` : ''}

                    ${aluno.notes ? `<div class="mt-4 pt-4 border-t"><strong>Observações:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md whitespace-pre-wrap text-sm">${aluno.notes}</p></div>` : ''}

                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEdit ? `<button class="secondary-btn" data-action="edit-aluno" data-id="${aluno.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="students" data-id="${aluno.id}">Apagar</button>` : ''}
                        <button class="primary-btn" data-action="close-modal">Fechar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        // Helper function to get students already allocated to other classes
        function getStudentsAllocatedToOtherTurmas(excludeTurmaId = null) {
            const allocatedStudentIds = new Set();
            
            turmas.forEach(turma => {
                // Skip the current turma being edited
                if (excludeTurmaId && turma.id === excludeTurmaId) return;
                
                if (turma.studentIds && Array.isArray(turma.studentIds)) {
                    turma.studentIds.forEach(studentId => {
                        allocatedStudentIds.add(studentId);
                    });
                }
            });
            
            return allocatedStudentIds;
        }

        function openTurmaForm(turmaId = null) {
            clearModalHeaderButtons();
            const turma = turmaId ? turmas.find(t => t.id === turmaId) : null;
            document.getElementById('form-modal-title').textContent = turma ? "Editar Turma" : "Adicionar Nova Turma";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${turma?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = ['Beginner', 'Elementary', 'Pre-Intermediate', 'Intermediate', 'Upper-Intermediate', 'Advanced'].map(level => `<option value="${level}" ${turma?.level === level ? 'selected' : ''}>${level}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;

            // Get students already allocated to other classes (excluding current class if editing)
            const allocatedStudentIds = getStudentsAllocatedToOtherTurmas(turmaId);

            const studentCheckboxes = students
                .filter(s => s.status === 'Ativo' && s.modalidade === 'TURMA')
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(s => {
                    const isCurrentlyInThisTurma = (turma?.studentIds || []).includes(s.id);
                    const isAllocatedToOtherTurma = allocatedStudentIds.has(s.id);
                    const isDisabled = isAllocatedToOtherTurma && !isCurrentlyInThisTurma;
                    const otherTurma = isAllocatedToOtherTurma ? turmas.find(t => t.id !== turmaId && (t.studentIds || []).includes(s.id)) : null;
                    
                    return `
                    <div class="flex items-center ${isDisabled ? 'opacity-50' : ''}">
                        <input type="checkbox" id="student-${s.id}" value="${s.id}" name="turma-students" 
                               class="h-4 w-4 rounded" 
                               ${isCurrentlyInThisTurma ? 'checked' : ''} 
                               ${isDisabled ? 'disabled' : ''}>
                        <label for="student-${s.id}" class="ml-2 text-sm ${isDisabled ? 'cursor-not-allowed text-stone-400' : 'cursor-pointer'}">
                            ${s.name} 
                            <span class="text-xs text-stone-400">(TURMA)</span>
                            ${isDisabled ? `<span class="text-xs text-red-500"> - Já alocado em: ${otherTurma?.name || 'Outra turma'}</span>` : ''}
                        </label>
                    </div>
                `}).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="turma-id" value="${turmaId || ''}">
                    <div><label class="font-medium text-sm">Nome da Turma</label><input type="text" id="turma-name" class="form-input" required value="${turma?.name || ''}"></div>
                    <div><label class="font-medium text-sm">Professor</label><select id="turma-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div>
                        <label class="font-medium text-sm">Nível</label>
                        <select id="turma-level" class="form-input" required>${levelOptions}</select>
                        <input type="text" id="turma-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Semestre</label><input type="text" id="turma-semestre" class="form-input" value="${turma?.semestre || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="turma-startDate" class="form-input" value="${turma?.startDate || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Finalização</label><input type="date" id="turma-endDate" class="form-input" value="${turma?.endDate || ''}"></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Alunos</label>
                        <p class="text-xs text-stone-500 mt-1">Alunos já alocados em outras turmas aparecem desabilitados</p>
                        <div id="turma-students-checkboxes" class="mt-2 grid grid-cols-1 gap-y-2 max-h-48 overflow-y-auto p-3 border rounded-md bg-stone-50">
                            ${studentCheckboxes}
                        </div>
                    </div>
                    <div class="flex justify-end gap-2">
                        ${turmaId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="turmas" data-id="${turmaId}">Excluir</button>` : ''}
                        <button type="submit" class="primary-btn w-auto">Salvar Turma</button>
                    </div>
                </form>
            `;
            const levelSelect = document.getElementById('turma-level');
            const levelCustomInput = document.getElementById('turma-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });
            document.getElementById('form-modal-body').onsubmit = saveTurma;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveTurma(event) {
            event.preventDefault();
            const turmaId = document.getElementById('turma-id').value;
            const teacherSelect = document.getElementById('turma-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];

            const levelSelect = document.getElementById('turma-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('turma-level-custom').value
                : levelSelect.value;

            const data = {
                name: document.getElementById('turma-name').value,
                teacherId: selectedTeacherOption.value,
                teacherName: selectedTeacherOption.getAttribute('data-name'),
                level: levelValue,
                studentIds: Array.from(document.querySelectorAll('input[name="turma-students"]:checked')).map(cb => cb.value),
                semestre: document.getElementById('turma-semestre').value,
                startDate: document.getElementById('turma-startDate').value,
                endDate: document.getElementById('turma-endDate').value,
            };

            if (!data.name || !data.teacherId) {
                showErrorMessage("Erro", "Nome da turma e professor são obrigatórios.");
                return;
            }

            try {
                if (turmaId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/turmas`, turmaId), data);
                    showSuccessMessage("Sucesso", "Turma atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/turmas`), data);
                    showSuccessMessage("Sucesso", "Nova turma criada.");
                }
            } catch (error) {
                console.error("Error saving turma:", error);
                showErrorMessage("Erro", "Não foi possível salvar a turma.");
            }
        }

        function openVipForm(vipId = null) {
            clearModalHeaderButtons();
            const vip = vipId ? vips.find(v => v.id === vipId) : null;
            document.getElementById('form-modal-title').textContent = vip ? "Editar VIP" : "Adicionar Novo VIP";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${vip?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = [].map(cp => `<option value="${cp.title}" ${vip?.level === cp.title ? 'selected' : ''}>${cp.title}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;
            
            // Available VIP students (modalidade VIP and not already registered as VIP, or current VIP being edited)
            const availableVipStudents = students.filter(s => s.modalidade === 'VIP' && (!vips.find(v => v.studentId === s.id) || vip?.studentId === s.id));

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="vip-id" value="${vipId || ''}">
                    <div>
                        <label class="font-medium text-sm">Aluno VIP</label>
                        <div class="relative">
                            <input type="text" id="vip-student-search" class="form-input" placeholder="🔍 Digite o nome do aluno ou clique na seta para ver a lista..." 
                                   autocomplete="off" value="${vip ? vip.studentName : ''}" required>
                            <input type="hidden" id="vip-student-id" value="${vip ? vip.studentId : ''}">
                            
                            <!-- Dropdown toggle button -->
                            <button type="button" id="vip-student-dropdown-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            
                            <!-- Search results dropdown -->
                            <div id="vip-student-results" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                                <div class="p-2 text-sm text-gray-500">Digite para pesquisar alunos VIP...</div>
                            </div>
                        </div>
                        <div id="vip-student-error" class="text-red-500 text-sm mt-1 hidden">Selecione um aluno VIP válido</div>
                    </div>
                    <div><label class="font-medium text-sm">Professor (Opcional)</label><select id="vip-teacher" class="form-input"><option value="">Sem professor definido</option>${teacherOptions}</select></div>
                    <div>
                        <label class="font-medium text-sm">Nível (Opcional)</label>
                        <select id="vip-level" class="form-input"><option value="">Sem nível definido</option>${levelOptions}</select>
                        <input type="text" id="vip-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Semestre</label><input type="text" id="vip-semestre" class="form-input" value="${vip?.semestre || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="vip-startDate" class="form-input" value="${vip?.startDate || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Finalização</label><input type="date" id="vip-endDate" class="form-input" value="${vip?.endDate || ''}"></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Observações sobre o aluno</label>
                        <textarea id="vip-observacoes" class="form-input h-24 resize-none" 
                                placeholder="Digite observações relevantes sobre o aluno, perfil de aprendizagem, preferências, histórico, etc."
                                >${vip?.observacoes || ''}</textarea>
                        <p class="text-xs text-gray-500 mt-1">Informações que podem ajudar o professor no acompanhamento do aluno</p>
                    </div>
                    <div class="flex justify-end gap-2">
                        ${vipId ? `<button type="button" class="danger-btn" data-action="delete-vip" data-id="${vipId}">Excluir VIP</button>` : ''}
                        <button type="submit" class="primary-btn w-auto">${vipId ? 'Salvar' : 'Criar VIP'}</button>
                    </div>
                </form>
            `;
            // Level selection functionality
            const levelSelect = document.getElementById('vip-level');
            const levelCustomInput = document.getElementById('vip-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });

            // VIP student search functionality
            setupVipStudentSearch(availableVipStudents);

            document.getElementById('form-modal-body').onsubmit = saveVip;
            document.getElementById('form-modal').classList.add('visible');
        }

        function setupVipStudentSearch(availableVipStudents) {
            const searchInput = document.getElementById('vip-student-search');
            const studentIdInput = document.getElementById('vip-student-id');
            const resultsContainer = document.getElementById('vip-student-results');
            const dropdownBtn = document.getElementById('vip-student-dropdown-btn');
            const errorDiv = document.getElementById('vip-student-error');

            // Function to filter and display students
            function filterAndDisplayStudents(query = '') {
                const filteredStudents = availableVipStudents.filter(student => 
                    student.name.toLowerCase().includes(query.toLowerCase())
                );

                if (filteredStudents.length === 0) {
                    resultsContainer.innerHTML = `<div class="p-2 text-sm text-gray-500">Nenhum aluno VIP encontrado${query ? ` para "${query}"` : ''}</div>`;
                } else {
                    resultsContainer.innerHTML = filteredStudents.map(student => `
                        <div class="p-2 cursor-pointer hover:bg-gray-100 border-b border-gray-100 last:border-b-0" 
                             data-student-id="${student.id}" data-student-name="${student.name}">
                            <div class="font-medium">${student.name}</div>
                            <div class="text-xs text-gray-500">Status: ${student.status} | Modalidade: ${student.modalidade || 'VIP'}</div>
                        </div>
                    `).join('');
                }

                // Add click listeners to results
                resultsContainer.querySelectorAll('[data-student-id]').forEach(item => {
                    item.addEventListener('click', () => {
                        const studentId = item.getAttribute('data-student-id');
                        const studentName = item.getAttribute('data-student-name');
                        selectStudent(studentId, studentName);
                    });
                });
            }

            // Function to select a student
            function selectStudent(studentId, studentName) {
                searchInput.value = studentName;
                studentIdInput.value = studentId;
                resultsContainer.classList.add('hidden');
                errorDiv.classList.add('hidden');
            }

            // Search input event listener
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query.length === 0) {
                    studentIdInput.value = '';
                    resultsContainer.classList.add('hidden');
                    errorDiv.classList.add('hidden');
                    return;
                }

                // Check if typed name matches exactly an available student
                const exactMatch = availableVipStudents.find(s => 
                    s.name.toLowerCase() === query.toLowerCase()
                );

                if (exactMatch) {
                    studentIdInput.value = exactMatch.id;
                    errorDiv.classList.add('hidden');
                } else {
                    studentIdInput.value = '';
                }

                filterAndDisplayStudents(query);
                resultsContainer.classList.remove('hidden');
            });

            // Dropdown button click to show all students
            dropdownBtn.addEventListener('click', () => {
                if (resultsContainer.classList.contains('hidden')) {
                    filterAndDisplayStudents(); // Show all students
                    resultsContainer.classList.remove('hidden');
                    searchInput.focus();
                } else {
                    resultsContainer.classList.add('hidden');
                }
            });

            // Focus event to show dropdown
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim()) {
                    filterAndDisplayStudents(searchInput.value.trim());
                } else {
                    filterAndDisplayStudents(); // Show all students
                }
                resultsContainer.classList.remove('hidden');
            });

            // Validate on blur
            searchInput.addEventListener('blur', (e) => {
                // Small delay to allow clicking on results
                setTimeout(() => {
                    if (!studentIdInput.value && searchInput.value.trim()) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'Selecione um aluno válido da lista';
                    }
                    resultsContainer.classList.add('hidden');
                }, 150);
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#vip-student-search') && 
                    !e.target.closest('#vip-student-results') && 
                    !e.target.closest('#vip-student-dropdown-btn')) {
                    resultsContainer.classList.add('hidden');
                }
            });
        }

        async function saveVip(event) {
            event.preventDefault();
            const vipId = document.getElementById('vip-id').value;
            const teacherSelect = document.getElementById('vip-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];
            
            // Get student data from the new search system
            const studentId = document.getElementById('vip-student-id').value;
            const studentName = document.getElementById('vip-student-search').value.trim();

            const levelSelect = document.getElementById('vip-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('vip-level-custom').value
                : levelSelect.value;

            // Validate student selection
            if (!studentId || !studentName) {
                const errorDiv = document.getElementById('vip-student-error');
                errorDiv.classList.remove('hidden');
                errorDiv.textContent = 'Selecione um aluno VIP válido';
                showErrorMessage("Erro", "Selecione um aluno VIP.");
                return;
            }

            const data = {
                studentId: studentId,
                studentName: studentName,
                teacherId: selectedTeacherOption.value || null,
                teacherName: selectedTeacherOption.getAttribute('data-name') || null,
                level: levelValue || null,
                semestre: document.getElementById('vip-semestre').value,
                observacoes: document.getElementById('vip-observacoes').value.trim(),
                startDate: document.getElementById('vip-startDate').value,
                endDate: document.getElementById('vip-endDate').value,
            };

            try {
                if (vipId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/vips`, vipId), data);
                    showSuccessMessage("Sucesso", "VIP atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/vips`), data);
                    showSuccessMessage("Sucesso", "Novo VIP criado.");
                }
            } catch (error) {
                console.error("Error saving VIP:", error);
                showErrorMessage("Erro", "Não foi possível salvar o VIP.");
            }
        }

        async function deleteVip(vipId) {
            if (!confirm('Tem certeza que deseja excluir este VIP?')) return;

            try {
                if (window.isDevelopmentMode) {
                    vips = vips.filter(v => v.id !== vipId);
                    localStorage.setItem('vips', JSON.stringify(vips));
                } else {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/vips`, vipId));
                }
                showSuccessMessage("Sucesso!", "VIP excluído com sucesso.");
                closeFormModal();
                renderVipsSection();
            } catch (error) {
                console.error("Error deleting VIP:", error);
                showErrorMessage("Erro", "Não foi possível excluir o VIP.");
            }
        }

        // Function to delete all VIPs from the VIP section (not affecting students)
        async function deleteAllVips() {
            if (!confirm('Tem certeza que deseja excluir TODOS os VIPs cadastrados? Esta ação não pode ser desfeita.')) return;
            if (!confirm('Esta ação irá excluir todos os registros VIP, mas não afetará os dados dos alunos. Continuar?')) return;
            
            try {
                const vipCount = vips.length;
                
                if (window.isDevelopmentMode) {
                    // Clear local storage VIPs
                    vips.length = 0;
                    localStorage.setItem('vips', JSON.stringify(vips));
                } else {
                    // Delete all VIPs from Firebase
                    const vipCollection = collection(db, `artifacts/${appId}/public/data/vips`);
                    const snapshot = await getDocs(vipCollection);
                    const batch = writeBatch(db);
                    
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                }
                
                showSuccessMessage("Sucesso!", `${vipCount} VIPs foram excluídos com sucesso. Os dados dos alunos não foram afetados.`);
                
                // Refresh the VIPs section if currently viewing it
                if (contentArea.firstElementChild?.id === 'vips-section') {
                    renderVipsSection();
                }
            } catch (error) {
                console.error("Error deleting all VIPs:", error);
                showErrorMessage("Erro", "Falha ao excluir todos os VIPs.");
            }
        }



        function openTurmaPefModal(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma não encontrada."); return; }

            const modal = document.getElementById('form-modal');
            modal.dataset.pefModal = "true";
            modal.dataset.unitId = turmaId;
            modal.dataset.pefType = "turma";

            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');

            // Definir turmaStudents primeiro
            const turmaStudents = (turma.studentIds || []).map(id => students.find(s => s.id === id)).filter(Boolean);

            // Botão de exportação da turma completa
            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar PEF Completo';
            exportButton.dataset.action = 'export-turma-pef';
            exportButton.dataset.id = turmaId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));

            // Dropdown de exportação individual por aluno
            const exportStudentDropdown = document.createElement('div');
            exportStudentDropdown.className = 'relative inline-block ml-2';
            exportStudentDropdown.innerHTML = `
                <button type="button" class="secondary-btn w-auto dropdown-toggle" id="export-student-btn-${turmaId}">
                    Exportar por Aluno
                    <svg class="w-4 h-4 ml-2 inline" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div class="dropdown-menu absolute left-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden" id="export-student-menu-${turmaId}">
                    ${turmaStudents.map(student => `
                        <button type="button" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded" 
                                data-action="export-student-pef" 
                                data-turma-id="${turmaId}" 
                                data-student-id="${student.id}">
                            ${student.name}
                        </button>
                    `).join('')}
                </div>
            `;
            modalHeader.insertBefore(exportStudentDropdown, modalHeader.querySelector('.modal-close-btn'));

            // Adicionar JavaScript para o dropdown
            setTimeout(() => {
                const dropdownBtn = document.getElementById(`export-student-btn-${turmaId}`);
                const dropdownMenu = document.getElementById(`export-student-menu-${turmaId}`);
                
                if (dropdownBtn && dropdownMenu) {
                    dropdownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdownMenu.classList.toggle('hidden');
                    });
                    
                    // Fechar dropdown ao clicar fora
                    document.addEventListener('click', (e) => {
                        if (!exportStudentDropdown.contains(e.target)) {
                            dropdownMenu.classList.add('hidden');
                        }
                    });
                }
            }, 100);

            modalTitle.textContent = `PEF: ${turma.name}`;

            const unitAttendance = attendance.find(a => a.id === turmaId);

            let lessonsHtml = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i];
                const lessonDate = lessonData?.date || '';

                const studentsHtml = turmaStudents.map(student => {
                    const studentStatus = lessonData?.students?.[student.id] || '';
                    return `
                        <div class="pef-student-attendance-row" data-student-id="${student.id}">
                            <span class="text-sm">${student.name}</span>
                            <div class="pef-status-btn-group flex gap-1">
                                <button data-action="mark-attendance" data-status="P" class="${studentStatus === 'P' ? 'active P' : ''}">P</button>
                                <button data-action="mark-attendance" data-status="F" class="${studentStatus === 'F' ? 'active F' : ''}">F</button>
                                <button data-action="mark-attendance" data-status="PP" class="${studentStatus === 'PP' ? 'active PP' : ''}">PP</button>
                            </div>
                        </div>
                    `;
                }).join('');

                lessonsHtml += `
                    <div class="pef-lesson-row" id="lesson-row-${turmaId}-${i}">
                        <div class="flex flex-col justify-center items-center gap-2">
                             <span class="font-bold text-stone-700">Aula ${i}</span>
                             <button class="secondary-btn !text-xs !py-1 !px-3" data-action="save-pef-lesson" data-unit-id="${turmaId}" data-lesson-number="${i}">Salvar</button>
                        </div>
                        <input type="date" class="form-input p-2 text-sm lesson-date self-center" value="${lessonDate}">
                        <div class="space-y-2">
                            <textarea class="form-input p-2 text-sm w-full lesson-topic" placeholder="Tema da aula">${lessonData?.topic || ''}</textarea>
                            <textarea class="form-input p-2 text-sm w-full lesson-notes mt-2" placeholder="Observações da aula">${lessonData?.notes || ''}</textarea>
                            ${studentsHtml}
                        </div>
                    </div>
                `;
            }

            modalContentArea.innerHTML = `
                <div>${lessonsHtml}</div>
            `;
            modal.classList.add('visible');
        }

        function openVipPefModal(vipId) {
            const vip = vips.find(v => v.id === vipId);
            if (!vip) { showErrorMessage("Erro", "Aluno VIP não encontrado."); return; }
            const student = students.find(s => s.id === vip.studentId);
            if (!student) { showErrorMessage("Erro", "Dados do aluno não encontrados."); return; }

            const modal = document.getElementById('form-modal');
            modal.dataset.pefModal = "true";
            modal.dataset.unitId = vipId;
            modal.dataset.pefType = "vip";

            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');

            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar PEF';
            exportButton.dataset.action = 'export-vip-pef';
            exportButton.dataset.id = vipId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));

            modalTitle.textContent = `PEF (VIP): ${vip.studentName}`;

            const unitAttendance = attendance.find(a => a.id === vipId);

            let lessonsHtml = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i];
                const lessonDate = lessonData?.date || '';
                const lessonNotes = lessonData?.notes || '';
                const lessonTopic = lessonData?.topic || '';
                const studentStatus = lessonData?.students?.[student.id] || '';

                const studentHtml = `
                    <div class="pef-student-attendance-row" data-student-id="${student.id}">
                        <span class="text-sm font-semibold">${student.name}</span>
                        <div class="pef-status-btn-group flex gap-1">
                            <button data-action="mark-attendance" data-status="P" class="${studentStatus === 'P' ? 'active P' : ''}">P</button>
                            <button data-action="mark-attendance" data-status="F" class="${studentStatus === 'F' ? 'active F' : ''}">F</button>
                            <button data-action="mark-attendance" data-status="PP" class="${studentStatus === 'PP' ? 'active PP' : ''}">PP</button>
                        </div>
                    </div>
                `;

                lessonsHtml += `
                    <div class="pef-lesson-row" id="lesson-row-${vipId}-${i}">
                        <div class="flex flex-col justify-center items-center gap-2">
                             <span class="font-bold text-stone-700">Aula ${i}</span>
                             <button class="secondary-btn !text-xs !py-1 !px-3" data-action="save-pef-lesson" data-unit-id="${vipId}" data-lesson-number="${i}">Salvar</button>
                        </div>
                        <input type="date" class="form-input p-2 text-sm lesson-date self-center" value="${lessonDate}">
                        <div class="space-y-2">
                            <textarea class="form-input p-2 text-sm w-full lesson-topic" placeholder="Tema da aula">${lessonTopic}</textarea>
                            <textarea class="form-input p-2 text-sm w-full lesson-notes mt-2" placeholder="Observações da aula">${lessonNotes}</textarea>
                            ${studentHtml}
                        </div>
                    </div>
                `;
            }

            modalContentArea.innerHTML = `
                <div>${lessonsHtml}</div>
            `;
            modal.classList.add('visible');
        }

        async function saveAllPefLessons(unitId, pefType) {
            try {
                console.log("saveAllPefLessons called with:", unitId, pefType);
                showSuccessMessage("Salvando...", "Processando todas as aulas. Aguarde...");
                
                let savedCount = 0;
                const totalLessons = 40;
                
                for (let lessonNumber = 1; lessonNumber <= totalLessons; lessonNumber++) {
                    const lessonRow = document.getElementById(`lesson-row-${unitId}-${lessonNumber}`);
                    if (!lessonRow) continue;
                    
                    const date = lessonRow.querySelector('.lesson-date').value;
                    // Skip lessons without date (empty lessons)
                    if (!date) continue;
                    
                    const topic = lessonRow.querySelector('.lesson-topic').value;
                    const notes = lessonRow.querySelector('.lesson-notes').value;
                    
                    const studentAttendance = {};
                    const studentRows = lessonRow.querySelectorAll('.pef-student-attendance-row');
                    studentRows.forEach(row => {
                        const studentId = row.dataset.studentId;
                        const activeButton = row.querySelector('.pef-status-btn-group button.active');
                        const status = activeButton ? activeButton.dataset.status : '';
                        if (studentId) {
                            studentAttendance[studentId] = status;
                        }
                    });
                    
                    const attendanceRef = doc(db, `artifacts/${appId}/public/data/attendance`, unitId);
                    
                    try {
                        await updateDoc(attendanceRef, {
                            [`lessons.${lessonNumber}`]: {
                                date: date,
                                topic: topic,
                                notes: notes,
                                students: studentAttendance
                            }
                        });
                        savedCount++;
                    } catch (error) {
                        console.error(`Error saving lesson ${lessonNumber}:`, error);
                        // Continue with other lessons even if one fails
                    }
                }
                
                // Update local data
                let attendanceIndex = attendance.findIndex(a => a.id === unitId);
                if (attendanceIndex === -1) {
                    attendance.push({ id: unitId, lessons: {} });
                    attendanceIndex = attendance.length - 1;
                }
                
                if (!attendance[attendanceIndex].lessons) {
                    attendance[attendanceIndex].lessons = {};
                }
                
                // Update local attendance data for each saved lesson
                for (let lessonNumber = 1; lessonNumber <= totalLessons; lessonNumber++) {
                    const lessonRow = document.getElementById(`lesson-row-${unitId}-${lessonNumber}`);
                    if (!lessonRow) continue;
                    
                    const date = lessonRow.querySelector('.lesson-date').value;
                    if (!date) continue;
                    
                    const topic = lessonRow.querySelector('.lesson-topic').value;
                    const notes = lessonRow.querySelector('.lesson-notes').value;
                    
                    const studentAttendance = {};
                    const studentRows = lessonRow.querySelectorAll('.pef-student-attendance-row');
                    studentRows.forEach(row => {
                        const studentId = row.dataset.studentId;
                        const activeButton = row.querySelector('.pef-status-btn-group button.active');
                        const status = activeButton ? activeButton.dataset.status : '';
                        if (studentId) {
                            studentAttendance[studentId] = status;
                        }
                    });
                    
                    attendance[attendanceIndex].lessons[lessonNumber] = {
                        date: date,
                        topic: topic,
                        notes: notes,
                        students: studentAttendance
                    };
                }
                
                showSuccessMessage("Sucesso!", `${savedCount} aulas salvas com sucesso.`);
                
            } catch (error) {
                console.error("Error saving all lessons:", error);
                showErrorMessage("Erro", "Falha ao salvar todas as aulas. Algumas aulas podem ter sido salvas.");
            }
        }

        async function savePefLesson(unitId, lessonNumber) {
            const lessonRow = document.getElementById(`lesson-row-${unitId}-${lessonNumber}`);
            if (!lessonRow) {
                console.error("Lesson row not found");
                return;
            }

            const date = lessonRow.querySelector('.lesson-date').value;
            const topic = lessonRow.querySelector('.lesson-topic').value;
            const notes = lessonRow.querySelector('.lesson-notes').value;

            const studentAttendance = {};
            const studentRows = lessonRow.querySelectorAll('.pef-student-attendance-row');
            studentRows.forEach(row => {
                const studentId = row.dataset.studentId;
                const activeButton = row.querySelector('.pef-status-btn-group button.active');
                const status = activeButton ? activeButton.dataset.status : '';
                if (studentId) {
                    studentAttendance[studentId] = status;
                }
            });

            if (!date) {
                showErrorMessage("Data Obrigatória", "Por favor, selecione a data da aula antes de salvar.");
                return;
            }

            const attendanceRef = doc(db, `artifacts/${appId}/public/data/attendance`, unitId);

            const lessonData = {
                date: date,
                students: studentAttendance,
                topic: topic,
                notes: notes,
            };

            try {
                await setDoc(attendanceRef, {
                    id: unitId,
                    lessons: {
                        [lessonNumber]: lessonData
                    }
                }, { merge: true });

                showSuccessMessage("Sucesso!", `Presença da Aula ${lessonNumber} foi salva.`);
            } catch (error) {
                console.error("Error saving attendance: ", error);
                showErrorMessage("Erro", "Falha ao salvar a presença. Tente novamente.");
            }
        }

        function openCampanhaForm(campanhaId = null) {
            console.log('openCampanhaForm called with campanhaId:', campanhaId);
            clearModalHeaderButtons();
            const campanha = campanhaId ? events.find(c => c.id === campanhaId) : null;
            console.log('Found campanha:', campanha);
            document.getElementById('form-modal-title').textContent = campanha ? "Editar Campanha" : "Adicionar Nova Campanha";

            const colaboradorOptions = collaborators
                .filter(c => c.sectors && (c.sectors.includes('campanhas') || c.sectors.includes('admin')))
                .map(c => `<option value="${c.name}" ${campanha?.responsavel === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const setoresOptions = ['Marketing', 'Pedagógico', 'Comercial', 'Financeiro', 'Administrativo'].map(setor => 
                `<div class="flex items-center">
                    <input type="checkbox" id="setor-${setor}" name="setores" value="${setor}" class="h-4 w-4 rounded" ${campanha?.setores?.includes(setor) ? 'checked' : ''}>
                    <label for="setor-${setor}" class="ml-2 text-sm">${setor}</label>
                </div>`
            ).join('');
            
            const plataformaOptions = ['Reels', 'Story', 'Destaque', 'TikTok', 'YouTube', 'YouTube Shorts', 'Presencial'].map(plataforma => 
                `<div class="flex items-center">
                    <input type="checkbox" id="plataforma-${plataforma.replace(/\s+/g, '')}" name="plataforma" value="${plataforma}" class="h-4 w-4 rounded plataforma-checkbox" ${campanha?.plataforma?.includes(plataforma) || campanha?.foco?.includes(plataforma) ? 'checked' : ''}>
                    <label for="plataforma-${plataforma.replace(/\s+/g, '')}" class="ml-2 text-sm">${plataforma}</label>
                </div>`
            ).join('');

            const focoOptions = ['Matrículas', 'Engajamento', 'Captação de Leads', 'Fortalecimento de Marca', 'Gestão de Crise', 'Filler'].map(foco => 
                `<div class="flex items-center">
                    <input type="checkbox" id="foco-${foco.replace(/\s+/g, '')}" name="foco" value="${foco}" class="h-4 w-4 rounded foco-checkbox" ${campanha?.focoObjetivo?.includes(foco) ? 'checked' : ''}>
                    <label for="foco-${foco.replace(/\s+/g, '')}" class="ml-2 text-sm">${foco}</label>
                </div>`
            ).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="campanha-id" value="${campanhaId || ''}">
                    
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2">Informações Básicas</h4>
                    <div><label class="font-medium text-sm">Nome da Campanha</label><input type="text" id="campanha-nome" class="form-input" required value="${campanha?.nome || campanha?.title || ''}"></div>
                    
                    <div><label class="font-medium text-sm">Responsável Principal</label><select id="campanha-responsavel" class="form-input" required><option value="">Selecione um responsável</option>${colaboradorOptions}</select></div>
                    
                    <div>
                        <label class="font-medium text-sm">Setores Envolvidos</label>
                        <div class="mt-2 grid grid-cols-2 gap-2 p-3 border rounded-md">
                            ${setoresOptions}
                        </div>
                    </div>
                    
                    <div><label class="font-medium text-sm">Briefing</label><textarea id="campanha-briefing" rows="3" class="form-input" placeholder="Descreva o objetivo e contexto da campanha...">${campanha?.briefing || ''}</textarea></div>
                    
                    <div><label class="font-medium text-sm">Estratégia</label><textarea id="campanha-estrategia" rows="3" class="form-input" placeholder="Descreva a estratégia de execução...">${campanha?.estrategia || ''}</textarea></div>
                    
                    <div><label class="font-medium text-sm">Link Útil</label><input type="url" id="campanha-link" class="form-input" placeholder="https://exemplo.com" value="${campanha?.linkUtil || ''}"></div>
                    
                    <div>
                        <label class="font-medium text-sm">Referências</label>
                        <div class="space-y-2 mt-2">
                            <input type="url" id="campanha-referencia1" class="form-input" placeholder="https://referencia1.com" value="${campanha?.referencia1 || ''}">
                            <input type="url" id="campanha-referencia2" class="form-input" placeholder="https://referencia2.com" value="${campanha?.referencia2 || ''}">
                        </div>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Plataforma</label>
                        <div class="mt-2 grid grid-cols-2 gap-2 p-3 border rounded-md bg-blue-50">
                            ${plataformaOptions}
                        </div>
                    </div>

                    <div>
                        <label class="font-medium text-sm">Foco da Campanha</label>
                        <div class="mt-2 grid grid-cols-2 gap-2 p-3 border rounded-md bg-yellow-50">
                            ${focoOptions}
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" id="add-horario" name="add-horario" class="h-4 w-4 rounded" ${campanha?.horario ? 'checked' : ''}>
                            <label for="add-horario" class="ml-2 text-sm font-medium">Adicionar horário?</label>
                        </div>
                    </div>
                    
                    <div id="horario-field" class="hidden">
                        <label class="font-medium text-sm">Horário</label>
                        <input type="time" id="campanha-horario" class="form-input" value="${campanha?.horario || ''}">
                    </div>
                    
                    <div id="local-field" class="hidden">
                        <label class="font-medium text-sm">Local do Evento Presencial</label>
                        <input type="text" id="campanha-local" class="form-input" placeholder="Endereço do local" value="${campanha?.local || ''}">
                    </div>
                    
                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" id="campanha-finalizada" name="finalizada" class="h-4 w-4 rounded" ${campanha?.finalizada ? 'checked' : ''}>
                            <label for="campanha-finalizada" class="ml-2 text-sm font-medium">Campanha finalizada</label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button type="button" data-action="close-modal" class="secondary-btn">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">${campanha ? 'Atualizar' : 'Criar'} Campanha</button>
                    </div>
                </form>
            `;
            
            // Add event listeners for conditional fields
            setTimeout(() => {
                const presencialCheckbox = document.getElementById('plataforma-Presencial');
                const horarioCheckbox = document.getElementById('add-horario');
                
                if (presencialCheckbox) {
                    presencialCheckbox.addEventListener('change', function() {
                        const localField = document.getElementById('local-field');
                        if (this.checked) {
                            localField.classList.remove('hidden');
                        } else {
                            localField.classList.add('hidden');
                            document.getElementById('campanha-local').value = '';
                        }
                    });
                    
                    // Check if presencial is already selected
                    if (campanha?.foco?.includes('Presencial')) {
                        document.getElementById('local-field').classList.remove('hidden');
                    }
                }
                
                if (horarioCheckbox) {
                    horarioCheckbox.addEventListener('change', function() {
                        const horarioField = document.getElementById('horario-field');
                        if (this.checked) {
                            horarioField.classList.remove('hidden');
                        } else {
                            horarioField.classList.add('hidden');
                            document.getElementById('campanha-horario').value = '';
                        }
                    });
                    
                    // Check if horario is already set
                    if (campanha?.horario) {
                        document.getElementById('horario-field').classList.remove('hidden');
                    }
                }
            }, 100);
            
            document.getElementById('form-modal-body').onsubmit = saveCampanha;
            // Force modal to be visible
            const modal = document.getElementById('form-modal');
            modal.classList.add('visible');
            modal.style.display = 'flex';
            console.log('Modal should be visible now');
        }

        async function saveCampanha(event) {
            event.preventDefault();
            const campanhaId = document.getElementById('campanha-id').value;
            
            const setoresSelecionados = Array.from(document.querySelectorAll('input[name="setores"]:checked')).map(cb => cb.value);
            const plataformaSelecionada = Array.from(document.querySelectorAll('input[name="plataforma"]:checked')).map(cb => cb.value);
            const focoSelecionado = Array.from(document.querySelectorAll('input[name="foco"]:checked')).map(cb => cb.value);
            
            const data = {
                nome: document.getElementById('campanha-nome').value,
                responsavel: document.getElementById('campanha-responsavel').value,
                setores: setoresSelecionados,
                briefing: document.getElementById('campanha-briefing').value,
                estrategia: document.getElementById('campanha-estrategia').value,
                linkUtil: document.getElementById('campanha-link').value,
                referencia1: document.getElementById('campanha-referencia1').value,
                referencia2: document.getElementById('campanha-referencia2').value,
                plataforma: plataformaSelecionada,
                focoObjetivo: focoSelecionado,
                // Keep old foco field for backward compatibility
                foco: plataformaSelecionada,
                local: document.getElementById('campanha-local').value,
                horario: document.getElementById('campanha-horario').value,
                finalizada: document.getElementById('campanha-finalizada').checked,
                updatedAt: serverTimestamp()
            };

            if (!data.nome) { showErrorMessage("Erro", "O nome da campanha é obrigatório."); return; }
            if (!data.responsavel) { showErrorMessage("Erro", "O responsável é obrigatório."); return; }
            if (setoresSelecionados.length === 0) { showErrorMessage("Erro", "Selecione pelo menos um setor."); return; }
            if (plataformaSelecionada.length === 0) { showErrorMessage("Erro", "Selecione pelo menos uma plataforma."); return; }
            if (focoSelecionado.length === 0) { showErrorMessage("Erro", "Selecione pelo menos um foco da campanha."); return; }

            if (!db) { 
                console.warn("Firebase not available");
                showErrorMessage("Erro", "Sistema offline. Tente novamente quando a conexão for restaurada."); 
                return; 
            }
            
            try {
                if (campanhaId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/events`, campanhaId), data);
                    showSuccessMessage("Sucesso!", "Campanha atualizada com sucesso.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/events`), data);
                    showSuccessMessage("Sucesso!", "Nova campanha criada com sucesso.");
                }
                closeFormModal();
            } catch (error) {
                console.error("Error saving campanha:", error);
                showErrorMessage("Erro", "Falha ao salvar a campanha.");
            }
        }

        function openCampanhaModal(campanhaId) {
            clearModalHeaderButtons();
            const campanha = events.find(c => c.id === campanhaId);
            if (!campanha) return;
            
            document.getElementById('form-modal-title').textContent = campanha.nome || campanha.title;
            
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold text-stone-800 leading-tight mb-3">${campanha.nome || campanha.title}</h3>
                        ${campanha.setores ? `<div class="flex flex-wrap gap-1">${campanha.setores.map(setor => `<span class="status-tag status-${setor.toLowerCase()} text-xs">${setor}</span>`).join('')}</div>` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-stone-600">
                        <p><strong>Responsável:</strong> ${campanha.responsavel || 'N/A'}</p>
                        <p><strong>Foco:</strong> ${campanha.foco ? campanha.foco.join(', ') : 'N/A'}</p>
                        ${campanha.horario ? `<p><strong>Horário:</strong> ${campanha.horario}</p>` : ''}
                        <p><strong>Status:</strong> <span class="${campanha.finalizada ? 'text-green-600 font-medium' : 'text-orange-600'}">${campanha.finalizada ? 'Finalizada' : 'Em andamento'}</span></p>
                        ${campanha.local ? `<p class="col-span-full"><strong>Local:</strong> ${campanha.local}</p>` : ''}
                        ${campanha.linkUtil ? `<p class="col-span-full"><strong>Link Útil:</strong> <a href="${campanha.linkUtil}" target="_blank" class="text-blue-600 hover:underline">${campanha.linkUtil}</a></p>` : ''}
                    </div>
                    
                    ${campanha.briefing ? `<div><h4 class="font-semibold text-stone-700">Briefing</h4><p class="mt-1 p-3 bg-stone-50 rounded-md text-sm">${campanha.briefing}</p></div>` : ''}
                    
                    ${campanha.estrategia ? `<div><h4 class="font-semibold text-stone-700">Estratégia</h4><p class="mt-1 p-3 bg-stone-50 rounded-md text-sm">${campanha.estrategia}</p></div>` : ''}
                    
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${['admin', 'am', 'marketing'].includes(currentUserRole) ? `
                        <button class="secondary-btn" data-action="edit-campanha" data-id="${campanha.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="events" data-id="${campanha.id}">Apagar</button>
                        ` : ''}
                        <button class="primary-btn" data-action="close-modal">Fechar</button>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function toggleCampanhaFinalizada(campanhaId, finalizada) {
            try {
                const data = { finalizada: finalizada, updatedAt: serverTimestamp() };
                
                if (!db) { 
                    console.warn("Offline mode."); 
                    // Update local events array for immediate UI feedback
                    const campanhaIndex = events.findIndex(c => c.id === campanhaId);
                    if (campanhaIndex !== -1) {
                        events[campanhaIndex].finalizada = finalizada;
                        // Removed auto re-render to fix navigation issues
                    }
                    showSuccessMessage("Sucesso!", `Campanha ${finalizada ? 'marcada como finalizada' : 'desmarcada'} (modo offline).`);
                    return; 
                } else {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/events`, campanhaId), data);
                    showSuccessMessage("Sucesso!", `Campanha ${finalizada ? 'marcada como finalizada' : 'desmarcada'} com sucesso.`);
                }
            } catch (error) {
                console.error("Error updating campanha status:", error);
                showErrorMessage("Erro", "Falha ao atualizar o status da campanha.");
                
                // Revert checkbox state on error
                const checkbox = document.getElementById(`finalizada-${campanhaId}`);
                if (checkbox) {
                    checkbox.checked = !finalizada;
                }
            }
        }



        function openTaskForm(taskId = null) {
            console.log('openTaskForm called', taskId ? `editing task ${taskId}` : 'creating new task');
            clearModalHeaderButtons();
            
            const isEditing = !!taskId;
            const task = isEditing ? tasks.find(t => t.id === taskId) : null;
            
            document.getElementById('form-modal-title').textContent = isEditing ? "Editar Tarefa" : "Adicionar Nova Tarefa";
            
            // Show all collaborators instead of filtering by sectors - more flexible
            const collaboratorOptions = collaborators.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            console.log('Collaborator options:', collaboratorOptions);

            const collaboratorCheckboxes = collaborators.map(c => {
                const isChecked = isEditing && task && task.assignedTo && task.assignedTo.includes(c.name) ? 'checked' : '';
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="collaborator-${c.id || c.name.replace(/\s+/g, '')}" name="assignedTo" value="${c.name}" class="h-4 w-4 rounded text-yellow-500" ${isChecked}>
                        <label for="collaborator-${c.id || c.name.replace(/\s+/g, '')}" class="ml-2 text-sm">${c.name}</label>
                    </div>
                `;
            }).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="task-id" value="${taskId || ''}">
                    <div><label class="font-medium text-sm">Título da Tarefa</label><input type="text" id="task-title" class="form-input" required placeholder="Ex: Revisar material do nível A1" value="${task?.title || ''}"></div>
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="task-description" rows="4" class="form-input" required placeholder="Detalhes sobre a tarefa...">${task?.description || ''}</textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Prazo Final</label><input type="date" id="task-deadline" class="form-input" required value="${task?.deadline || ''}"></div>
                        <div>
                            <label class="font-medium text-sm">Prioridade/Tag</label>
                            <select id="task-priority" class="form-input">
                                <option value="">Sem tag</option>
                                <option value="urgente" ${task?.priority === 'urgente' ? 'selected' : ''}>Urgente</option>
                                <option value="prioridade" ${task?.priority === 'prioridade' ? 'selected' : ''}>Prioridade</option>
                                <option value="curto-prazo" ${task?.priority === 'curto-prazo' ? 'selected' : ''}>Curto Prazo</option>
                                <option value="longo-prazo" ${task?.priority === 'longo-prazo' ? 'selected' : ''}>Longo Prazo</option>
                                <option value="importante" ${task?.priority === 'importante' ? 'selected' : ''}>Importante</option>
                                <option value="rotina" ${task?.priority === 'rotina' ? 'selected' : ''}>Rotina</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="font-medium text-sm mb-3 block">Atribuir para (selecione um ou mais)</label>
                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            ${collaboratorCheckboxes}
                        </div>
                    </div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">${isEditing ? 'Atualizar Tarefa' : 'Salvar Tarefa'}</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveTask;
            document.getElementById('form-modal').classList.add('visible');
            console.log('Task form modal should be visible now');
        }

        function openTaskModal(taskId) {
            clearModalHeaderButtons();
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const deadlineDate = new Date(task.deadline + 'T00:00:00');
            const isOverdue = !task.completed && deadlineDate < new Date();
            const deadlineClass = isOverdue ? 'text-red-600' : 'text-stone-600';
            const formattedDate = formatDateBR(task.deadline);
            
            document.getElementById('form-modal-title').textContent = task.title || 'Tarefa sem título';
            
            const priorityTagsMap = {
                'urgente': { 
                    text: 'Urgente', 
                    class: 'bg-red-100 text-red-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L13.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L10.91 8.26L12 2Z"/></svg>'
                },
                'prioridade': { 
                    text: 'Prioridade', 
                    class: 'bg-yellow-100 text-yellow-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>'
                },
                'curto-prazo': { 
                    text: 'Curto Prazo', 
                    class: 'bg-orange-100 text-orange-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20M12.5 7H11V13L16.25 16.15L17 14.92L12.5 12.25V7Z"/></svg>'
                },
                'longo-prazo': { 
                    text: 'Longo Prazo', 
                    class: 'bg-blue-100 text-blue-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H18V1H16V3H8V1H6V3H5C3.89 3 3.01 3.9 3.01 5L3 19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M19 19H5V8H19V19Z"/></svg>'
                },
                'importante': { 
                    text: 'Importante', 
                    class: 'bg-purple-100 text-purple-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L13.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L10.91 8.26L12 2Z"/></svg>'
                },
                'rotina': { 
                    text: 'Rotina', 
                    class: 'bg-gray-100 text-gray-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/></svg>'
                }
            };
            const priorityTag = task.priority && priorityTagsMap[task.priority] ? 
                `<span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-sm font-medium ${priorityTagsMap[task.priority].class}">${priorityTagsMap[task.priority].icon}${priorityTagsMap[task.priority].text}</span>` : '';

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold text-stone-800 leading-tight mb-2">${task.title || 'Sem título'}</h3>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="status-tag ${task.completed ? 'status-aprovado' : 'status-pendente'}">${task.completed ? 'Concluída' : 'Pendente'}</span>
                            ${isOverdue && !task.completed ? '<span class="status-tag status-rejeitado">Atrasada</span>' : ''}
                            ${priorityTag}
                        </div>
                    </div>
                    
                    <div class="bg-stone-50 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-stone-700 mb-2">Descrição</h4>
                        <p class="text-stone-600 leading-relaxed">${task.description}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <h4 class="font-semibold text-stone-700 mb-2">Atribuída para</h4>
                            <div class="flex flex-wrap gap-1">
                                ${(task.assignedTo || []).map(name => `<span class="user-tag" style="background-color: #e5e7eb; color: #374151;">${name}</span>`).join('')}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-stone-700 mb-2">Prazo</h4>
                            <p class="font-medium ${deadlineClass}">${formattedDate}</p>
                        </div>
                    </div>
                    
                    ${task.assignedBy ? `
                    <div class="text-sm">
                        <h4 class="font-semibold text-stone-700 mb-1">Criada por</h4>
                        <span class="user-tag" style="background-color: #F1D24B; color: #44403c;">${task.assignedBy}</span>
                    </div>
                    ` : ''}
                    
                    <div class="border-t pt-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                       class="h-4 w-4 rounded text-yellow-500"
                                       onchange="toggleTaskCompletion('${task.id}', this.checked)">
                                <span class="text-sm font-medium text-stone-700">Marcar como ${task.completed ? 'pendente' : 'concluída'}</span>
                            </label>
                        </div>
                        <div class="flex gap-2">
                            ${(currentUserRole === 'admin' || task.assignedBy === currentUserName) ? `
                            <button class="secondary-btn" data-action="edit-task" data-id="${task.id}">Editar</button>
                            ` : ''}
                            <button class="primary-btn" data-action="close-modal">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveTask(event) {
            event.preventDefault();
            const taskId = document.getElementById('task-id').value;
            const isEditing = !!taskId;
            const assignedToCheckboxes = Array.from(document.querySelectorAll('input[name="assignedTo"]:checked')).map(cb => cb.value);
            
            const data = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                deadline: document.getElementById('task-deadline').value,
                priority: document.getElementById('task-priority').value,
                assignedTo: assignedToCheckboxes,
                updatedAt: serverTimestamp()
            };
            
            if (!isEditing) {
                data.assignedBy = currentUserName || 'Admin';
                data.createdAt = serverTimestamp();
                data.completed = false;
            }
            
            if (!data.title || !data.description || !data.deadline || data.assignedTo.length === 0) { 
                showErrorMessage("Erro de Validação", "Por favor, preencha todos os campos obrigatórios."); 
                return; 
            }
            
            if (!db) { 
                console.warn("Offline mode."); 
                closeFormModal(); 
                return; 
            }
            
            try {
                if (isEditing) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), data);
                    showSuccessMessage("Sucesso!", "Tarefa atualizada com sucesso.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), data);
                    showSuccessMessage("Sucesso!", "Tarefa adicionada com sucesso.");
                }
                closeFormModal();
            } catch (error) { 
                console.error("Error saving task:", error); 
                showErrorMessage("Erro", "Falha ao salvar a tarefa."); 
            }
        }

        function openCollaboratorForm(collaboratorId = null) {
            clearModalHeaderButtons();
            const collaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;
            document.getElementById('form-modal-title').textContent = collaborator ? "Editar Colaborador" : "Adicionar Novo Colaborador";

            const sectors = ['professor', 'tarefas', 'campanhas'];
            const sectorLabels = { professor: 'Professor (Grade)', tarefas: 'Tarefas', campanhas: 'Campanhas' };

            const sectorCheckboxes = sectors.map(sector => {
                const isChecked = collaborator?.sectors?.includes(sector) ? 'checked' : '';
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="sector-${sector.replace(' ', '-')}" name="sectors" value="${sector}" class="h-4 w-4 rounded" ${isChecked}>
                        <label for="sector-${sector.replace(' ', '-')}" class="ml-2 text-sm">${sectorLabels[sector]}</label>
                    </div>
                `;
            }).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="collaborator-id" value="${collaboratorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Colaborador</label><input type="text" id="collaborator-name" class="form-input" required value="${collaborator?.name || ''}"></div>
                    <div>
                        <label class="font-medium text-sm">Setores de Atuação</label>
                        <div class="mt-2 grid grid-cols-2 gap-2">${sectorCheckboxes}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="font-medium text-sm">Início do Turno</label><input type="time" id="collaborator-shift-start" class="form-input" value="${collaborator?.shiftStart || ''}"></div>
                         <div><label class="font-medium text-sm">Fim do Turno</label><input type="time" id="collaborator-shift-end" class="form-input" value="${collaborator?.shiftEnd || ''}"></div>
                    </div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveCollaborator;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveCollaborator(event) {
            event.preventDefault();
            const collaboratorId = document.getElementById('collaborator-id').value;
            const selectedSectors = Array.from(document.querySelectorAll('input[name="sectors"]:checked')).map(cb => cb.value);

            const data = {
                name: document.getElementById('collaborator-name').value,
                shiftStart: document.getElementById('collaborator-shift-start').value,
                shiftEnd: document.getElementById('collaborator-shift-end').value,
                sectors: selectedSectors
            };

            if (!data.name) { showErrorMessage("Erro", "O nome do colaborador é obrigatório."); return; }
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }

            const oldCollaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;


            try {
                 if (collaboratorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/collaborators`, collaboratorId), data);
                    showSuccessMessage("Sucesso!", "Colaborador atualizado.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/collaborators`), data);
                    showSuccessMessage("Sucesso!", "Colaborador adicionado.");
                }



            } catch (error) { console.error("Error saving collaborator:", error); showErrorMessage("Erro", "Falha ao salvar o colaborador."); }
        }

        function openBreakForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = "Adicionar Break";

            const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const dayOptions = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta"].map(d => `<option value="${d}">${d}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Professor</label><select id="break-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div><label class="font-medium text-sm">Dia da Semana</label><select id="break-day" class="form-input" required>${dayOptions}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Horário de Início</label><input type="time" id="break-start" class="form-input" required></div>
                        <div><label class="font-medium text-sm">Horário de Fim</label><input type="time" id="break-end" class="form-input" required></div>
                    </div>
                    <div id="break-conflict-warning" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 text-red-700">
                        <strong>⚠️ Conflito de horário detectado!</strong>
                        <p>Já existe uma aula ou break agendado para este professor neste horário.</p>
                    </div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Adicionar Break</button></div>
                </form>`;

            // Add conflict checking
            const teacherSelect = document.getElementById('break-teacher');
            const daySelect = document.getElementById('break-day');
            const startInput = document.getElementById('break-start');
            const endInput = document.getElementById('break-end');
            const conflictWarning = document.getElementById('break-conflict-warning');

            function checkBreakConflicts() {
                const teacher = teacherSelect.value;
                const day = daySelect.value;
                const startTime = startInput.value;
                const endTime = endInput.value;

                if (teacher && day && startTime && endTime) {
                    const hasConflict = checkTimeConflict(teacher, day, startTime, endTime);
                    conflictWarning.classList.toggle('hidden', !hasConflict);
                }
            }

            [teacherSelect, daySelect, startInput, endInput].forEach(element => {
                element.addEventListener('change', checkBreakConflicts);
            });

            document.getElementById('form-modal-body').onsubmit = saveBreak;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveBreak(event) {
            event.preventDefault();

            const teacher = document.getElementById('break-teacher').value;
            const day = document.getElementById('break-day').value;
            const startTime = document.getElementById('break-start').value;
            const endTime = document.getElementById('break-end').value;

            // Validate time
            if (startTime >= endTime) {
                showErrorMessage("Erro de Validação", "O horário de início deve ser anterior ao horário de fim.");
                return;
            }

            // Check for conflicts
            const hasConflict = checkTimeConflict(teacher, day, startTime, endTime);
            if (hasConflict) {
                showErrorMessage("Conflito de Horário", "Já existe uma aula ou break agendado para este professor neste horário.");
                return;
            }

            const data = {
                teacher: teacher,
                day: day,
                startTime: startTime,
                endTime: endTime,
                type: 'break',
                student: 'Intervalo',
                level: 'N/A',
                createdAt: serverTimestamp()
            };

            if (!db) { 
                console.warn("Offline mode."); 
                closeFormModal(); 
                return; 
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), data);
                showSuccessMessage("Sucesso!", "Break adicionado à grade.");
                closeFormModal();
            } catch (error) { 
                console.error("Error saving break:", error); 
                showErrorMessage("Erro", "Falha ao salvar o break."); 
            }
        }

        function openScheduleForm(scheduleId = null) {
            clearModalHeaderButtons();
            const schedule = scheduleId ? schedules.find(s => s.id === scheduleId) : null;
            document.getElementById('form-modal-title').textContent = schedule ? "Detalhes da Aula" : "Adicionar Nova Aula";
            const isTeacher = currentUserRole === 'teacher';

            const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}" ${schedule?.teacher === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const dayOptions = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Seg/Qua", "Ter/Qui"].map(d => `<option value="${d}" ${schedule?.day === d ? 'selected' : ''}>${d}</option>`).join('');
            const typeOptions = ["vip", "turma", "break"].map(t => `<option value="${t}" ${schedule?.type === t ? 'selected' : ''}>${t === 'break' ? 'BREAK' : t.toUpperCase()}</option>`).join('');
            const levelOptions = [].map(cp => `<option value="${cp.title}" ${schedule?.level === cp.title ? 'selected' : ''}>${cp.title}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;

            let formHtml = `<form id="form-modal-body" class="space-y-4">
                <input type="hidden" id="schedule-id" value="${scheduleId || ''}">
                <div class="schedule-student-field"><label class="font-medium text-sm">Aluno/Turma</label><input type="text" id="schedule-student" class="form-input" required value="${schedule?.student || ''}" ${isTeacher ? 'disabled' : ''}></div>
                <div class="schedule-level-field">
                    <label class="font-medium text-sm">Nível</label>
                    <select id="schedule-level" class="form-input" required ${isTeacher ? 'disabled' : ''}>${levelOptions}</select>
                    <input type="text" id="schedule-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado" ${isTeacher ? 'disabled' : ''}>
                </div>
                <div><label class="font-medium text-sm">Professor</label><select id="schedule-teacher" class="form-input" required ${isTeacher ? 'disabled' : ''}>${teacherOptions}</select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-medium text-sm">Dia</label><select id="schedule-day" class="form-input" required ${isTeacher ? 'disabled' : ''}>${dayOptions}</select></div>
                    <div><label class="font-medium text-sm">Tipo</label><select id="schedule-type" class="form-input" required ${isTeacher ? 'disabled' : ''}>${typeOptions}</select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-medium text-sm">Início</label><input type="time" id="schedule-start" class="form-input" required value="${schedule?.startTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                    <div><label class="font-medium text-sm">Fim</label><input type="time" id="schedule-end" class="form-input" required value="${schedule?.endTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                </div>
                <div id="conflict-warning" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 text-red-700">
                    <strong>⚠️ Conflito de horário detectado!</strong>
                    <p>Já existe uma aula agendada para este professor neste horário.</p>
                </div>
                ${!isTeacher ? `<div class="pt-4 flex justify-end gap-2">${scheduleId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="schedules" data-id="${scheduleId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>` : ''}
            </form>`;
            document.getElementById('form-modal-content-area').innerHTML = formHtml;

            const levelSelect = document.getElementById('schedule-level');
            const levelCustomInput = document.getElementById('schedule-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });

            // Hide/show fields based on type selection
            function updateFormFields() {
                const type = document.getElementById('schedule-type').value;
                const studentField = document.querySelector('.schedule-student-field');
                const levelField = document.querySelector('.schedule-level-field');
                const studentInput = document.getElementById('schedule-student');
                const levelSelect = document.getElementById('schedule-level');

                if (type === 'break') {
                    studentField.style.display = 'none';
                    levelField.style.display = 'none';
                    studentInput.required = false;
                    levelSelect.required = false;
                } else {
                    studentField.style.display = 'block';
                    levelField.style.display = 'block';
                    studentInput.required = true;
                    levelSelect.required = true;
                }
            }

            // Check for time conflicts
            function checkConflicts() {
                const teacher = document.getElementById('schedule-teacher').value;
                const day = document.getElementById('schedule-day').value;
                const startTime = document.getElementById('schedule-start').value;
                const endTime = document.getElementById('schedule-end').value;
                const scheduleId = document.getElementById('schedule-id').value;
                const warning = document.getElementById('conflict-warning');

                if (teacher && day && startTime && endTime) {
                    const hasConflict = checkTimeConflict(teacher, day, startTime, endTime, scheduleId);
                    if (hasConflict) {
                        warning.classList.remove('hidden');
                    } else {
                        warning.classList.add('hidden');
                    }
                }
            }

            document.getElementById('schedule-type').addEventListener('change', updateFormFields);
            document.getElementById('schedule-teacher').addEventListener('change', checkConflicts);
            document.getElementById('schedule-day').addEventListener('change', checkConflicts);
            document.getElementById('schedule-start').addEventListener('change', checkConflicts);
            document.getElementById('schedule-end').addEventListener('change', checkConflicts);

            updateFormFields();

            document.getElementById('form-modal-body').onsubmit = saveScheduleEntry;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveScheduleEntry(event) {
            event.preventDefault();
            const teacherName = document.getElementById('schedule-teacher').value;
            const startTime = document.getElementById('schedule-start').value;

            const teacher = collaborators.find(c => c.name === teacherName);
            if (teacher && teacher.shiftStart && teacher.shiftEnd) {
                if (startTime < teacher.shiftStart || startTime > teacher.shiftEnd) {
                    showConfirmationModal(
                        "Aviso de Horário", 
                        `Este horário (${startTime}) está fora do turno do professor (${teacher.shiftStart} - ${teacher.shiftEnd}). Tem certeza que quer continuar?`,
                        () => proceedWithSaveSchedule()
                    );
                    return;
                }
            }
            proceedWithSaveSchedule();
        }

        async function proceedWithSaveSchedule() {
            const scheduleId = document.getElementById('schedule-id').value;
            const daySelection = document.getElementById('schedule-day').value;
            const daysToCreate = [];
            if (daySelection === 'Seg/Qua') daysToCreate.push('Segunda', 'Quarta');
            else if (daySelection === 'Ter/Qui') daysToCreate.push('Terça', 'Quinta');
            else daysToCreate.push(daySelection);

            const levelSelect = document.getElementById('schedule-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('schedule-level-custom').value
                : levelSelect.value;

            const scheduleType = document.getElementById('schedule-type').value;
            const baseData = { 
                student: scheduleType === 'break' ? 'Break' : document.getElementById('schedule-student').value, 
                level: scheduleType === 'break' ? 'N/A' : levelValue, 
                teacher: document.getElementById('schedule-teacher').value, 
                type: scheduleType, 
                startTime: document.getElementById('schedule-start').value, 
                endTime: document.getElementById('schedule-end').value 
            };

            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (scheduleId) { 
                    const data = {...baseData, day: daySelection };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/schedules`, scheduleId), data); 
                    showSuccessMessage("Sucesso!", "Aula atualizada.");
                } else { 
                    for (const day of daysToCreate) {
                        const data = {...baseData, day: day, createdAt: serverTimestamp() };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), data); 
                    }
                    showSuccessMessage("Sucesso!", "Aula(s) adicionada(s).");
                }
            } catch (error) { console.error("Error saving schedule:", error); showErrorMessage("Erro", "Falha ao salvar a aula."); }
        }

        function openExpenseForm(expenseId = null) {
            clearModalHeaderButtons();
            const expense = expenseId ? expenses.find(e => e.id === expenseId) : null;
            document.getElementById('form-modal-title').textContent = expense ? "Editar Despesa" : "Adicionar Nova Despesa";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="expense-id" value="${expenseId || ''}">
                    <div><label class="font-medium text-sm">Descrição</label><input type="text" id="expense-description" class="form-input" required value="${expense?.description || ''}"></div>
                    
                    <div>
                        <label class="font-medium text-sm">Tipo de Despesa</label>
                        <select id="expense-tipo" class="form-input" required>
                            <option value="variavel" ${!expense?.tipo || expense?.tipo === 'variavel' ? 'selected' : ''}>Variável</option>
                            <option value="fixo" ${expense?.tipo === 'fixo' ? 'selected' : ''}>Fixo</option>
                        </select>
                    </div>

                    <div id="due-date-container" class="${expense?.isFixedSalary ? 'hidden' : ''}">
                        <label class="font-medium text-sm">Vencimento</label>
                        <input type="date" id="expense-dueDate" class="form-input" value="${expense?.dueDate || ''}">
                    </div>

                    <div id="due-day-container" class="${expense?.isFixedSalary ? '' : 'hidden'}">
                        <label class="font-medium text-sm">Dia do Vencimento</label>
                        <input type="number" min="1" max="31" id="expense-dueDay" class="form-input" value="${expense?.dueDay || ''}">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Valor Base (R$)</label><input type="number" step="0.01" id="expense-amount" class="form-input" required value="${expense?.amount || ''}"></div>
                        <div><label class="font-medium text-sm">Valor Extra (R$)</label><input type="number" step="0.01" id="expense-extraAmount" class="form-input" value="${expense?.extraAmount || ''}"></div>
                        <div><label class="font-medium text-sm">Valor Pago (R$)</label><input type="number" step="0.01" id="expense-paidAmount" class="form-input" value="${expense?.paidAmount || ''}"></div>
                    </div>

                    <div class="flex items-center gap-2"><input type="checkbox" id="expense-isFixedSalary" class="h-4 w-4 rounded" ${expense?.isFixedSalary ? 'checked' : ''}><label for="expense-isFixedSalary" class="text-sm">É salário fixo?</label></div>
                    <div id="employee-role-container" class="${expense?.isFixedSalary ? '' : 'hidden'}"><label class="font-medium text-sm">Cargo</label><input type="text" id="expense-employeeRole" class="form-input" value="${expense?.employeeRole || ''}"></div>
                    <div class="pt-4 flex justify-end gap-2">${expenseId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="expenses" data-id="${expenseId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;

            const isFixedSalaryCheckbox = document.getElementById('expense-isFixedSalary');
            isFixedSalaryCheckbox.onchange = () => {
                const isChecked = isFixedSalaryCheckbox.checked;
                document.getElementById('employee-role-container').classList.toggle('hidden', !isChecked);
                document.getElementById('due-date-container').classList.toggle('hidden', isChecked);
                document.getElementById('due-day-container').classList.toggle('hidden', !isChecked);
            };

            document.getElementById('form-modal-body').onsubmit = saveExpense;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveExpense(event) {
            event.preventDefault();
            const expenseId = document.getElementById('expense-id').value;
            const isFixedSalary = document.getElementById('expense-isFixedSalary').checked;
            const data = {
                description: document.getElementById('expense-description').value,
                tipo: document.getElementById('expense-tipo').value,
                amount: document.getElementById('expense-amount').value,
                extraAmount: document.getElementById('expense-extraAmount').value || 0,
                paidAmount: document.getElementById('expense-paidAmount').value || 0,
                isPaid: false,
                isFixedSalary: isFixedSalary,
                employeeRole: isFixedSalary ? document.getElementById('expense-employeeRole').value : '',
            };

            if (isFixedSalary) {
                data.dueDay = document.getElementById('expense-dueDay').value;
                data.dueDate = null;
            } else {
                data.dueDate = document.getElementById('expense-dueDate').value;
                data.dueDay = null;
            }

            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (expenseId) {
                    const existingExpense = expenses.find(e => e.id === expenseId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/expenses`, expenseId), {...existingExpense, ...data});
                    showSuccessMessage("Sucesso!", "Despesa atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/expenses`), data);
                    showSuccessMessage("Sucesso!", "Nova despesa adicionada.");
                }
            } catch (error) { console.error("Error saving expense:", error); showErrorMessage("Erro", "Falha ao salvar despesa."); }
        }
        async function toggleExpensePaid(expenseId, isPaid) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            if (isPaid) {
                // Quando marcado como pago, abrir modal para inserir valor pago
                const totalExpenseValue = Number(expense.amount) + Number(expense.extraAmount || 0);
                clearModalHeaderButtons();
                const modalTitle = document.getElementById('form-modal-title');
                const modalContentArea = document.getElementById('form-modal-content-area');

                modalTitle.textContent = "Registrar Pagamento";
                modalContentArea.innerHTML = `
                    <form id="payment-form" class="space-y-4">
                        <p class="text-stone-600">Despesa: <strong>${expense.description}</strong></p>
                        <p class="text-stone-600">Valor Total: <strong>${totalExpenseValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></p>
                        <div>
                            <label class="font-medium text-sm">Valor Pago (R$)</label>
                            <input type="number" step="0.01" id="paid-amount" class="form-input" placeholder="0,00" value="${totalExpenseValue}" required>
                        </div>
                        <div class="text-right">
                            <button type="button" class="secondary-btn mr-2" data-action="close-modal">Cancelar</button>
                            <button type="submit" class="primary-btn w-auto">Confirmar Pagamento</button>
                        </div>
                    </form>
                `;

                document.getElementById('form-modal').classList.add('visible');
                document.getElementById('payment-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const paidAmount = document.getElementById('paid-amount').value;
                    
                    if (!db) {
                        // Modo desenvolvimento - atualizar localmente
                        const expenseIndex = expenses.findIndex(e => e.id === expenseId);
                        if (expenseIndex !== -1) {
                            expenses[expenseIndex].isPaid = true;
                            expenses[expenseIndex].paidAmount = Number(paidAmount);
                        }
                        renderFolhaPagamentoSection();
                        document.getElementById('form-modal').classList.remove('visible');
                        return;
                    }

                    try {
                        const expenseRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId);
                        await updateDoc(expenseRef, { 
                            isPaid: true,
                            paidAmount: Number(paidAmount),
                            paidAt: new Date().toISOString()
                        });
                        document.getElementById('form-modal').classList.remove('visible');
                        showSuccessMessage("Pagamento Registrado", "Valor pago registrado com sucesso!");
                    } catch (error) {
                        console.error("Error updating expense payment:", error);
                        showErrorMessage("Erro", "Erro ao registrar pagamento: " + error.message);
                    }
                });
            } else {
                // Quando desmarcado, remover pagamento
                if (!db) {
                    // Modo desenvolvimento - atualizar localmente
                    const expenseIndex = expenses.findIndex(e => e.id === expenseId);
                    if (expenseIndex !== -1) {
                        expenses[expenseIndex].isPaid = false;
                        delete expenses[expenseIndex].paidAmount;
                        delete expenses[expenseIndex].paidAt;
                    }
                    renderFolhaPagamentoSection();
                    return;
                }

                try {
                    const expenseRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId);
                    await updateDoc(expenseRef, { 
                        isPaid: false,
                        paidAmount: 0,
                        paidAt: null
                    });
                } catch (error) {
                    console.error("Error updating expense status:", error);
                }
            }
        }

        function openCancelamentoForm(cancelamentoId = null) {
            clearModalHeaderButtons();
            const cancelamento = cancelamentoId ? cancellations.find(c => c.id === cancelamentoId) : null;
            const collaboratorOptions = collaborators.filter(c => c.sectors && c.sectors.includes('cancelamentos')).map(c => `<option value="${c.name}" ${cancelamento?.processedBy === c.name ? 'selected' : ''}>${c.name}</option>`).join('');

            let studentFieldHtml = '';
            if (cancelamentoId) {
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno</label><p class="form-input bg-stone-100">${cancelamento.studentName}</p></div>`;
            } else {
                const activeStudents = students.filter(s => s.status === 'Ativo');
                const studentOptions = activeStudents.map(s => `<option value="${s.id}" data-name="${s.name}">${s.name}</option>`).join('');
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno a Cancelar</label><select id="cancelamento-studentId" class="form-input" required><option value="">Selecione um aluno...</option>${studentOptions}</select></div>`;
            }

            document.getElementById('form-modal-title').textContent = cancelamento ? "Editar Cancelamento" : "Registrar Novo Cancelamento";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="cancelamento-id" value="${cancelamentoId || ''}">
                    ${studentFieldHtml}
                    <div><label class="font-medium text-sm">Data do Cancelamento</label><input type="date" id="cancelamento-date" class="form-input" required value="${cancelamento?.cancellationDate || ''}"></div>
                    <div><label class="font-medium text-sm">Motivo</label><textarea id="cancelamento-reason" rows="3" class="form-input" required>${cancelamento?.reason || ''}</textarea></div>
                    <div><label class="font-medium text-sm">Processado por</label><select id="cancelamento-processedBy" class="form-input" required>${collaboratorOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveCancelamento;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveCancelamento(event) {
            event.preventDefault();
            const cancelamentoId = document.getElementById('cancelamento-id').value;
            if (!db) { console.warn("Offline mode."); return; }

            try {
                if (cancelamentoId) {
                    // Logic to update an existing cancellation record
                    const data = {
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                    };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/cancellations`, cancelamentoId), data);
                    showSuccessMessage("Sucesso!", "Registro de cancelamento atualizado.");
                } else {
                    // Logic to create a new cancellation and update student status
                    const studentSelect = document.getElementById('cancelamento-studentId');
                    if (!studentSelect.value) {
                        showErrorMessage("Erro", "Por favor, selecione um aluno.");
                        return;
                    }
                    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
                    const studentId = selectedOption.value;
                    const studentName = selectedOption.getAttribute('data-name');

                    const data = {
                        studentId: studentId,
                        studentName: studentName,
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                        createdAt: serverTimestamp()
                    };

                    // 1. Add cancellation record
                    await addDoc(collection(db, `artifacts/${appId}/public/data/cancellations`), data);

                    // 2. Update student status
                    const studentRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
                    await updateDoc(studentRef, { status: 'Cancelado' });

                    showSuccessMessage("Sucesso!", `Cancelamento registrado e status do aluno ${studentName} atualizado.`);
                }
            } catch (error) {
                console.error("Error saving cancellation:", error);
                showErrorMessage("Erro", "Falha ao salvar o cancelamento.");
            }
        }
        function openCancelamentoModal(cancelamentoId) {
            clearModalHeaderButtons();
            const cancelamento = cancellations.find(c => c.id === cancelamentoId);
            if (!cancelamento) return;
            const canEdit = ['admin', 'financeiro'].includes(currentUserRole);
            document.getElementById('form-modal-title').textContent = `Cancelamento de ${cancelamento.studentName}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Aluno:</strong> ${cancelamento.studentName}</p>
                    <p><strong>Data:</strong> ${formatDateBR(cancelamento.cancellationDate)}</p>
                    <p><strong>Processado por:</strong> ${cancelamento.processedBy}</p>
                    <div><strong>Motivo:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${cancelamento.reason}</p></div>
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEdit ? `<button class="secondary-btn" data-action="edit-cancelamento" data-id="${cancelamento.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="cancellations" data-id="${cancelamento.id}">Apagar</button>` : ''}
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }






        // Dojo Functions


        function openDojoCompetitorForm(competitorId = null) {
            clearModalHeaderButtons();
            const competitor = competitorId ? dojoRanking.find(c => c.id === competitorId) : null;
            document.getElementById('form-modal-title').textContent = competitor ? 'Editar Competidor' : 'Adicionar Competidor';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Competidor</label><input type="text" id="dojo-name" class="form-input" required value="${competitor?.name || ''}"></div>
                    <div><label class="font-medium text-sm">URL da Foto</label><input type="url" id="dojo-photo" class="form-input" required value="${competitor?.photo || ''}"></div>
                    <div><label class="font-medium text-sm">Superpower (tag roxa divertida)</label><input type="text" id="dojo-superpower" class="form-input" placeholder="Ex: Master do Coffee, Ninja das Planilhas..." value="${competitor?.superpower || ''}"></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor?.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoCompetitor;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoCompetitor(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const data = {
                name: document.getElementById('dojo-name').value,
                photo: document.getElementById('dojo-photo').value,
                superpower: document.getElementById('dojo-superpower').value,
                points: Number(document.getElementById('dojo-points').value)
            };
            if (!data.name || !data.photo) { showErrorMessage("Erro", "Nome e foto são obrigatórios."); return; }
            try {
                if (competitorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), data);
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_ranking`), data);
                }
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso", "Competidor do Dojo salvo.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar o competidor."); }
        }

        function openDojoPointsForm(competitorId) {
            clearModalHeaderButtons();
            const competitor = dojoRanking.find(c => c.id === competitorId);
            if (!competitor) return;
            document.getElementById('form-modal-title').textContent = `Editar Pontos de ${competitor.name}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId}">
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Pontos</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoPoints;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoPoints(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const points = Number(document.getElementById('dojo-points').value);
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), { points });
                showSuccessMessage("Sucesso", "Pontuação atualizada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível atualizar a pontuação."); }
        }

        function openDojoMissionForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = 'Adicionar Nova Missão';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Descrição da Missão</label><input type="text" id="mission-description" class="form-input" required></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="mission-points" class="form-input" required value="0"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Missão</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoMission;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoMission(event) {
            event.preventDefault();
            const data = {
                description: document.getElementById('mission-description').value,
                points: Number(document.getElementById('mission-points').value)
            };
            if (!data.description) { showErrorMessage("Erro", "A descrição é obrigatória."); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_missions`), data);
                showSuccessMessage("Sucesso", "Nova missão do Dojo adicionada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar a missão."); }
        }


        async function toggleTaskCompletion(taskId, isCompleted) { if (!db) return; const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId); try { await updateDoc(taskRef, { completed: isCompleted }); } catch (error) { console.error("Error updating task status:", error); } }

        async function deleteItem(collectionName, itemId) {
            if (!db) { console.warn("Offline mode."); return; }
            showConfirmationModal(
                "Confirmar Exclusão",
                "Tem certeza que deseja apagar este item? Esta ação não pode ser desfeita.",
                async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, itemId));
                        showSuccessMessage("Sucesso", "Item apagado com sucesso.");
                        closeFormModal();
                    } catch (error) { 
                        console.error(`Error deleting item from ${collectionName}:`, error); 
                        showErrorMessage("Erro", "Falha ao apagar o item.");
                    }
                }
            );
        }

        // --- EXPORT FUNCTIONS ---
        function openHtmlInNewWindow(title, htmlContent) {
            const newWindow = window.open();
            newWindow.document.write(htmlContent);
            newWindow.document.title = title;
            newWindow.document.close();
        }



        function exportVipPef(vipId) {
            const vip = vips.find(v => v.id === vipId);
            const student = students.find(s => s.id === vip.studentId);
            const unitAttendance = attendance.find(a => a.id === vipId);
            if (!vip || !student) {
                showErrorMessage("Erro", "Não foi possível encontrar os dados para exportação.");
                return;
            }

            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presença Parcial', '': 'Não Registrado' };
            let lessonsHtml = '';

            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};
                const studentStatus = lessonData.students?.[student.id] || '';
                
                const statusBadgeClass = studentStatus === 'P' ? 'status-presente' : 
                                       studentStatus === 'F' ? 'status-falta' : 
                                       studentStatus === 'PP' ? 'status-parcial' : 'status-nao-registrado';
                const statusText = statusMap[studentStatus];

                lessonsHtml += `
                    <div class="lesson-card">
                        <div class="lesson-header">
                            <div class="lesson-number">Aula ${i}</div>
                            <div class="lesson-date">${lessonData.date || 'Data não informada'}</div>
                        </div>
                        <div class="lesson-content">
                            <div class="topic-section">
                                <strong>Tema:</strong> ${lessonData.topic || 'Não informado'}
                            </div>
                            <div class="status-section">
                                <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                            </div>
                            ${lessonData.notes ? `<div class="notes-section"><strong>Observações:</strong> ${lessonData.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>PEF - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            line-height: 1.6; 
                            color: #333; 
                            background-color: #f8f9fa;
                        }
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            min-height: 100vh;
                        }
                        .header {
                            background: linear-gradient(135deg, #F1D24B 0%, #E8C547 100%);
                            color: #333;
                            padding: 2rem;
                            text-align: center;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .header h1 {
                            font-size: 2rem;
                            font-weight: 700;
                            margin-bottom: 0.5rem;
                        }
                        .header p {
                            font-size: 1.1rem;
                            opacity: 0.8;
                        }
                        .info-card {
                            background: white;
                            margin: 2rem;
                            padding: 2rem;
                            border-radius: 12px;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                            border-left: 4px solid #F1D24B;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 1rem;
                        }
                        .info-item {
                            padding: 0.5rem 0;
                        }
                        .info-item strong {
                            color: #2c3e50;
                            display: block;
                            margin-bottom: 0.25rem;
                            font-weight: 600;
                        }
                        .info-value {
                            color: #555;
                            font-size: 1.1rem;
                        }
                        .content {
                            padding: 0 2rem 2rem;
                        }
                        .lesson-card {
                            background: white;
                            border: 1px solid #e9ecef;
                            border-radius: 10px;
                            margin-bottom: 1rem;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                            transition: all 0.3s ease;
                        }
                        .lesson-card:hover {
                            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                            transform: translateY(-2px);
                        }
                        .lesson-header {
                            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                            padding: 1rem;
                            border-bottom: 1px solid #dee2e6;
                            border-radius: 10px 10px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .lesson-number {
                            font-weight: 700;
                            color: #495057;
                            font-size: 1.1rem;
                        }
                        .lesson-date {
                            color: #6c757d;
                            font-size: 0.95rem;
                        }
                        .lesson-content {
                            padding: 1rem;
                        }
                        .topic-section, .notes-section {
                            margin-bottom: 0.75rem;
                        }
                        .topic-section strong, .notes-section strong {
                            color: #2c3e50;
                            margin-right: 0.5rem;
                        }
                        .status-section {
                            margin-top: 1rem;
                        }
                        .status-badge {
                            display: inline-block;
                            padding: 0.4rem 1rem;
                            border-radius: 25px;
                            font-size: 0.85rem;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        .status-presente {
                            background-color: #d4edda;
                            color: #155724;
                            border: 1px solid #c3e6cb;
                        }
                        .status-falta {
                            background-color: #f8d7da;
                            color: #721c24;
                            border: 1px solid #f5c6cb;
                        }
                        .status-parcial {
                            background-color: #fff3cd;
                            color: #856404;
                            border: 1px solid #ffeaa7;
                        }
                        .status-nao-registrado {
                            background-color: #e2e3e5;
                            color: #383d41;
                            border: 1px solid #d6d8db;
                        }
                        .footer {
                            text-align: center;
                            padding: 2rem;
                            color: #6c757d;
                            border-top: 1px solid #e9ecef;
                            margin-top: 2rem;
                        }
                        @media print {
                            body { background-color: white; }
                            .lesson-card { break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>PEF - Relatório Individual</h1>
                            <p>Sistema de Presença e Frequência</p>
                        </div>
                        
                        <div class="info-card">
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>Aluno</strong>
                                    <div class="info-value">${student.name}</div>
                                </div>
                                <div class="info-item">
                                    <strong>Professor</strong>
                                    <div class="info-value">${vip.teacherName}</div>
                                </div>
                                <div class="info-item">
                                    <strong>Nível</strong>
                                    <div class="info-value">${vip.level}</div>
                                </div>
                                <div class="info-item">
                                    <strong>Modalidade</strong>
                                    <div class="info-value">VIP</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content">
                            ${lessonsHtml}
                        </div>
                        
                        <div class="footer">
                            <p>Relatório gerado automaticamente pelo SLAP Hub</p>
                            <p>${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`PEF - ${student.name}`, docHtml);
        }

        function exportTurmaPef(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma não encontrada."); return; }

            const turmaStudents = (turma.studentIds || []).map(id => students.find(s => s.id === id)).filter(Boolean);
            const unitAttendance = attendance.find(a => a.id === turmaId);
            if (!turmaStudents.length) { showErrorMessage("Erro", "Nenhum aluno na turma para exportar."); return; }

            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presença Parcial', '': 'Não Registrado' };
            let lessonsHtml = '';

            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};


                const attendanceItemsHtml = turmaStudents.map(s => {
                    const status = lessonData?.students?.[s.id] || '';
                    const statusClass = status === 'P' ? 'presente' : 
                                       status === 'F' ? 'falta' : 
                                       status === 'PP' ? 'parcial' : 'nao-registrado';
                    const statusText = statusMap[status];
                    const statusBadgeClass = status === 'P' ? 'status-presente' : 
                                           status === 'F' ? 'status-falta' : 
                                           status === 'PP' ? 'status-parcial' : 'status-nao-registrado';
                    
                    return `
                        <li class="attendance-item ${statusClass}">
                            <span class="student-name">${s.name}</span>
                            <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                        </li>
                    `;
                }).join('');

                lessonsHtml += `
                    <div class="lesson-block">
                        <div class="lesson-header">Aula ${i}</div>
                        <div class="lesson-info">
                            <div class="lesson-detail">
                                <span class="lesson-detail-label">Data da Aula</span>
                                <span class="lesson-detail-value">${lessonData.date || 'Não definida'}</span>
                            </div>
                            <div class="lesson-detail">
                                <span class="lesson-detail-label">Status</span>
                                <span class="lesson-detail-value">${lessonData.date ? 'Realizada' : 'Pendente'}</span>
                            </div>
                        </div>
                        <div class="lesson-detail" style="margin-bottom: 15px;">
                            <span class="lesson-detail-label">Tema da Aula</span>
                            <span class="lesson-detail-value">${lessonData.topic || 'Não especificado'}</span>
                        </div>
                        <div class="lesson-detail" style="margin-bottom: 20px;">
                            <span class="lesson-detail-label">Observações</span>
                            <span class="lesson-detail-value">${lessonData.notes || 'Nenhuma observação registrada'}</span>
                        </div>
                        <div class="attendance-section">
                            <div class="attendance-title">
                                <div class="attendance-icon">✓</div>
                                Registro de Presença
                            </div>
                            <ul class="attendance-list">${attendanceItemsHtml}</ul>
                        </div>
                    </div>
                `;
            }

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>PEF - ${turma.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        body { 
                            font-family: 'DM Sans', Arial, sans-serif; 
                            line-height: 1.6; 
                            color: #2d3748; 
                            background: #f7fafc;
                            padding: 40px 20px;
                        }
                        
                        .container {
                            max-width: 1000px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                            overflow: hidden;
                        }
                        
                        .header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 40px;
                            text-align: center;
                            position: relative;
                        }
                        
                        .header::after {
                            content: '';
                            position: absolute;
                            bottom: -10px;
                            left: 0;
                            right: 0;
                            height: 20px;
                            background: #F1D24B;
                            clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);
                        }
                        
                        .logo-section {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 20px;
                        }
                        
                        .logo {
                            width: 60px;
                            height: 60px;
                            background: white;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 15px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        }
                        
                        .logo-text {
                            font-size: 24px;
                            font-weight: 700;
                            color: #F1D24B;
                            letter-spacing: 1px;
                        }
                        
                        .school-name {
                            font-size: 2.5em;
                            font-weight: 700;
                            margin-bottom: 10px;
                            letter-spacing: -0.02em;
                        }
                        
                        .document-title {
                            font-size: 1.5em;
                            font-weight: 600;
                            opacity: 0.9;
                            letter-spacing: 0.05em;
                        }
                        
                        .content {
                            padding: 40px;
                        }
                        
                        .info-section {
                            background: #f8f9fa;
                            border-left: 4px solid #F1D24B;
                            padding: 25px;
                            margin-bottom: 30px;
                            border-radius: 8px;
                        }
                        
                        .info-section h2 {
                            color: #1a202c;
                            font-size: 1.4em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        }
                        
                        .info-item {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        
                        .info-label {
                            color: #4a5568;
                            font-weight: 500;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .info-value {
                            color: #1a202c;
                            font-weight: 600;
                            font-size: 1.1em;
                        }
                        
                        .lessons-container {
                            margin-top: 30px;
                        }
                        
                        .lessons-title {
                            font-size: 1.8em;
                            font-weight: 700;
                            color: #1a202c;
                            margin-bottom: 25px;
                            text-align: center;
                            position: relative;
                        }
                        
                        .lessons-title::after {
                            content: '';
                            position: absolute;
                            bottom: -5px;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 60px;
                            height: 3px;
                            background: #F1D24B;
                            border-radius: 2px;
                        }
                        
                        .lesson-block {
                            background: white;
                            border: 1px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 25px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                            transition: box-shadow 0.3s ease;
                        }
                        
                        .lesson-block:hover {
                            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                        }
                        
                        .lesson-header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 15px 20px;
                            border-radius: 8px;
                            margin: -10px -10px 20px -10px;
                            font-weight: 700;
                            font-size: 1.2em;
                        }
                        
                        .lesson-info {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        
                        .lesson-detail {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        
                        .lesson-detail-label {
                            color: #4a5568;
                            font-weight: 500;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .lesson-detail-value {
                            color: #1a202c;
                            font-weight: 600;
                            background: #f8f9fa;
                            padding: 8px 12px;
                            border-radius: 6px;
                            border-left: 3px solid #F1D24B;
                        }
                        
                        .attendance-section {
                            margin-top: 20px;
                        }
                        
                        .attendance-title {
                            color: #1a202c;
                            font-weight: 600;
                            margin-bottom: 15px;
                            font-size: 1.1em;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        
                        .attendance-icon {
                            width: 20px;
                            height: 20px;
                            background: #F1D24B;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #1a202c;
                            font-weight: 700;
                            font-size: 0.8em;
                        }
                        
                        .attendance-list {
                            list-style: none;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 10px;
                            padding: 0;
                        }
                        
                        .attendance-item {
                            background: #f8f9fa;
                            padding: 12px 16px;
                            border-radius: 8px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            border-left: 3px solid transparent;
                        }
                        
                        .attendance-item.presente {
                            border-left-color: #38a169;
                            background: #f0fff4;
                        }
                        
                        .attendance-item.falta {
                            border-left-color: #e53e3e;
                            background: #fff5f5;
                        }
                        
                        .attendance-item.parcial {
                            border-left-color: #dd6b20;
                            background: #fffaf0;
                        }
                        
                        .attendance-item.nao-registrado {
                            border-left-color: #a0aec0;
                            background: #f7fafc;
                        }
                        
                        .student-name {
                            font-weight: 600;
                            color: #1a202c;
                        }
                        
                        .status-badge {
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.8em;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .status-presente {
                            background: #c6f6d5;
                            color: #22543d;
                        }
                        
                        .status-falta {
                            background: #fed7d7;
                            color: #742a2a;
                        }
                        
                        .status-parcial {
                            background: #feebc8;
                            color: #7b341e;
                        }
                        
                        .status-nao-registrado {
                            background: #e2e8f0;
                            color: #2d3748;
                        }
                        
                        .footer {
                            background: #1a202c;
                            color: white;
                            text-align: center;
                            padding: 25px;
                            margin-top: 40px;
                        }
                        
                        .footer-title {
                            font-size: 1.2em;
                            font-weight: 600;
                            margin-bottom: 5px;
                        }
                        
                        .footer-date {
                            color: #a0aec0;
                            font-size: 0.9em;
                        }
                        
                        .print-btn {
                            background: #F1D24B;
                            color: #1a202c;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 1em;
                            margin: 20px auto;
                            display: block;
                            transition: all 0.3s ease;
                        }
                        
                        .print-btn:hover {
                            background: #eab308;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .container { box-shadow: none; }
                            .print-btn { display: none; }
                        }
                        
                        @media (max-width: 768px) {
                            .info-grid { grid-template-columns: 1fr; }
                            .lesson-info { grid-template-columns: 1fr; }
                            .attendance-list { grid-template-columns: 1fr; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <div class="logo-text">S</div>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                </div>
                            </div>
                            <div class="document-title">Relatório de Presença e Frequência (PEF)</div>
                        </div>
                        
                        <div class="content">
                            <div class="info-section">
                                <h2>Informações da Turma</h2>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Turma</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Professor</span>
                                        <span class="info-value">${turma.teacherName || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nível</span>
                                        <span class="info-value">${turma.level || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Semestre</span>
                                        <span class="info-value">${turma.semestre || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Data do Relatório</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Total de Alunos</span>
                                        <span class="info-value">${turmaStudents.length}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lessons-container">
                                <h2 class="lessons-title">Registro de Aulas</h2>
                                ${lessonsHtml}
                            </div>
                            
                            <button class="print-btn" onclick="window.print()">🖨️ Imprimir Relatório</button>
                        </div>
                        
                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Relatório gerado em ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`PEF - Turma ${turma.name}`, docHtml);
        }

        function exportStudentPef(turmaId, studentId) {
            const turma = turmas.find(t => t.id === turmaId);
            const student = students.find(s => s.id === studentId);
            if (!turma || !student) { 
                showErrorMessage("Erro", "Turma ou aluno não encontrado."); 
                return; 
            }

            const unitAttendance = attendance.find(a => a.id === turmaId);
            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presença Parcial', '': 'Não Registrado' };
            
            let lessonsHtml = '';
            let totalLessons = 0;
            let presentLessons = 0;
            let partialLessons = 0;
            let absentLessons = 0;

            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};
                const studentStatus = lessonData?.students?.[studentId] || '';
                
                // Contar presenças apenas se a aula foi realizada
                if (lessonData.date) {
                    totalLessons++;
                    if (studentStatus === 'P') presentLessons++;
                    else if (studentStatus === 'PP') partialLessons++;
                    else if (studentStatus === 'F') absentLessons++;
                }

                const statusClass = studentStatus === 'P' ? 'presente' : 
                                   studentStatus === 'F' ? 'falta' : 
                                   studentStatus === 'PP' ? 'parcial' : 'nao-registrado';
                const statusText = statusMap[studentStatus];
                const statusBadgeClass = studentStatus === 'P' ? 'status-presente' : 
                                       studentStatus === 'F' ? 'status-falta' : 
                                       studentStatus === 'PP' ? 'status-parcial' : 'status-nao-registrado';

                lessonsHtml += `
                    <div class="lesson-block">
                        <div class="lesson-header">Aula ${i}</div>
                        <div class="lesson-info">
                            <div class="lesson-detail">
                                <span class="lesson-detail-label">Data da Aula</span>
                                <span class="lesson-detail-value">${lessonData.date || 'Não realizada'}</span>
                            </div>
                            <div class="lesson-detail">
                                <span class="lesson-detail-label">Status do Aluno</span>
                                <span class="lesson-detail-value">
                                    <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                                </span>
                            </div>
                        </div>
                        <div class="lesson-detail" style="margin-bottom: 15px;">
                            <span class="lesson-detail-label">Tema da Aula</span>
                            <span class="lesson-detail-value">${lessonData.topic || 'Não especificado'}</span>
                        </div>
                        <div class="lesson-detail">
                            <span class="lesson-detail-label">Observações da Aula</span>
                            <span class="lesson-detail-value">${lessonData.notes || 'Nenhuma observação registrada'}</span>
                        </div>
                    </div>
                `;
            }

            const attendancePercentage = totalLessons > 0 ? ((presentLessons + partialLessons * 0.5) / totalLessons * 100).toFixed(1) : 0;

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>PEF Individual - ${student.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        body { 
                            font-family: 'DM Sans', Arial, sans-serif; 
                            line-height: 1.6; 
                            color: #2d3748; 
                            background: #f7fafc;
                            padding: 40px 20px;
                        }
                        
                        .container {
                            max-width: 1000px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                            overflow: hidden;
                        }
                        
                        .header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 40px;
                            text-align: center;
                            position: relative;
                        }
                        
                        .header::after {
                            content: '';
                            position: absolute;
                            bottom: -10px;
                            left: 0;
                            right: 0;
                            height: 20px;
                            background: #F1D24B;
                            clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);
                        }
                        
                        .logo-section {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 20px;
                        }
                        
                        .logo {
                            width: 60px;
                            height: 60px;
                            background: white;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 15px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        }
                        
                        .logo-text {
                            font-size: 24px;
                            font-weight: 700;
                            color: #F1D24B;
                            letter-spacing: 1px;
                        }
                        
                        .school-name {
                            font-size: 2.5em;
                            font-weight: 700;
                            margin-bottom: 10px;
                            letter-spacing: -0.02em;
                        }
                        
                        .document-title {
                            font-size: 1.5em;
                            font-weight: 600;
                            opacity: 0.9;
                            letter-spacing: 0.05em;
                        }
                        
                        .student-title {
                            font-size: 1.8em;
                            font-weight: 700;
                            margin-top: 15px;
                            color: #1a202c;
                        }
                        
                        .content {
                            padding: 40px;
                        }
                        
                        .info-section {
                            background: #f8f9fa;
                            border-left: 4px solid #F1D24B;
                            padding: 25px;
                            margin-bottom: 30px;
                            border-radius: 8px;
                        }
                        
                        .info-section h2 {
                            color: #1a202c;
                            font-size: 1.4em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        }
                        
                        .info-item {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        
                        .info-label {
                            color: #4a5568;
                            font-weight: 500;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .info-value {
                            color: #1a202c;
                            font-weight: 600;
                            font-size: 1.1em;
                        }
                        
                        .attendance-summary {
                            background: #e6fffa;
                            border-left: 4px solid #38a169;
                            padding: 25px;
                            margin-bottom: 30px;
                            border-radius: 8px;
                        }
                        
                        .attendance-summary h2 {
                            color: #1a202c;
                            font-size: 1.4em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        
                        .attendance-stats {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            gap: 15px;
                        }
                        
                        .stat-item {
                            text-align: center;
                            background: white;
                            padding: 15px;
                            border-radius: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        }
                        
                        .stat-number {
                            font-size: 2em;
                            font-weight: 700;
                            display: block;
                        }
                        
                        .stat-number.presente { color: #38a169; }
                        .stat-number.parcial { color: #dd6b20; }
                        .stat-number.falta { color: #e53e3e; }
                        .stat-number.percentage { color: #1a202c; }
                        
                        .stat-label {
                            color: #4a5568;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-top: 5px;
                        }
                        
                        .lessons-container {
                            margin-top: 30px;
                        }
                        
                        .lessons-title {
                            font-size: 1.8em;
                            font-weight: 700;
                            color: #1a202c;
                            margin-bottom: 25px;
                            text-align: center;
                            position: relative;
                        }
                        
                        .lessons-title::after {
                            content: '';
                            position: absolute;
                            bottom: -5px;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 60px;
                            height: 3px;
                            background: #F1D24B;
                            border-radius: 2px;
                        }
                        
                        .lesson-block {
                            background: white;
                            border: 1px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 25px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                            transition: box-shadow 0.3s ease;
                        }
                        
                        .lesson-block:hover {
                            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                        }
                        
                        .lesson-header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 15px 20px;
                            border-radius: 8px;
                            margin: -10px -10px 20px -10px;
                            font-weight: 700;
                            font-size: 1.2em;
                        }
                        
                        .lesson-info {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        
                        .lesson-detail {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        
                        .lesson-detail-label {
                            color: #4a5568;
                            font-weight: 500;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .lesson-detail-value {
                            color: #1a202c;
                            font-weight: 600;
                            background: #f8f9fa;
                            padding: 8px 12px;
                            border-radius: 6px;
                            border-left: 3px solid #F1D24B;
                        }
                        
                        .status-badge {
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.8em;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            display: inline-block;
                        }
                        
                        .status-presente {
                            background: #c6f6d5;
                            color: #22543d;
                        }
                        
                        .status-falta {
                            background: #fed7d7;
                            color: #742a2a;
                        }
                        
                        .status-parcial {
                            background: #feebc8;
                            color: #7b341e;
                        }
                        
                        .status-nao-registrado {
                            background: #e2e8f0;
                            color: #2d3748;
                        }
                        
                        .footer {
                            background: #1a202c;
                            color: white;
                            text-align: center;
                            padding: 25px;
                            margin-top: 40px;
                        }
                        
                        .footer-title {
                            font-size: 1.2em;
                            font-weight: 600;
                            margin-bottom: 5px;
                        }
                        
                        .footer-date {
                            color: #a0aec0;
                            font-size: 0.9em;
                        }
                        
                        .print-btn {
                            background: #F1D24B;
                            color: #1a202c;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 1em;
                            margin: 20px auto;
                            display: block;
                            transition: all 0.3s ease;
                        }
                        
                        .print-btn:hover {
                            background: #eab308;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .container { box-shadow: none; }
                            .print-btn { display: none; }
                        }
                        
                        @media (max-width: 768px) {
                            .info-grid { grid-template-columns: 1fr; }
                            .lesson-info { grid-template-columns: 1fr; }
                            .attendance-stats { grid-template-columns: repeat(2, 1fr); }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <div class="logo-text">S</div>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                </div>
                            </div>
                            <div class="document-title">Relatório de Presença e Frequência (PEF)</div>
                            <div class="student-title">${student.name}</div>
                        </div>
                        
                        <div class="content">
                            <div class="info-section">
                                <h2>Informações do Aluno</h2>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Nome do Aluno</span>
                                        <span class="info-value">${student.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Turma</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Professor</span>
                                        <span class="info-value">${turma.teacherName || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nível</span>
                                        <span class="info-value">${turma.level || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Modalidade</span>
                                        <span class="info-value">${student.modalidade || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Data do Relatório</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="attendance-summary">
                                <h2>Resumo de Frequência</h2>
                                <div class="attendance-stats">
                                    <div class="stat-item">
                                        <span class="stat-number presente">${presentLessons}</span>
                                        <span class="stat-label">Presenças</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number parcial">${partialLessons}</span>
                                        <span class="stat-label">Presenças Parciais</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number falta">${absentLessons}</span>
                                        <span class="stat-label">Faltas</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number percentage">${attendancePercentage}%</span>
                                        <span class="stat-label">Taxa de Frequência</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lessons-container">
                                <h2 class="lessons-title">Registro Detalhado de Aulas</h2>
                                ${lessonsHtml}
                            </div>
                            
                            <button class="print-btn" onclick="window.print()">🖨️ Imprimir Relatório Individual</button>
                        </div>
                        
                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Relatório individual gerado em ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`PEF Individual - ${student.name}`, docHtml);
        }


        // --- Debug Functions ---
        function debugSyncStatus() {
            if (currentUserRole !== 'admin') return;

            const syncInfo = {
                isDevelopmentMode: window.isDevelopmentMode,
                hasFirebase: !!db,
                currentUser: currentUserName,
                currentRole: currentUserRole,
                challengeContent: challengeContent,
                localStorage: localStorage.getItem('slap-challenge-content'),
                timestamp: new Date().toISOString()
            };

            document.getElementById('form-modal-title').textContent = 'Debug: Status de Sincronização';
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-2">Modo de Execução</h4>
                            <div class="text-sm">
                                <div class="flex justify-between">
                                    <span>Modo:</span>
                                    <span class="font-medium ${window.isDevelopmentMode ? 'text-orange-600' : 'text-green-600'}">
                                        ${window.isDevelopmentMode ? 'Desenvolvimento (Local)' : 'Produção (Firebase)'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Firebase:</span>
                                    <span class="font-medium ${db ? 'text-green-600' : 'text-red-600'}">
                                        ${db ? 'Conectado' : 'Desconectado'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-2">Usuário Atual</h4>
                            <div class="text-sm">
                                <div class="flex justify-between">
                                    <span>Nome:</span>
                                    <span class="font-medium">${currentUserName}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Papel:</span>
                                    <span class="font-medium">${currentUserRole}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-stone-800 mb-3">Conteúdo Atual do Desafio</h4>
                        <div class="bg-stone-50 border border-stone-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">Mês:</span> ${challengeContent.month || 'N/A'}
                                </div>
                                <div>
                                    <span class="font-medium">Subtítulo:</span> ${challengeContent.subtitle || 'N/A'}
                                </div>
                                <div>
                                    <span class="font-medium">Vídeo:</span> ${challengeContent.videoUrl ? 'Definido' : 'Não definido'}
                                </div>
                                <div>
                                    <span class="font-medium">Deadline:</span> ${challengeContent.deadline ? new Date(challengeContent.deadline).toLocaleString('pt-BR') : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h5 class="font-medium text-yellow-800 mb-2">Diagnóstico:</h5>
                        <div class="text-sm text-yellow-700 space-y-1">
                            ${window.isDevelopmentMode ? 
                                '<p>⚠️ <strong>Modo Desenvolvimento:</strong> Mudanças são salvas apenas localmente (localStorage). Para testar sincronização, use o modo produção com Firebase.</p>' :
                                '<p>✅ <strong>Modo Produção:</strong> Mudanças são compartilhadas entre todos os usuários via Firebase em tempo real.</p>'
                            }
                            ${!db && !window.isDevelopmentMode ? 
                                '<p>❌ <strong>Firebase desconectado:</strong> Sistema está usando localStorage como fallback.</p>' : ''
                            }
                            <p>🔄 <strong>Sincronização:</strong> ${window.isDevelopmentMode ? 'Desabilitada (modo local)' : 'Ativa para todos os usuários'}</p>
                        </div>
                    </div>

                    <div class="text-right">
                        <button type="button" data-action="close-form-modal" class="secondary-btn">Fechar</button>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');

            console.log('SYNC DEBUG INFO:', syncInfo);
        }



        // --- Calendar Functions ---
        async function deleteCalendarEvent(eventId) {
            // Check if user has permission to delete events
            if (currentUserRole === 'teacher') {
                showErrorMessage("Acesso Negado", "Usuários com role 'teacher' não podem apagar eventos.");
                return;
            }

            if (!confirm('Tem certeza que deseja excluir este evento?')) {
                return;
            }

            if (!db) {
                // Development mode - update localStorage
                calendarEvents = calendarEvents.filter(e => e.id !== eventId);
                localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
                renderCalendar();
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso!", "Evento excluído com sucesso.");
                return;
            }

            try {
                const eventDoc = doc(db, `artifacts/${appId}/public/data/calendar-events`, eventId);
                await deleteDoc(eventDoc);
                
                // Close modal and show success message
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso!", "Evento excluído com sucesso.");
            } catch (error) {
                console.error("Error deleting calendar event:", error);
                showErrorMessage("Erro", "Erro ao excluir evento: " + error.message);
            }
        }

        function renderCalendarioPedagogicoSection() {
            document.getElementById('main-title').textContent = 'Calendário Pedagógico';
            const contentArea = document.getElementById('content-area');

            contentArea.innerHTML = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="flex items-center gap-4">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)">« Anterior</button>
                            <h2 id="calendar-month-year" class="text-2xl font-bold text-stone-800"></h2>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)">Próximo »</button>
                        </div>
                        ${['admin', 'pedagogico'].includes(currentUserRole) ? `
                        <button class="primary-btn w-auto" data-action="add-calendar-event">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar Evento
                        </button>
                        ` : ''}
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>

                <!-- Event Modal -->
                <div id="calendar-event-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4 id="event-modal-title">Evento</h4>
                            <button data-action="close-calendar-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="calendar-event-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">Título</label>
                                    <input type="text" id="event-title" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data</label>
                                    <input type="date" id="event-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Horário</label>
                                    <input type="time" id="event-time" class="form-input">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Tipo</label>
                                    <select id="event-type" class="form-input" required>
                                        <option value="evento">Evento Geral</option>
                                        <option value="gravacao">Gravação</option>
                                        <option value="lembrete">Lembrete</option>
                                        <option value="aula-extra">Aula Extra</option>
                                        <option value="data-comemorativa">Data Comemorativa</option>
                                        <option value="reuniao">Reunião</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descrição</label>
                                    <textarea id="event-description" rows="3" class="form-input"></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" data-action="close-calendar-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            initializeCalendar();
        }

        function renderCalendarioMarketingSection() {
            document.getElementById('main-title').textContent = 'Calendário Marketing';
            const contentArea = document.getElementById('content-area');

            contentArea.innerHTML = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="flex items-center gap-4">
                            <button class="calendar-nav-btn" data-action="change-marketing-month" data-direction="-1">« Anterior</button>
                            <h2 id="marketing-calendar-month-year" class="text-2xl font-bold text-stone-800"></h2>
                            <button class="calendar-nav-btn" data-action="change-marketing-month" data-direction="1">Próximo »</button>
                        </div>
                        ${['admin', 'am', 'pedagogico', 'financeiro'].includes(currentUserRole) ? `
                        <button class="primary-btn w-auto" data-action="add-marketing-event">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar Evento Marketing
                        </button>
                        ` : ''}
                    </div>
                    <div class="calendar-grid" id="marketing-calendar-grid">
                        <!-- Marketing Calendar will be rendered here -->
                    </div>
                </div>

                <!-- Marketing Event Modal -->
                <div id="marketing-event-modal" class="modal-overlay">
                    <div class="modal-content max-w-lg">
                        <div class="modal-header">
                            <h4 id="marketing-event-modal-title">Evento Marketing</h4>
                            <button data-action="close-marketing-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="marketing-event-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">Título</label>
                                    <input type="text" id="marketing-event-title" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data</label>
                                    <input type="date" id="marketing-event-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Horário</label>
                                    <input type="time" id="marketing-event-time" class="form-input">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Tipo de Conteúdo</label>
                                    <div class="mt-2 grid grid-cols-2 gap-2 p-3 border rounded-md">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-campanha" name="tipos" value="Campanha" class="h-4 w-4 rounded">
                                            <label for="tipo-campanha" class="ml-2 text-sm">Campanha</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-reel" name="tipos" value="Reel" class="h-4 w-4 rounded">
                                            <label for="tipo-reel" class="ml-2 text-sm">Reel</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-carrossel" name="tipos" value="Carrossel" class="h-4 w-4 rounded">
                                            <label for="tipo-carrossel" class="ml-2 text-sm">Carrossel</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-story" name="tipos" value="Story" class="h-4 w-4 rounded">
                                            <label for="tipo-story" class="ml-2 text-sm">Story</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-destaque" name="tipos" value="Destaque" class="h-4 w-4 rounded">
                                            <label for="tipo-destaque" class="ml-2 text-sm">Destaque</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-tiktok" name="tipos" value="TikTok" class="h-4 w-4 rounded">
                                            <label for="tipo-tiktok" class="ml-2 text-sm">TikTok</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-youtube" name="tipos" value="YouTube" class="h-4 w-4 rounded">
                                            <label for="tipo-youtube" class="ml-2 text-sm">YouTube</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-youtube-shorts" name="tipos" value="YouTube Shorts" class="h-4 w-4 rounded">
                                            <label for="tipo-youtube-shorts" class="ml-2 text-sm">YouTube Shorts</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="tipo-gravacao" name="tipos" value="Gravação" class="h-4 w-4 rounded">
                                            <label for="tipo-gravacao" class="ml-2 text-sm">Gravação</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Link Útil</label>
                                    <input type="url" id="marketing-event-link" class="form-input" placeholder="https://exemplo.com">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descrição</label>
                                    <textarea id="marketing-event-description" rows="3" class="form-input" placeholder="Descrição detalhada do evento..."></textarea>
                                </div>
                                <div class="flex justify-end gap-2 pt-4">
                                    <button type="button" data-action="close-marketing-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar Evento</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            initializeMarketingCalendar();
        }

        let currentCalendarDate = new Date();
        let calendarEvents = [];
        let currentMarketingDate = new Date();
        let marketingEvents = [];

        // Brazilian and US holidays for marketing calendar
        function getHolidays(year) {
            return [
                // Brazilian holidays
                { date: `${year}-01-01`, title: "Ano Novo (BR)", type: "holiday", country: "BR" },
                { date: `${year}-02-12`, title: "Carnaval (BR)", type: "holiday", country: "BR" },
                { date: `${year}-04-21`, title: "Tiradentes (BR)", type: "holiday", country: "BR" },
                { date: `${year}-05-01`, title: "Dia do Trabalhador (BR)", type: "holiday", country: "BR" },
                { date: `${year}-09-07`, title: "Independência do Brasil", type: "holiday", country: "BR" },
                { date: `${year}-10-12`, title: "Nossa Senhora Aparecida (BR)", type: "holiday", country: "BR" },
                { date: `${year}-11-02`, title: "Finados (BR)", type: "holiday", country: "BR" },
                { date: `${year}-11-15`, title: "Proclamação da República (BR)", type: "holiday", country: "BR" },
                { date: `${year}-12-25`, title: "Natal (BR/US)", type: "holiday", country: "BR/US" },
                { date: `${year}-05-12`, title: "Dia das Mães (BR)", type: "holiday", country: "BR" },
                { date: `${year}-08-11`, title: "Dia dos Pais (BR)", type: "holiday", country: "BR" },
                { date: `${year}-10-15`, title: "Dia do Professor (BR)", type: "holiday", country: "BR" },
                { date: `${year}-06-12`, title: "Dia dos Namorados (BR)", type: "holiday", country: "BR" },
                
                // US holidays
                { date: `${year}-01-15`, title: "Martin Luther King Day (US)", type: "holiday", country: "US" },
                { date: `${year}-02-19`, title: "Presidents' Day (US)", type: "holiday", country: "US" },
                { date: `${year}-05-27`, title: "Memorial Day (US)", type: "holiday", country: "US" },
                { date: `${year}-07-04`, title: "Independence Day (US)", type: "holiday", country: "US" },
                { date: `${year}-09-02`, title: "Labor Day (US)", type: "holiday", country: "US" },
                { date: `${year}-10-14`, title: "Columbus Day (US)", type: "holiday", country: "US" },
                { date: `${year}-11-11`, title: "Veterans Day (US)", type: "holiday", country: "US" },
                { date: `${year}-11-28`, title: "Thanksgiving (US)", type: "holiday", country: "US" },
                { date: `${year}-11-29`, title: "Black Friday (US)", type: "holiday", country: "US" },
                { date: `${year}-12-24`, title: "Christmas Eve (US)", type: "holiday", country: "US" },
                { date: `${year}-12-31`, title: "New Year's Eve (BR/US)", type: "holiday", country: "BR/US" },
                { date: `${year}-02-14`, title: "Valentine's Day (US)", type: "holiday", country: "US" },
                { date: `${year}-03-17`, title: "St. Patrick's Day (US)", type: "holiday", country: "US" },
                { date: `${year}-10-31`, title: "Halloween (US)", type: "holiday", country: "US" },
                { date: `${year}-05-12`, title: "Mother's Day (US)", type: "holiday", country: "US" },
                { date: `${year}-06-16`, title: "Father's Day (US)", type: "holiday", country: "US" }
            ];
        }

        // Brazilian national holidays only for pedagogical calendar
        function getBrazilianHolidays(year) {
            return [
                { date: `${year}-01-01`, title: "Ano Novo", type: "holiday", country: "BR" },
                { date: `${year}-02-12`, title: "Carnaval", type: "holiday", country: "BR" },
                { date: `${year}-04-21`, title: "Tiradentes", type: "holiday", country: "BR" },
                { date: `${year}-05-01`, title: "Dia do Trabalhador", type: "holiday", country: "BR" },
                { date: `${year}-09-07`, title: "Independência do Brasil", type: "holiday", country: "BR" },
                { date: `${year}-10-12`, title: "Nossa Senhora Aparecida", type: "holiday", country: "BR" },
                { date: `${year}-11-02`, title: "Finados", type: "holiday", country: "BR" },
                { date: `${year}-11-15`, title: "Proclamação da República", type: "holiday", country: "BR" },
                { date: `${year}-12-25`, title: "Natal", type: "holiday", country: "BR" },
                { date: `${year}-05-12`, title: "Dia das Mães", type: "holiday", country: "BR" },
                { date: `${year}-08-11`, title: "Dia dos Pais", type: "holiday", country: "BR" },
                { date: `${year}-10-15`, title: "Dia do Professor", type: "holiday", country: "BR" },
                { date: `${year}-06-12`, title: "Dia dos Namorados", type: "holiday", country: "BR" },
                { date: `${year}-12-31`, title: "Ano Novo (Véspera)", type: "holiday", country: "BR" }
            ];
        }

        function initializeCalendar() {
            renderCalendar();
            loadCalendarEvents();
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const monthYear = document.getElementById('calendar-month-year');
            const calendarGrid = document.getElementById('calendar-grid');

            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

            monthYear.textContent = `${months[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;

            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let html = days.map(day => `<div class="calendar-day-header">${day}</div>`).join('');

            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);

                const isCurrentMonth = currentDay.getMonth() === currentCalendarDate.getMonth();
                const isToday = currentDay.toDateString() === new Date().toDateString();
                const dayEvents = getEventsForDate(currentDay);

                html += `
                    <div class="calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}" 
                         data-date="${currentDay.toISOString().split('T')[0]}">
                        <div class="calendar-day-number">${currentDay.getDate()}</div>
                        ${dayEvents.map(event => 
                            `<div class="calendar-event ${event.type === 'holiday' ? 'holiday-event' : event.type}" 
                                  ${event.type === 'holiday' ? '' : `onclick="viewCalendarEvent('${event.id}')"`}>
                                ${event.type === 'holiday' ? `<svg class="inline-block w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>${event.title}` : event.title}
                            </div>`
                        ).join('')}
                    </div>
                `;
            }

            calendarGrid.innerHTML = html;
        }

        function getEventsForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            const events = calendarEvents.filter(event => event.date === dateString);
            
            // Add Brazilian holidays for pedagogical calendar
            const holidays = getBrazilianHolidays(date.getFullYear()).filter(holiday => holiday.date === dateString);
            
            return [...events, ...holidays];
        }

        async function loadCalendarEvents() {
            if (!db) {
                console.warn("Firebase not available, loading from localStorage");
                const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
                if (localEvents.length === 0) {
                    // Add sample data if no events exist
                    calendarEvents = [
                        { id: '1', title: 'Reunião Pedagógica', date: '2025-01-15', time: '09:00', type: 'reuniao', description: 'Reunião mensal da equipe pedagógica' },
                        { id: '2', title: 'Gravação Aula', date: '2025-01-20', time: '14:00', type: 'gravacao', description: 'Gravação da aula de pronunciação avançada' }
                    ];
                    localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
                } else {
                    calendarEvents = localEvents;
                }
                renderCalendar();
                return;
            }

            try {
                const eventsCollection = collection(db, `artifacts/${appId}/public/data/calendar-events`);
                const eventsSnapshot = await getDocs(eventsCollection);
                calendarEvents = eventsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Set up real-time listener
                onSnapshot(eventsCollection, (snapshot) => {
                    calendarEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCalendar();
                });
                
                renderCalendar();
            } catch (error) {
                console.error("Error loading calendar events:", error);
                calendarEvents = [];
                renderCalendar();
            }
        }

        async function saveCalendarEvents() {
            // No longer needed - events are saved individually via saveCalendarEvent
        }

        // Load campanhas from Firebase
        async function loadCampanhas() {
            if (!db) {
                console.warn("Firebase not available, using sample data");
                events = [
                    { id: '1', nome: 'Campanha Demo', responsavel: 'Admin', setores: ['Marketing'], plataforma: ['Instagram'], focoObjetivo: ['Engajamento'], finalizada: false }
                ];
                return;
            }

            try {
                const campanhasCollection = collection(db, `artifacts/${appId}/public/data/events`);
                const campanhasSnapshot = await getDocs(campanhasCollection);
                events = campanhasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load campanhas data without real-time updates to prevent navigation interference
                // Removed onSnapshot to fix navigation issues
                
            } catch (error) {
                console.error("Error loading campanhas:", error);
                events = [];
            }
        }

        // Marketing Calendar Functions
        function initializeMarketingCalendar() {
            renderMarketingCalendar();
            loadMarketingEvents();
        }

        function changeMarketingMonth(direction) {
            currentMarketingDate.setMonth(currentMarketingDate.getMonth() + direction);
            renderMarketingCalendar();
        }

        // Expose function globally for onclick handlers
        window.changeMarketingMonth = changeMarketingMonth;
        window.viewMarketingEvent = viewMarketingEvent;
        window.deleteMarketingEvent = deleteMarketingEvent;
        window.deleteCalendarEvent = deleteCalendarEvent;
        window.updateTurmasList = updateTurmasList;
        window.updateVipsList = updateVipsList;

        function renderMarketingCalendar() {
            const monthYear = document.getElementById('marketing-calendar-month-year');
            const calendarGrid = document.getElementById('marketing-calendar-grid');

            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

            monthYear.textContent = `${months[currentMarketingDate.getMonth()]} ${currentMarketingDate.getFullYear()}`;

            const firstDay = new Date(currentMarketingDate.getFullYear(), currentMarketingDate.getMonth(), 1);
            const lastDay = new Date(currentMarketingDate.getFullYear(), currentMarketingDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let html = days.map(day => `<div class="calendar-day-header">${day}</div>`).join('');

            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);

                const isCurrentMonth = currentDay.getMonth() === currentMarketingDate.getMonth();
                const isToday = currentDay.toDateString() === new Date().toDateString();
                const dayEvents = getMarketingEventsForDate(currentDay);

                html += `
                    <div class="calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}" 
                         data-date="${currentDay.toISOString().split('T')[0]}">
                        <div class="calendar-day-number">${currentDay.getDate()}</div>
                        ${dayEvents.map(event =>
                            `<div class="calendar-event ${event.type === 'holiday' ? 'holiday-event' : 'marketing-event'}" 
                                  ${event.type === 'holiday' ? '' : `onclick="viewMarketingEvent('${event.id}')"`}>
                                <span class="event-title">${event.type === 'holiday' ? `<svg class="inline-block w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>${event.title}` : event.title}</span>
                                ${event.time ? `<span class="event-time">${event.time}</span>` : ''}
                                ${event.tipos && event.tipos.length > 0 ? 
                                    `<span class="event-tipos">${event.tipos.slice(0, 2).join(', ')}${event.tipos.length > 2 ? '...' : ''}</span>` : ''}
                                ${event.country ? `<span class="event-country">${event.country}</span>` : ''}
                            </div>`
                        ).join('')}
                    </div>
                `;
            }

            calendarGrid.innerHTML = html;
        }

        function getMarketingEventsForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            const events = marketingEvents.filter(event => event.date === dateStr);
            
            // Add holidays for the current year
            const holidays = getHolidays(date.getFullYear()).filter(holiday => holiday.date === dateStr);
            
            return [...events, ...holidays];
        }

        function loadMarketingEvents() {
            const saved = localStorage.getItem('marketing-events');
            if (saved) {
                marketingEvents = JSON.parse(saved);
            } else {
                // Initialize with sample marketing events
                marketingEvents = [
                    { 
                        id: '1', 
                        title: 'Campanha Back to School', 
                        date: '2025-01-20', 
                        time: '10:00', 
                        tipos: ['Campanha', 'Reel'], 
                        link: 'https://exemplo.com',
                        description: 'Campanha de volta às aulas com foco em reels no Instagram' 
                    },
                    { 
                        id: '2', 
                        title: 'YouTube Shorts - Dicas Rápidas', 
                        date: '2025-01-25', 
                        time: '14:00', 
                        tipos: ['YouTube Shorts', 'Gravação'], 
                        link: '',
                        description: 'Série de vídeos curtos com dicas de inglês' 
                    }
                ];
                saveMarketingEvents();
            }
            renderMarketingCalendar();
        }

        function saveMarketingEvents() {
            localStorage.setItem('marketing-events', JSON.stringify(marketingEvents));
        }

        function openMarketingEventForm(eventId = null) {
            const modal = document.getElementById('marketing-event-modal');
            const title = document.getElementById('marketing-event-modal-title');
            const form = document.getElementById('marketing-event-form');

            if (eventId) {
                const event = marketingEvents.find(e => e.id === eventId);
                if (event) {
                    title.textContent = 'Editar Evento Marketing';
                    document.getElementById('marketing-event-title').value = event.title;
                    document.getElementById('marketing-event-date').value = event.date;
                    document.getElementById('marketing-event-time').value = event.time || '';
                    document.getElementById('marketing-event-link').value = event.link || '';
                    document.getElementById('marketing-event-description').value = event.description || '';
                    
                    // Clear and set checkboxes
                    document.querySelectorAll('#marketing-event-form input[name="tipos"]').forEach(cb => cb.checked = false);
                    if (event.tipos) {
                        event.tipos.forEach(tipo => {
                            const checkbox = document.querySelector(`#marketing-event-form input[value="${tipo}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    
                    form.dataset.eventId = eventId;
                }
            } else {
                title.textContent = 'Novo Evento Marketing';
                form.reset();
                delete form.dataset.eventId;
            }

            modal.classList.add('visible');
        }

        function viewMarketingEvent(eventId) {
            const event = marketingEvents.find(e => e.id === eventId);
            if (!event) return;

            const tiposText = event.tipos && event.tipos.length > 0 ? event.tipos.join(', ') : 'Não especificado';
            const linkText = event.link ? `<a href="${event.link}" target="_blank" class="text-blue-600 hover:underline">Abrir Link</a>` : 'Não informado';

            const modal = document.getElementById('form-modal');
            modal.innerHTML = `
                <div class="modal-content max-w-lg">
                    <div class="modal-header">
                        <h4>Detalhes do Evento de Marketing</h4>
                        <button class="modal-close-btn" data-action="close-modal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <h3 class="text-xl font-semibold text-stone-800 mb-4">${event.title}</h3>
                        </div>
                        <div class="grid grid-cols-1 gap-3 text-sm">
                            <div><strong>Data:</strong> ${formatDateBR(event.date)}</div>
                            ${event.time ? `<div><strong>Horário:</strong> ${event.time}</div>` : ''}
                            <div><strong>País:</strong> <span class="inline-block px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">${event.country || 'Brasil'}</span></div>
                            <div><strong>Tipos de Conteúdo:</strong> 
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${event.tipos ? event.tipos.map(tipo => `<span class="inline-block px-2 py-1 rounded text-xs bg-purple-100 text-purple-700">${tipo}</span>`).join('') : '<span class="text-gray-500">Não especificado</span>'}
                                </div>
                            </div>
                            ${event.description ? `<div><strong>Descrição:</strong> <p class="mt-1 text-stone-600">${event.description}</p></div>` : ''}
                            <div><strong>Link:</strong> ${linkText}</div>
                        </div>
                        <div class="flex justify-end gap-2 pt-4 border-t">
                            ${['admin', 'am', 'pedagogico', 'financeiro'].includes(currentUserRole) ? `
                                <button class="danger-btn" onclick="deleteMarketingEvent('${event.id}')">Excluir</button>
                                <button class="secondary-btn" data-action="edit-marketing-event" data-id="${event.id}">Editar</button>
                            ` : ''}
                            <button class="primary-btn w-auto" data-action="close-modal">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.add('visible');
        }

        function deleteMarketingEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;

            marketingEvents = marketingEvents.filter(e => e.id !== eventId);
            saveMarketingEvents();

            // Close modal and refresh calendar
            document.getElementById('form-modal').classList.remove('visible');
            renderMarketingCalendar();
            showSuccessMessage("Sucesso!", "Evento excluído com sucesso.");
        }

        // --- Pedagogical Challenge Functions ---
        function renderDesafioPedagogicoSection() {
            document.getElementById('main-title').textContent = 'Desafio Pedagógico';
            const contentArea = document.getElementById('content-area');

            contentArea.innerHTML = `
                <div class="bg-[#F1D24B] p-6 rounded-xl shadow-lg mb-8">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex-grow text-center">
                            <h1 class="text-2xl sm:text-3xl font-bold text-stone-800">Pedagogical Challenge</h1>
                            <p id="challenge-subtitle-display" class="text-md sm:text-lg text-stone-700 mt-1">A new topic every month to sharpen your skills.</p>
                        </div>
                        <div class="bg-white text-stone-800 px-4 py-2 rounded-lg shadow-inner text-center flex-shrink-0">
                            <span id="challenge-month-display" class="font-bold text-xl">MONTHLY MODULE</span>
                        </div>
                        ${['admin', 'ap'].includes(currentUserRole) ? `
                        <button class="secondary-btn w-auto" data-action="edit-challenge-content">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Editar Conteúdo
                        </button>
                        ` : ''}

                    </div>

                    <div class="mt-6 bg-stone-800 text-white p-6 rounded-lg shadow-lg">
                        <div class="flex flex-col md:flex-row items-center justify-center md:justify-around gap-6 md:gap-12">
                            <div class="text-center">
                                <h3 class="font-semibold text-base uppercase tracking-wider text-yellow-300">Deadline to Complete</h3>
                                <div id="countdown" class="flex justify-center gap-4 sm:gap-6 text-2xl sm:text-4xl mt-2">
                                    <div><span id="days" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Days</span></div>
                                    <div><span id="hours" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Hours</span></div>
                                    <div><span id="minutes" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Minutes</span></div>
                                    <div><span id="seconds" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Seconds</span></div>
                                </div>
                            </div>
                            <div class="hidden md:block w-px h-16 bg-stone-600"></div>
                            <div class="text-center flex items-center gap-4">
                                <svg class="w-12 h-12 text-yellow-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="text-left">
                                     <p class="text-lg font-bold text-white">1000 Points</p>
                                     <p class="text-sm text-stone-300">in the SLAP Dojo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border-2 border-stone-200">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <!-- Left Column: Materials -->
                        <div class="space-y-8">
                            <div>
                                <h4 class="text-xl font-semibold mb-3 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                    Video Materials
                                </h4>
                                <div id="challenge-video-container">
                                    <!-- Video content will be rendered here -->
                                </div>
                            </div>

                            <div>
                                <h4 class="text-xl font-semibold mb-3 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                    </svg>
                                    Audio Materials
                                </h4>
                                <div id="challenge-audio-container">
                                    <!-- Audio content will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Quiz -->
                        <div class="flex flex-col">
                            <h4 class="text-xl font-semibold mb-3 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                The Challenge Quiz
                            </h4>
                            <div id="quiz-container" class="bg-stone-50 p-6 rounded-lg border border-stone-200 flex-grow min-h-[400px]">
                                <!-- Quiz content will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Challenge Content Edit Modal -->
                <div id="challenge-edit-modal" class="modal-overlay">
                    <div class="modal-content max-w-2xl">
                        <div class="modal-header">
                            <h4>Editar Conteúdo do Desafio</h4>
                            <button data-action="close-challenge-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="challenge-content-form">
                            <div class="space-y-6">
                                <div>
                                    <label class="font-medium text-sm">URL do Vídeo (Cloudinary)</label>
                                    <input type="url" id="challenge-video-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                    <p class="text-xs text-stone-500 mt-1">Deixe em branco para remover o vídeo</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL do Áudio 1 (Cloudinary)</label>
                                    <input type="url" id="challenge-audio1-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL do Áudio 2 (Cloudinary)</label>
                                    <input type="url" id="challenge-audio2-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Mês do Módulo</label>
                                    <input type="text" id="challenge-month" class="form-input" placeholder="Ex: JANEIRO 2025">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Tema do Mês (Subtítulo)</label>
                                    <input type="text" id="challenge-subtitle" class="form-input" placeholder="Ex: A new topic every month to sharpen your skills.">
                                    <p class="text-xs text-stone-500 mt-1">Texto que aparece abaixo do título principal</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data Limite (Deadline)</label>
                                    <input type="datetime-local" id="challenge-deadline" class="form-input">
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" data-action="close-challenge-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar Conteúdo</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            initializePedagogicalChallenge().catch(console.error);
        }

        // --- Pedagogical Challenge Implementation ---
        let challengeContent = {
            videoUrl: '',
            audio1Url: '',
            audio2Url: '',
            month: 'MONTHLY MODULE',
            deadline: null
        };

        let teacherName = '';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let correctStreak = 0;
        let totalAttempts = 0;
        const questionsNeededForSuccess = 20;
        const questionsInChallenge = 20;

        const fullQuizData = [
            // Dogme ELT Questions (25 questions)
            { q: "According to Thornbury, what is the main role of the teacher in a Dogme-based classroom?", o: ["To follow the coursebook closely", "To correct all grammar errors immediately", "To facilitate and respond to emergent language*", "To deliver pre-planned grammar presentations"], a: 2, e: "In Dogme ELT, teachers act as facilitators who respond to language that emerges naturally from student interaction rather than following rigid lesson plans." },
            { q: "What does 'noticing' primarily help with in advanced learners?", o: ["Expanding vocabulary rapidly", "Developing listening skills", "Identifying fossilized errors*", "Memorizing phrasal verbs"], a: 2, e: "Noticing helps advanced learners become aware of persistent language errors that have become fossilized in their production." },
            { q: "Dogme ELT emphasizes:", o: ["Heavy reliance on multimedia resources", "Teaching fixed grammar structures", "Predefined learning outcomes", "Conversation-driven instruction*"], a: 3, e: "Dogme prioritizes natural conversation and interaction over predetermined curricula and materials." },
            { q: "What is a common challenge advanced learners face, according to Thornbury?", o: ["Lack of interest in grammar", "Inability to understand basic tenses", "Repetition of fossilized errors*", "Low vocabulary range"], a: 2, e: "Advanced learners often struggle with persistent errors that have become automatic and require conscious attention to correct." },
            { q: "Emergent language refers to:", o: ["Vocabulary from the syllabus", "Language that arises spontaneously during interaction*", "Language from previous homework", "Phrases taken from authentic texts"], a: 1, e: "Emergent language is the language that naturally emerges from student interaction and communication needs in the moment." },
            { q: "Which of the following best represents Thornbury's view of the coursebook in Dogme?", o: ["A non-negotiable part of every lesson", "A helpful supplementary tool", "An optional, secondary resource", "Often an obstacle to genuine interaction*"], a: 3, e: "Thornbury views coursebooks as potentially limiting authentic interaction and emergent learning opportunities." },
            { q: "What is one core principle of Dogme teaching?", o: ["Silence is golden", "Grammar translation is key", "Learner output drives learning*", "Drilling ensures retention"], a: 2, e: "Dogme believes that learning is most effective when driven by what learners actually produce and need to communicate." },
            { q: "Why is noticing especially important for advanced learners?", o: ["They are preparing for tests", "They don't need explicit grammar", "Their language awareness needs refining*", "They need more input than output"], a: 2, e: "Advanced learners benefit from refined language awareness to identify and correct subtle errors in their production." },
            { q: "Which of the following is most aligned with emergent language pedagogy?", o: ["Ignoring student errors", "Focusing on accuracy before fluency", "Using language produced by learners as teaching material*", "Teaching only from the textbook"], a: 2, e: "Emergent pedagogy uses actual student language production as the primary source of teaching content and focus." },
            { q: "A key benefit of emergent language instruction is:", o: ["It reduces lesson planning time", "It creates mechanical practice", "It fosters personalized learning experiences*", "It removes the need for assessment"], a: 2, e: "Emergent instruction creates highly personalized learning experiences based on individual student needs and output." },
            { q: "Which teacher behavior best fits the noticing framework?", o: ["Allowing errors to persist unaddressed", "Reformulating student sentences in real-time*", "Avoiding correction to preserve fluency", "Testing students on isolated grammar points"], a: 1, e: "Reformulation helps students notice the difference between their production and more target-like forms." },
            { q: "What type of flexibility does Dogme require from teachers?", o: ["Willingness to change jobs", "Ability to switch between coursebooks", "Adapting plans based on learner interaction*", "Using technology to change lesson pace"], a: 2, e: "Dogme teachers must be flexible enough to adapt their teaching based on what emerges from student interaction." },
            { q: "According to Thornbury, language should be taught:", o: ["Before it is produced", "From student-generated content*", "With strict grammatical accuracy", "Only after assessment"], a: 1, e: "Thornbury advocates for using language that students actually produce as the basis for teaching and learning." },
            { q: "What is the ultimate goal of noticing in advanced learners?", o: ["To prepare them for native-level conversation", "To memorize fixed expressions", "To activate conscious reflection about language use*", "To eliminate fluency gaps"], a: 2, e: "Noticing aims to develop conscious awareness and reflection about language patterns and usage." },
            { q: "Thornbury advocates for:", o: ["Content-heavy PowerPoint lessons", "Structured grammar drills", "Spontaneous language-focused sessions*", "Coursebook-led speaking exercises"], a: 2, e: "Thornbury prefers spontaneous, language-focused sessions that emerge from student interaction." },
            { q: "Which technique aligns most with Thornbury's approach?", o: ["Present–Practice–Produce", "Reformulation and guided noticing*", "Translation and dictation", "Grammar gap-fills"], a: 1, e: "Reformulation and guided noticing are key techniques in helping students become aware of language patterns." },
            { q: "What type of classroom activity would Thornbury likely support?", o: ["Role-play with unpredictable outcomes*", "Reading comprehension from textbooks", "Silent reading sessions", "Grammar quizzes"], a: 0, e: "Unpredictable role-plays create opportunities for genuine emergent language that can be worked with pedagogically." },
            { q: "How can teachers track emergent language?", o: ["Ignore it and continue the lesson", "Record and revisit student errors*", "Focus only on written accuracy", "Use ready-made worksheets"], a: 1, e: "Teachers should record emergent language issues to revisit and work on them pedagogically." },
            { q: "What is a typical issue in fossilization?", o: ["Teachers overcorrect mistakes", "Learners are unaware of persistent errors*", "Materials are too advanced", "Students memorize too quickly"], a: 1, e: "Fossilization occurs when learners are unaware of persistent errors that have become automatic." },
            { q: "Why might coursebooks be counterproductive in advanced classes, according to Thornbury?", o: ["They are too expensive", "They lack spontaneity and authentic interaction*", "They overuse listening activities", "They don't include enough homework"], a: 1, e: "Coursebooks can limit the spontaneous, authentic interaction that advanced learners need for continued development." },
            { q: "Noticing can be enhanced through:", o: ["Multiple-choice questions", "Grammar translation", "Contrasting learner and native-like output*", "Ignoring errors for fluency"], a: 2, e: "Contrasting student output with more target-like versions helps enhance noticing and awareness." },
            { q: "What is a sign that a learner needs more noticing?", o: ["They hesitate when speaking", "They produce frequent but subtle errors*", "They ask too many questions", "They refuse to write"], a: 1, e: "Frequent subtle errors indicate that learners have fossilized patterns that need conscious attention and noticing to correct." },
            { q: "Which of the following best describes Dogme's view on input?", o: ["Authentic input must always come from native speakers", "All input should be teacher-generated", "Learners themselves generate the most relevant input*", "Input should be controlled and limited"], a: 2, e: "In Dogme, learners' own language production becomes the primary source of meaningful and relevant input for further learning." },
            { q: "Which mindset should a teacher adopt for emergent language teaching?", o: ["Control and delivery", "Observation and responsiveness*", "Correction and drilling", "Silence and monitoring"], a: 1, e: "Emergent language teaching requires teachers to be observant and responsive to learning opportunities as they arise naturally." },
            { q: "Which of the following best reflects Thornbury's philosophy?", o: ["Language is best acquired through repeated testing", "Learning occurs most effectively through structured tasks", "Language awareness must be developed through active engagement*", "Students need more input than output"], a: 2, e: "Thornbury believes that conscious engagement with language, particularly through noticing and reflection, is key to language development." },

            // Michael Lewis Lexical Approach Questions (25 questions)
            { q: "According to Michael Lewis, what is the primary component of language?", o: ["Grammar rules", "Phonological systems", "Lexical chunks*", "Discrete vocabulary words"], a: 2, e: "Lewis argues that language is primarily made up of prefabricated chunks or collocations rather than individual words and grammar rules." },
            { q: "What does Lewis mean by 'language consists of grammaticalized lexis'?", o: ["Grammar should be taught before vocabulary", "Vocabulary should be organized by parts of speech", "Grammar emerges from lexical patterns*", "Lexis must be learned through grammar"], a: 2, e: "Lewis believes that grammar patterns emerge naturally from how words combine in chunks, rather than being separate rules to memorize." },
            { q: "Which of the following is an example of a lexical chunk?", o: ["Verb + ing", "Present perfect", "Make a mistake*", "A noun in plural"], a: 2, e: "A lexical chunk is a group of words that commonly appear together, like 'make a mistake', 'strong coffee', or 'by the way'." },
            { q: "The Lexical Approach argues against:", o: ["Teaching collocations", "Learning isolated grammar structures*", "Using authentic texts", "Encouraging fluency"], a: 1, e: "The Lexical Approach opposes teaching grammar as isolated rules separate from meaningful chunks of language." },
            { q: "According to Schmitt (2000), why does the brain prefer chunks?", o: ["They are easier to spell", "They activate the visual cortex", "They reduce cognitive load*", "They follow textbook logic"], a: 2, e: "Processing prefabricated chunks requires less cognitive effort than constructing language from individual elements each time." },
            { q: "What replaces the traditional PPP model in Lewis's approach?", o: ["Explain–Drill–Repeat", "Present–Produce–Perfect", "Observe–Hypothesise–Experiment*", "Input–Output–Feedback"], a: 2, e: "Lewis proposes OHE (Observe–Hypothesise–Experiment) as a more natural way to acquire language through discovery rather than presentation." },
            { q: "In the 'Observe' phase, students:", o: ["Take grammar notes from rules", "Memorize irregular verbs", "Identify lexical patterns in authentic texts*", "Translate texts word for word"], a: 2, e: "Students observe how language naturally occurs in authentic contexts to notice chunks and patterns." },
            { q: "During the 'Hypothesise' phase, students:", o: ["Guess meanings and usage of chunks*", "Correct grammar in sentences", "Write essays from memory", "Identify parts of speech"], a: 0, e: "Students form hypotheses about how chunks work and their meanings based on observed patterns." },
            { q: "The 'Experiment' stage encourages students to:", o: ["Avoid errors", "Use chunks in creative, real tasks*", "Fill in grammar worksheets", "Learn from the teacher's corrections"], a: 1, e: "Students experiment with using chunks in authentic, meaningful communication tasks." },
            { q: "What is the ultimate goal of the Lexical Approach?", o: ["Perfect grammar use", "Fluent and natural communication*", "Memorizing academic vocabulary", "Mastering verb conjugation"], a: 1, e: "The Lexical Approach aims for natural, fluent communication through mastery of lexical chunks." },
            { q: "Lewis views grammar as something that should be:", o: ["Taught in isolation", "Memorized before speaking", "Avoided completely", "Acquired implicitly through chunks*"], a: 3, e: "Grammar should be acquired naturally through exposure to and use of lexical chunks rather than explicit teaching." },
            { q: "What kind of input does the Lexical Approach favor?", o: ["Artificially simplified sentences", "Authentic and real-life language*", "Grammatical drills", "Repetition of isolated verbs"], a: 1, e: "Authentic, real-life language provides natural examples of how chunks are used in context." },
            { q: "What kind of classroom activity best aligns with the Lexical Approach?", o: ["Gap-fills using collocations*", "Timed grammar quizzes", "Phoneme dictation", "Silent reading of lists"], a: 0, e: "Activities that focus on collocations and chunks help students notice and practice lexical patterns." },
            { q: "Which of the following would NOT be typical in a lexical classroom?", o: ["Chunk identification in authentic audio", "Creative rewriting using collocations", "Translation of entire paragraphs", "Teaching grammar in isolation*"], a: 3, e: "Teaching grammar in isolation goes against the lexical approach principle of learning grammar through chunks." },
            { q: "What is a 'collocation box' used for?", o: ["Listing irregular verbs", "Tracking spelling mistakes", "Organizing common word pairings*", "Highlighting past participles"], a: 2, e: "Collocation boxes help organize and learn common word combinations and lexical patterns." },
            { q: "A teacher using the Lexical Approach might ask students to:", o: ["List all prepositions", "Identify and reuse useful chunks in conversation*", "Avoid idioms in writing", "Conjugate all modal verbs"], a: 1, e: "Students are encouraged to notice useful chunks and then actively use them in their own communication." },
            { q: "Lewis's methodology emphasizes:", o: ["Structured grammar presentations", "Contextualized exposure to real language*", "Memorizing dictionaries", "Monolingual definitions"], a: 1, e: "Real, contextualized language exposure helps students see how chunks function naturally." },
            { q: "Repetition and recycling of chunks is used to:", o: ["Teach phonology", "Improve pronunciation accuracy", "Enhance retention and fluency*", "Promote grammar mastery"], a: 2, e: "Repeated exposure and use of chunks helps students internalize them for fluent, automatic use." },
            { q: "Which phrase best summarizes Lewis's belief?", o: ["Grammar creates vocabulary", "Lexis is secondary to form", "Grammar is the foundation of all speech", "Lexis drives grammar, not the other way around*"], a: 3, e: "Lewis believes that lexical patterns drive grammatical understanding, reversing traditional priorities." },
            { q: "Chunk-for-chunk translation helps learners:", o: ["Understand isolated grammar rules", "Focus on equivalent lexical patterns*", "Translate word-by-word", "Ignore pragmatic meaning"], a: 1, e: "Chunk-for-chunk translation helps learners see equivalent patterns between languages rather than word-by-word correspondence." },
            { q: "How can the Lexical Approach be integrated into CLT or TBL?", o: ["Through drills after reading", "By teaching grammar first, then activating it", "By highlighting useful chunks and encouraging use in tasks*", "Through rote learning of textbook dialogues"], a: 2, e: "Integration involves identifying useful chunks in communicative tasks and encouraging their active use." },
            { q: "What does 'noticing lexical patterns' mean in this context?", o: ["Memorizing vocabulary lists", "Focusing on how language is built through fixed expressions*", "Avoiding grammar at all times", "Creating new words from roots"], a: 1, e: "Noticing lexical patterns involves recognizing how language is constructed through recurring combinations of words." },
            { q: "According to Lewis, grammar is best learned:", o: ["After lexis is fully mastered", "Through explicit drills", "Within lexical chunks and meaningful context*", "Through native-speaker imitation"], a: 2, e: "Grammar is most effectively learned when encountered within meaningful lexical chunks rather than as isolated rules." },
            { q: "Why are authentic texts important in the Lexical Approach?", o: ["They test reading speed", "They illustrate textbook rules", "They provide real examples of chunk usage*", "They contain simpler grammar"], a: 2, e: "Authentic texts show how chunks are actually used in real communication contexts." },
            { q: "What kind of outcome does Lewis's approach aim for?", o: ["Native-like pronunciation", "Controlled accuracy", "Spontaneous and meaningful fluency*", "Structured writing skills"], a: 2, e: "The goal is natural, spontaneous fluency through mastery of lexical chunks rather than perfect formal accuracy." }
        ];

        async function initializePedagogicalChallenge() {
            await loadChallengeContent();
            renderChallengeContent();
            initializeCountdown();
            showQuizWelcome();

            // Set up real-time listener for Firebase updates
            if (!window.isDevelopmentMode && db) {
                const docRef = doc(db, `artifacts/${appId}/public/data/challenge-content`, 'current');
                onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        const newContent = {
                            videoUrl: data.videoUrl || '',
                            audio1Url: data.audio1Url || '',
                            audio2Url: data.audio2Url || '',
                            month: data.month || 'MONTHLY MODULE',
                            subtitle: data.subtitle || 'A new topic every month to sharpen your skills.',
                            deadline: data.deadline || null
                        };

                        // Only update if content changed to avoid infinite loops
                        if (JSON.stringify(newContent) !== JSON.stringify(challengeContent)) {
                            challengeContent = newContent;
                            renderChallengeContent();

                            // Restart countdown with new deadline
                            if (countdownInterval) {
                                clearInterval(countdownInterval);
                            }
                            initializeCountdown();

                            // Show notification that content was updated
                            if (data.updatedBy && data.updatedBy !== currentUserName) {
                                showSuccessMessage("Atualização!", `Conteúdo atualizado por ${data.updatedBy}`);
                            }
                        }
                    }
                }, (error) => {
                    console.error("Error listening to challenge content updates:", error);
                });
            }
        }

        async function loadChallengeContent() {
            if (window.isDevelopmentMode) {
                // In development mode, load from localStorage
                const saved = localStorage.getItem('slap-challenge-content');
                if (saved) {
                    challengeContent = JSON.parse(saved);
                } else {
                    setDefaultChallengeContent();
                }
            } else if (db) {
                // In production, load from Firebase so it's shared across all users
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/challenge-content`, 'current');
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        challengeContent = {
                            videoUrl: data.videoUrl || '',
                            audio1Url: data.audio1Url || '',
                            audio2Url: data.audio2Url || '',
                            month: data.month || 'MONTHLY MODULE',
                            subtitle: data.subtitle || 'A new topic every month to sharpen your skills.',
                            deadline: data.deadline || null
                        };
                    } else {
                        setDefaultChallengeContent();
                    }
                } catch (error) {
                    console.error("Error loading challenge content:", error);
                    // Fallback to localStorage
                    const saved = localStorage.getItem('slap-challenge-content');
                    if (saved) {
                        challengeContent = JSON.parse(saved);
                    } else {
                        setDefaultChallengeContent();
                    }
                }
            } else {
                // Fallback to localStorage
                const saved = localStorage.getItem('slap-challenge-content');
                if (saved) {
                    challengeContent = JSON.parse(saved);
                } else {
                    setDefaultChallengeContent();
                }
            }
        }

        function setDefaultChallengeContent() {
            const now = new Date();
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);

            challengeContent = {
                videoUrl: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751160446/Vygotksy_s_Zone_of_Proximal_Development_Explained_in_4_minutes_n3dmpt.mp4',
                audio1Url: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751161824/zdp1_yldo65.mp3',
                audio2Url: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751162058/ZDP2_jfyspg.mp3',
                month: 'JANEIRO 2025',
                subtitle: 'A new topic every month to sharpen your skills.',
                deadline: endOfMonth.toISOString()
            };
            saveChallengeContent();
        }

        async function saveChallengeContent() {
            if (window.isDevelopmentMode) {
                // In development mode, save to localStorage
                localStorage.setItem('slap-challenge-content', JSON.stringify(challengeContent));
            } else if (db) {
                // In production, save to Firebase so it's shared across all users
                try {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/challenge-content`, 'current'), {
                        ...challengeContent,
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUserName
                    });
                } catch (error) {
                    console.error("Error saving challenge content:", error);
                    // Fallback to localStorage if Firebase fails
                    localStorage.setItem('slap-challenge-content', JSON.stringify(challengeContent));
                }
            } else {
                // Fallback to localStorage
                localStorage.setItem('slap-challenge-content', JSON.stringify(challengeContent));
            }
        }

        function renderChallengeContent() {
            console.log('Rendering challenge content:', challengeContent);
            renderVideoContent();
            renderAudioContent();
            updateChallengeHeader();
        }

        function updateChallengeHeader() {
            const monthDisplay = document.getElementById('challenge-month-display');
            const subtitleDisplay = document.getElementById('challenge-subtitle-display');

            if (monthDisplay && challengeContent.month) {
                monthDisplay.textContent = challengeContent.month;
            }

            if (subtitleDisplay && challengeContent.subtitle) {
                subtitleDisplay.textContent = challengeContent.subtitle;
            }
        }

        function renderVideoContent() {
            const container = document.getElementById('challenge-video-container');
            console.log('Rendering video content. URL:', challengeContent.videoUrl);
            if (challengeContent.videoUrl) {
                container.innerHTML = `
                    <div class="mb-4">
                        <div class="aspect-video bg-stone-200 rounded-lg overflow-hidden">
                            <video controls class="w-full h-full">
                                <source src="${challengeContent.videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-stone-500">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m2-10a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p>Nenhum vídeo configurado</p>
                        ${['admin', 'ap'].includes(currentUserRole) ? '<p class="text-xs mt-1">Configure um vídeo através do botão "Editar Conteúdo"</p>' : ''}
                    </div>
                `;
            }
        }

        function renderAudioContent() {
            const container = document.getElementById('challenge-audio-container');
            console.log('Rendering audio content. Audio1:', challengeContent.audio1Url, 'Audio2:', challengeContent.audio2Url);
            let audioHtml = '';

            if (challengeContent.audio1Url) {
                audioHtml += `
                    <div class="mb-4">
                        <p class="font-medium text-stone-700 mb-2">Audio 1</p>
                        ${createAudioPlayer(challengeContent.audio1Url, 'audio1')}
                    </div>
                `;
            }

            if (challengeContent.audio2Url) {
                audioHtml += `
                    <div class="mb-4">
                        <p class="font-medium text-stone-700 mb-2">Audio 2</p>
                        ${createAudioPlayer(challengeContent.audio2Url, 'audio2')}
                    </div>
                `;
            }

            if (!challengeContent.audio1Url && !challengeContent.audio2Url) {
                audioHtml = `
                    <div class="text-center py-8 text-stone-500">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                        <p>Nenhum áudio configurado</p>
                        ${['admin', 'ap'].includes(currentUserRole) ? '<p class="text-xs mt-1">Configure áudios através do botão "Editar Conteúdo"</p>' : ''}
                    </div>
                `;
            }

            container.innerHTML = audioHtml;

            // Use setTimeout to ensure DOM is ready before initializing players
            setTimeout(() => {
                initializeAudioPlayers();
            }, 100);
        }

        function createAudioPlayer(audioUrl, playerId) {
            // Add timestamp to avoid cache issues with Cloudinary
            const cacheBustedUrl = audioUrl.includes('?') ? `${audioUrl}&t=${Date.now()}` : `${audioUrl}?t=${Date.now()}`;

            return `
                <div class="audio-player-container" data-player="${playerId}">
                    <button class="play-pause-button">
                        <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                        <svg class="pause-icon hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                    </button>
                    <span class="time-display">0:00 / 0:00</span>
                    <input type="range" class="progress-bar" value="0" step="1">
                    <audio class="audio-element" preload="metadata" src="${cacheBustedUrl}"></audio>
                </div>
            `;
        }

        function cleanupAudioPlayers() {
            // Stop and cleanup existing audio players
            const existingPlayers = document.querySelectorAll('.audio-player-container');
            existingPlayers.forEach(container => {
                const audio = container.querySelector('.audio-element');
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                    // Remove event listeners to prevent memory leaks
                    audio.removeEventListener('loadedmetadata', () => {});
                    audio.removeEventListener('timeupdate', () => {});
                    audio.removeEventListener('error', () => {});
                }
            });
        }

        function initializeAudioPlayers() {
            // Clean up any existing audio players first
            cleanupAudioPlayers();

            const players = document.querySelectorAll('.audio-player-container');
            console.log('Initializing audio players. Found:', players.length, 'players');

            players.forEach((container, index) => {
                const audio = container.querySelector('.audio-element');
                const playButton = container.querySelector('.play-pause-button');
                const playIcon = container.querySelector('.play-icon');
                const pauseIcon = container.querySelector('.pause-icon');
                const progressBar = container.querySelector('.progress-bar');
                const timeDisplay = container.querySelector('.time-display');

                if (!audio || !playButton || !playIcon || !pauseIcon || !progressBar || !timeDisplay) {
                    console.error('Missing audio player elements for player', index);
                    return;
                }

                console.log('Setting up audio player', index, 'for:', audio.src);

                // Ensure audio element is properly configured
                audio.preload = 'metadata';
                audio.crossOrigin = 'anonymous';

                // Force reload audio element to clear cache
                if (audio.src) {
                    audio.load();
                }

                const loadedMetadataHandler = () => {
                    if (audio.duration && !isNaN(audio.duration) && audio.duration !== Infinity) {
                        progressBar.max = audio.duration;
                        updateTimeDisplay();
                        console.log('Audio', index, 'metadata loaded, duration:', audio.duration);
                    }
                };

                const timeUpdateHandler = () => {
                    if (audio.duration && !isNaN(audio.duration)) {
                        progressBar.value = audio.currentTime;
                        updateTimeDisplay();
                    }
                };

                const errorHandler = (e) => {
                    console.error('Audio', index, 'loading error:', e);
                    timeDisplay.textContent = 'Error loading audio';
                };

                const endedHandler = () => {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    audio.currentTime = 0;
                    progressBar.value = 0;
                    updateTimeDisplay();
                };

                // Add event listeners
                audio.addEventListener('loadedmetadata', loadedMetadataHandler);
                audio.addEventListener('timeupdate', timeUpdateHandler);
                audio.addEventListener('error', errorHandler);
                audio.addEventListener('ended', endedHandler);

                playButton.addEventListener('click', () => {
                    console.log('Play button clicked for audio', index, ', paused:', audio.paused);
                    if (audio.paused) {
                        // Pause all other audio players first
                        const allAudioElements = document.querySelectorAll('.audio-element');
                        allAudioElements.forEach(otherAudio => {
                            if (otherAudio !== audio && !otherAudio.paused) {
                                otherAudio.pause();
                                const otherContainer = otherAudio.closest('.audio-player-container');
                                if (otherContainer) {
                                    const otherPlayIcon = otherContainer.querySelector('.play-icon');
                                    const otherPauseIcon = otherContainer.querySelector('.pause-icon');
                                    if (otherPlayIcon && otherPauseIcon) {
                                        otherPlayIcon.classList.remove('hidden');
                                        otherPauseIcon.classList.add('hidden');
                                    }
                                }
                            }
                        });

                        audio.play().then(() => {
                            playIcon.classList.add('hidden');
                            pauseIcon.classList.remove('hidden');
                            console.log('Audio', index, 'started playing');
                        }).catch(e => {
                            console.error('Error playing audio', index, ':', e);
                            alert('Erro ao reproduzir áudio. Verifique se a URL está funcionando.');
                        });
                    } else {
                        audio.pause();
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                        console.log('Audio', index, 'paused');
                    }
                });

                progressBar.addEventListener('input', () => {
                    if (audio.duration && !isNaN(audio.duration)) {
                        audio.currentTime = progressBar.value;
                    }
                });

                function updateTimeDisplay() {
                    const current = formatTime(audio.currentTime || 0);
                    const duration = formatTime(audio.duration || 0);
                    timeDisplay.textContent = `${current} / ${duration}`;
                }

                function formatTime(seconds) {
                    if (isNaN(seconds) || seconds === Infinity) return '0:00';
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }

                // Initialize display
                updateTimeDisplay();
            });
        }

        function openChallengeContentForm() {
            const modal = document.getElementById('challenge-edit-modal');
            const form = document.getElementById('challenge-content-form');

            // Pre-fill form
            document.getElementById('challenge-video-url').value = challengeContent.videoUrl || '';
            document.getElementById('challenge-audio1-url').value = challengeContent.audio1Url || '';
            document.getElementById('challenge-audio2-url').value = challengeContent.audio2Url || '';
            document.getElementById('challenge-month').value = challengeContent.month || '';
            document.getElementById('challenge-subtitle').value = challengeContent.subtitle || '';

            // Pre-fill deadline
            if (challengeContent.deadline) {
                let date;
                if (typeof challengeContent.deadline === 'number') {
                    date = new Date(challengeContent.deadline);
                } else {
                    date = new Date(challengeContent.deadline);
                }

                // Ensure the date is valid before formatting
                if (!isNaN(date.getTime())) {
                    const formattedDate = date.toISOString().slice(0, 16);
                    document.getElementById('challenge-deadline').value = formattedDate;
                }
            }

            modal.classList.add('visible');

            form.onsubmit = (e) => {
                e.preventDefault();
                saveChallengeContentForm();
                modal.classList.remove('visible');
            };
        }

        async function saveChallengeContentForm() {
            const deadlineValue = document.getElementById('challenge-deadline').value;

            let deadline = null;
            if (deadlineValue) {
                const deadlineDate = new Date(deadlineValue);
                if (!isNaN(deadlineDate.getTime())) {
                    deadline = deadlineDate.toISOString(); // Store as ISO string for consistency
                }
            }

            challengeContent = {
                videoUrl: document.getElementById('challenge-video-url').value.trim(),
                audio1Url: document.getElementById('challenge-audio1-url').value.trim(),
                audio2Url: document.getElementById('challenge-audio2-url').value.trim(),
                month: document.getElementById('challenge-month').value.trim() || 'MONTHLY MODULE',
                subtitle: document.getElementById('challenge-subtitle').value.trim() || 'A new topic every month to sharpen your skills.',
                deadline: deadline
            };

            await saveChallengeContent();
            renderChallengeContent();

            // Restart countdown with new deadline
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            initializeCountdown();

            // Reset form safely
            const form = document.getElementById('challenge-content-form');
            if (form) {
                form.reset();
            }
        }

        let countdownInterval = null;

        function initializeCountdown() {
            // Use custom deadline or default to end of current month
            let deadline;
            if (challengeContent.deadline) {
                // Handle both timestamp and date string formats
                if (typeof challengeContent.deadline === 'number') {
                    deadline = new Date(challengeContent.deadline);
                } else {
                    deadline = new Date(challengeContent.deadline);
                }
            } else {
                const now = new Date();
                deadline = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            }

            function updateCountdown() {
                const now = new Date().getTime();
                const distance = deadline.getTime() - now;

                const daysEl = document.getElementById('days');
                const hoursEl = document.getElementById('hours');
                const minutesEl = document.getElementById('minutes');
                const secondsEl = document.getElementById('seconds');

                if (distance > 0) {
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    if (daysEl) daysEl.textContent = days.toString().padStart(2, '0');
                    if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
                    if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
                    if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
                } else {
                    if (daysEl) daysEl.textContent = '00';
                    if (hoursEl) hoursEl.textContent = '00';
                    if (minutesEl) minutesEl.textContent = '00';
                    if (secondsEl) secondsEl.textContent = '00';
                }
            }

            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function showQuizWelcome() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <svg class="w-16 h-16 mx-auto mb-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    <h3 class="text-xl font-bold mb-2 text-violet-600">🎯 Desafio Pedagógico</h3>
                    <p class="text-stone-600 mb-4">Estude o conteúdo acima e depois faça o desafio para testar seu conhecimento!</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 max-w-md mx-auto">
                        <p class="text-sm text-blue-800">
                            <strong>🏆 Desafio:</strong> Acerte 20 perguntas consecutivas<br>
                            <strong>⚠️ Regra:</strong> Uma pergunta errada reinicia tudo<br>
                            <strong>🔀 Sistema:</strong> Perguntas sempre em ordem aleatória
                        </p>
                    </div>
                    <button onclick="window.startQuiz()" class="primary-btn w-auto mx-auto">🚀 Iniciar Desafio</button>
                </div>
            `;
        }

        window.startQuiz = function() {
            // Reset streak variables
            correctStreak = 0;
            totalAttempts = 0;
            currentQuestionIndex = 0;

            // Shuffle all questions to ensure randomness every time
            const shuffled = [...fullQuizData].sort(() => Math.random() - 0.5);
            quizQuestions = shuffled.map(question => {
                // Find correct answer by asterisk (*) and clean options
                let correctIndex = -1;
                const cleanedOptions = question.o.map((option, index) => {
                    if (option.includes('*')) {
                        correctIndex = index;
                        return option.replace('*', ''); // Remove asterisk for display
                    }
                    return option;
                });

                // If no asterisk found, use the original 'a' property
                if (correctIndex === -1) {
                    correctIndex = question.a;
                }

                // Create shuffled options with correct answer tracking
                const optionsWithIndices = cleanedOptions.map((option, index) => ({
                    text: option,
                    originalIndex: index
                }));

                // Shuffle the options
                const shuffledOptions = optionsWithIndices.sort(() => Math.random() - 0.5);

                // Find new correct answer index after shuffling
                const newCorrectIndex = shuffledOptions.findIndex(opt => opt.originalIndex === correctIndex);

                return {
                    ...question,
                    o: shuffledOptions.map(opt => opt.text),
                    a: newCorrectIndex
                };
            });

            showNameInput();
        }

        function showNameInput() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <h3 class="text-xl font-bold mb-4 text-violet-600">🎯 Desafio Pedagógico - Streak Challenge</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <p class="text-stone-700 mb-2"><strong>Objetivo:</strong> Acerte 20 perguntas consecutivas para completar o desafio!</p>
                        <p class="text-red-600 text-sm font-medium">⚠️ Se errar uma pergunta, o desafio reinicia do zero!</p>
                        <p class="text-blue-600 text-sm mt-2">💡 As perguntas sempre aparecem em ordem aleatória</p>
                    </div>
                    <input type="text" id="teacher-name-input" class="form-input mb-4 max-w-sm mx-auto" placeholder="Seu nome completo" required>
                    <button onclick="window.submitName()" class="primary-btn w-auto mx-auto">🚀 Iniciar Desafio</button>
                </div>
            `;
        }

        window.submitName = function() {
            const nameInput = document.getElementById('teacher-name-input');
            teacherName = nameInput.value.trim();

            if (teacherName) {
                showQuestion();
            } else {
                alert('Please enter your name to continue.');
            }
        }

        function showQuestion() {
            // Get current question from shuffled pool
            if (currentQuestionIndex >= quizQuestions.length) {
                // Reshuffle if we've gone through all questions
                const shuffled = [...fullQuizData].sort(() => Math.random() - 0.5);
                quizQuestions = shuffled.map(question => {
                    let correctIndex = -1;
                    const cleanedOptions = question.o.map((option, index) => {
                        if (option.includes('*')) {
                            correctIndex = index;
                            return option.replace('*', '');
                        }
                        return option;
                    });

                    if (correctIndex === -1) {
                        correctIndex = question.a;
                    }

                    const optionsWithIndices = cleanedOptions.map((option, index) => ({
                        text: option,
                        originalIndex: index
                    }));

                    const shuffledOptions = optionsWithIndices.sort(() => Math.random() - 0.5);
                    const newCorrectIndex = shuffledOptions.findIndex(opt => opt.originalIndex === correctIndex);

                    return {
                        ...question,
                        o: shuffledOptions.map(opt => opt.text),
                        a: newCorrectIndex
                    };
                });
                currentQuestionIndex = 0;
            }

            const question = quizQuestions[currentQuestionIndex];
            if (!question) {
                console.error('Question not found at index:', currentQuestionIndex);
                return;
            }

            const quizContainer = document.getElementById('quiz-container');

            quizContainer.innerHTML = `
                <div class="h-full flex flex-col">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-stone-600">Streak: ${correctStreak}/${questionsNeededForSuccess}</span>
                            <span class="text-sm font-medium text-violet-600">Tentativas: ${totalAttempts + 1}</span>
                        </div>
                        <div class="w-full bg-stone-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" style="width: ${(correctStreak / questionsNeededForSuccess) * 100}%"></div>
                        </div>
                        <p class="text-xs text-center mt-1 text-stone-500">
                            ${correctStreak === 0 ? 'Comece seu streak!' : `${questionsNeededForSuccess - correctStreak} restantes para completar!`}
                        </p>
                    </div>

                    <div class="flex-grow flex flex-col justify-center">
                        <h3 class="text-lg font-semibold mb-6">${question.q}</h3>
                        <div id="quiz-options" class="space-y-2">
                            ${question.o.map((option, index) => `
                                <button class="pedagogical-quiz-option" onclick="window.selectAnswer(${index})">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div id="explanation" class="hidden mt-4 p-4 rounded-lg">
                        <p class="text-sm"></p>
                    </div>

                    <div class="mt-6 flex justify-center">
                        <button id="next-btn" onclick="window.nextQuestion()" class="primary-btn w-auto hidden">Próxima Pergunta</button>
                    </div>
                </div>
            `;
        }

        window.selectAnswer = function(selectedIndex) {
            const question = quizQuestions[currentQuestionIndex];
            if (!question) {
                console.error('Question not found at index:', currentQuestionIndex);
                return;
            }

            const options = document.querySelectorAll('.pedagogical-quiz-option');
            const explanation = document.getElementById('explanation');
            const nextBtn = document.getElementById('next-btn');

            // Disable all options
            options.forEach(option => option.disabled = true);

            const isCorrect = selectedIndex === question.a;

            // Show correct/incorrect
            options.forEach((option, index) => {
                if (index === question.a) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });

            // Update streak logic
            if (isCorrect) {
                correctStreak++;
                explanation.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-lg';
                explanation.querySelector('p').className = 'text-sm text-green-800';
                explanation.querySelector('p').innerHTML = `<strong>✅ Correto!</strong> ${question.e}`;

                // Check if challenge is completed
                if (correctStreak >= questionsNeededForSuccess) {
                    setTimeout(() => {
                        showSuccessResult();
                    }, 2000);
                    explanation.classList.remove('hidden');
                    return;
                }
            } else {
                // Reset streak on wrong answer
                correctStreak = 0;
                totalAttempts++;
                explanation.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
                explanation.querySelector('p').className = 'text-sm text-red-800';
                explanation.querySelector('p').innerHTML = `<strong>❌ Incorreto!</strong> Seu streak reiniciou. ${question.e}`;

                // Show restart message
                setTimeout(() => {
                    showRestartMessage();
                }, 3000);
                explanation.classList.remove('hidden');
                return;
            }

            // Show explanation and next button
            explanation.classList.remove('hidden');
            nextBtn.classList.remove('hidden');

            // Track answer
            quizQuestions[currentQuestionIndex].userAnswer = selectedIndex;
        }

        window.nextQuestion = function() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showRestartMessage() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <div class="mb-6">
                        <svg class="w-20 h-20 mx-auto mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <h2 class="text-2xl font-bold mb-2 text-red-600">Streak Reiniciado!</h2>
                        <p class="text-stone-600 mb-4">Você errou uma pergunta. O desafio vai recomeçar do zero.</p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 max-w-md mx-auto">
                            <p class="text-sm text-stone-700">
                                <strong>Tentativas:</strong> ${totalAttempts}<br>
                                <strong>Streak anterior:</strong> Foi resetado para 0<br>
                                <strong>Meta:</strong> 20 perguntas consecutivas corretas
                            </p>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <button onclick="window.startQuiz()" class="primary-btn w-auto mx-auto">🔄 Tentar Novamente</button>
                        <button onclick="showQuizWelcome()" class="secondary-btn w-auto mx-auto">📚 Voltar ao Início</button>
                    </div>
                </div>
            `;
        }

        function showSuccessResult() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <div class="mb-6">
                        <svg class="w-24 h-24 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h2 class="text-3xl font-bold mb-2 text-green-600">🎉 Parabéns, ${teacherName}!</h2>
                        <p class="text-stone-600 mb-4">Você completou o Desafio Pedagógico com sucesso!</p>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 max-w-md mx-auto">
                            <h3 class="text-lg font-semibold text-green-800 mb-3">🏆 Resultado Final</h3>
                            <div class="text-sm text-green-700 space-y-1">
                                <p><strong>✅ Streak Final:</strong> ${correctStreak}/${questionsNeededForSuccess}</p>
                                <p><strong>🎯 Tentativas Total:</strong> ${totalAttempts + 1}</p>
                                <p><strong>📊 Status:</strong> <span class="text-green-600 font-bold">APROVADO</span></p>
                            </div>
                        </div>
                        <p class="text-green-600 font-medium mb-6">
                            Você demonstrou excelente conhecimento sobre Dogme ELT e Lexical Approach!
                        </p>
                    </div>

                    <div class="space-y-2">
                        <button onclick="showQuizWelcome()" class="primary-btn w-auto mx-auto">🏠 Voltar ao Início</button>
                        <button onclick="window.startQuiz()" class="secondary-btn w-auto mx-auto">🔄 Fazer Novamente</button>
                    </div>
                </div>
            `;
        }



        // --- Guidelines Functions ---
        
        // Bulk import function for guidelines
        async function bulkImportGuidelines(guidelinesArray) {
            if (!Array.isArray(guidelinesArray)) {
                showErrorMessage("Erro", "Dados inválidos para importação.");
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const guidelineData of guidelinesArray) {
                try {
                    const guideline = {
                        id: generateId(),
                        title: guidelineData.title || 'Sem título',
                        content: guidelineData.content || '',
                        category: guidelineData.category || 'geral',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser
                    };

                    if (!db) {
                        // Local storage mode
                        let guidelines = JSON.parse(localStorage.getItem('guidelines') || '[]');
                        guidelines.push(guideline);
                        localStorage.setItem('guidelines', JSON.stringify(guidelines));
                    } else {
                        // Firebase mode
                        const docRef = doc(db, `artifacts/${appId}/public/data/guidelines`, guideline.id);
                        await setDoc(docRef, guideline);
                    }
                    
                    successCount++;
                } catch (error) {
                    console.error('Error importing guideline:', guidelineData.title, error);
                    errorCount++;
                }
            }

            // Reload guidelines after import
            await loadGuidelines();
            
            // Show results
            if (errorCount === 0) {
                showSuccessMessage("Importação Concluída", `${successCount} diretrizes importadas com sucesso!`);
            } else {
                showErrorMessage("Importação Parcial", `${successCount} diretrizes importadas. ${errorCount} falharam.`);
            }
        }

        // Make it globally accessible for console usage
        window.bulkImportGuidelines = bulkImportGuidelines;

        // Migration function to move guidelines from localStorage to Firebase
        async function migrateGuidelinesToFirebase() {
            try {
                console.log('Starting guidelines migration to Firebase...');
                
                if (!db) {
                    console.error('Firebase not available for migration');
                    return false;
                }

                // Check if there are guidelines in localStorage
                const localGuidelines = localStorage.getItem('slap-guidelines');
                if (!localGuidelines) {
                    console.log('No guidelines found in localStorage to migrate');
                    return false;
                }

                const parsedGuidelines = JSON.parse(localGuidelines);
                console.log('Found guidelines in localStorage:', parsedGuidelines);

                // Save to Firebase
                const docRef = doc(db, `artifacts/${appId}/public/data`, 'guidelines');
                await setDoc(docRef, parsedGuidelines);
                console.log('Guidelines successfully migrated to Firebase');

                // Remove from localStorage after successful migration
                localStorage.removeItem('slap-guidelines');
                console.log('Guidelines removed from localStorage');

                return true;
            } catch (error) {
                console.error('Error migrating guidelines to Firebase:', error);
                return false;
            }
        }

        // Make migration function globally accessible
        window.migrateGuidelinesToFirebase = migrateGuidelinesToFirebase;





        function addPasso() {
            const container = document.getElementById('passos-container');
            const index = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <span class="text-sm text-stone-500 w-6">${index}.</span>
                <input type="text" class="form-input flex-1 passo-input" placeholder="Descreva este passo do processo">
                <button type="button" data-action="remove-passo" class="text-red-600 hover:text-red-800 p-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;
            container.appendChild(div);
            updatePassoNumbers();
        }

        function removePasso(button) {
            button.parentElement.remove();
            updatePassoNumbers();
        }

        function updatePassoNumbers() {
            const container = document.getElementById('passos-container');
            Array.from(container.children).forEach((child, index) => {
                const span = child.querySelector('span');
                if (span) span.textContent = `${index + 1}.`;
            });
        }

        function addDocumento() {
            const container = document.getElementById('documentos-container');
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="text" class="form-input flex-1 documento-input" placeholder="Nome do documento ou link do Cloudinary">
                <button type="button" data-action="remove-documento" class="text-red-600 hover:text-red-800 p-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;
            container.appendChild(div);
        }

        function removeDocumento(button) {
            button.parentElement.remove();
        }



        function renderDiretrizesSection() {
            document.getElementById('main-title').textContent = 'Diretrizes SLAP';
            const contentArea = document.getElementById('content-area');

            contentArea.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <div class="mb-6 flex justify-between items-center">
                        <input type="text" id="guidelines-search" class="guidelines-search" 
                               placeholder="Buscar diretrizes..." 
                               oninput="filterGuidelines(this.value)">
                        <div class="flex gap-2">
                            <button class="secondary-btn w-auto" data-action="export-guidelines">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Exportar Diretrizes
                            </button>
                            ${['admin', 'pedagogico', 'ap'].includes(currentUserRole) ? `
                            <button class="primary-btn w-auto" data-action="add-guideline">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                Adicionar Diretriz
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h2 class="text-xl font-bold text-green-600 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Boas Práticas
                            </h2>
                            <div id="good-practices-container">
                                <!-- Good practices will be rendered here -->
                            </div>
                            <div id="good-practices-pagination" class="pagination-controls mt-4">
                                <!-- Pagination controls will be rendered here -->
                            </div>
                        </div>

                        <div>
                            <h2 class="text-xl font-bold text-red-600 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Itens Proibidos
                            </h2>
                            <div id="prohibited-items-container">
                                <!-- Prohibited items will be rendered here -->
                            </div>
                            <div id="prohibited-items-pagination" class="pagination-controls mt-4">
                                <!-- Pagination controls will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Guideline Modal -->
                    <div id="guideline-modal" class="modal-overlay">
                        <div class="modal-content max-w-md">
                            <div class="modal-header">
                                <h4 id="guideline-modal-title">Nova Diretriz</h4>
                                <button data-action="close-guideline-modal" class="modal-close-btn">&times;</button>
                            </div>
                            <form id="guideline-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="font-medium text-sm">Tipo</label>
                                        <select id="guideline-type" class="form-input" required>
                                            <option value="good-practice">Boa Prática</option>
                                            <option value="prohibited">Item Proibido</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Título</label>
                                        <input type="text" id="guideline-title" class="form-input" required>
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Descrição</label>
                                        <textarea id="guideline-description" rows="4" class="form-input" required></textarea>
                                    </div>
                                    <div class="flex justify-end gap-2">
                                        <button type="button" data-action="close-guideline-modal" class="secondary-btn">Cancelar</button>
                                        <button type="submit" class="primary-btn w-auto">Salvar</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>


            `;

            loadGuidelines();
        }

        let guidelines = {
            goodPractices: [],
            prohibitedItems: []
        };

        // Pagination variables for guidelines
        let guidelinesPagination = {
            goodPractices: { currentPage: 1, itemsPerPage: 6 },
            prohibitedItems: { currentPage: 1, itemsPerPage: 6 }
        };

        async function loadGuidelines() {
            try {
                console.log('loadGuidelines called, db is:', !!db, 'appId:', appId);
                console.log('Firebase detection - db type:', typeof db, 'db value:', db);
                let loadedGuidelines = null;
                
                if (!db) {
                    // Local storage mode
                    console.log('Loading guidelines from localStorage');
                    const savedGuidelines = localStorage.getItem('slap-guidelines');
                    if (savedGuidelines) {
                        loadedGuidelines = JSON.parse(savedGuidelines);
                        console.log('Guidelines loaded from localStorage:', loadedGuidelines);
                    }
                } else {
                    // Firebase mode
                    try {
                        console.log('Attempting to load guidelines from Firebase...');
                        const docRef = doc(db, `artifacts/${appId}/public/data`, 'guidelines');
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            loadedGuidelines = docSnap.data();
                            console.log('Guidelines loaded from Firebase successfully:', loadedGuidelines);
                        } else {
                            console.log('No guidelines document found in Firebase');
                        }
                    } catch (firebaseError) {
                        console.error('Error loading from Firebase:', firebaseError);
                        // Fallback to localStorage
                        console.log('Falling back to localStorage...');
                        const savedGuidelines = localStorage.getItem('slap-guidelines');
                        if (savedGuidelines) {
                            loadedGuidelines = JSON.parse(savedGuidelines);
                            console.log('Guidelines loaded from localStorage fallback:', loadedGuidelines);
                        }
                    }
                }

                if (loadedGuidelines) {
                    guidelines = loadedGuidelines;
                } else {
                    // Default guidelines if none exist
                    guidelines = {
                        goodPractices: [
                            { id: '1', title: 'Pontualidade nas Aulas', description: 'Sempre chegue às aulas com pelo menos 5 minutos de antecedência para preparar o ambiente e receber os alunos adequadamente.' },
                            { id: '2', title: 'Feedback Construtivo', description: 'Ofereça feedback específico e encorajador aos alunos, focando em aspectos que podem ser melhorados.' },
                            { id: '3', title: 'Material Organizado', description: 'Mantenha todos os materiais didáticos organizados e facilmente acessíveis durante as aulas.' },
                            { id: '4', title: 'Comunicação Clara', description: 'Use linguagem simples e clara, adaptando a complexidade ao nível dos alunos.' }
                        ],
                        prohibitedItems: [
                            { id: '1', title: 'Uso de Celular Durante Aulas', description: 'É proibido o uso de dispositivos móveis para fins pessoais durante o período de aula.' },
                            { id: '2', title: 'Linguagem Inadequada', description: 'Evite o uso de gírias excessivas ou linguagem informal que possa prejudicar o aprendizado.' },
                            { id: '3', title: 'Atraso Frequente', description: 'Atrasos constantes são inaceitáveis e prejudicam o andamento das atividades pedagógicas.' },
                            { id: '4', title: 'Material Não Aprovado', description: 'Não utilize materiais didáticos que não tenham sido aprovados pela coordenação pedagógica.' }
                        ]
                    };
                    await saveGuidelines();
                }
                renderGuidelines();
            } catch (error) {
                console.error('Error in loadGuidelines:', error);
                // Final fallback - use defaults
                guidelines = {
                    goodPractices: [],
                    prohibitedItems: []
                };
                renderGuidelines();
            }
        }

        function renderGuidelines(filter = '') {
            const goodPracticesContainer = document.getElementById('good-practices-container');
            const prohibitedItemsContainer = document.getElementById('prohibited-items-container');

            const filteredGoodPractices = guidelines.goodPractices.filter(item => 
                item.title.toLowerCase().includes(filter.toLowerCase()) || 
                item.description.toLowerCase().includes(filter.toLowerCase())
            );

            const filteredProhibitedItems = guidelines.prohibitedItems.filter(item => 
                item.title.toLowerCase().includes(filter.toLowerCase()) || 
                item.description.toLowerCase().includes(filter.toLowerCase())
            );

            // When filtering, reset pagination to page 1
            if (filter) {
                guidelinesPagination.goodPractices.currentPage = 1;
                guidelinesPagination.prohibitedItems.currentPage = 1;
            }

            // Render Good Practices with pagination
            renderGuidelineSection(
                'goodPractices', 
                filteredGoodPractices, 
                goodPracticesContainer, 
                document.getElementById('good-practices-pagination'),
                'good-practice',
                'text-green-600'
            );

            // Render Prohibited Items with pagination
            renderGuidelineSection(
                'prohibitedItems', 
                filteredProhibitedItems, 
                prohibitedItemsContainer, 
                document.getElementById('prohibited-items-pagination'),
                'prohibited',
                'text-red-600'
            );

            // Show/hide sections based on search results
            const goodPracticesSection = document.querySelector('.grid > div:first-child');
            const prohibitedSection = document.querySelector('.grid > div:last-child');

            if (filter && filteredGoodPractices.length === 0) {
                goodPracticesSection.style.display = 'none';
            } else {
                goodPracticesSection.style.display = 'block';
            }

            if (filter && filteredProhibitedItems.length === 0) {
                prohibitedSection.style.display = 'none';
            } else {
                prohibitedSection.style.display = 'block';
            }
        }

        function renderGuidelineSection(type, items, container, paginationContainer, cardClass, iconColorClass) {
            const pagination = guidelinesPagination[type];
            const startIndex = (pagination.currentPage - 1) * pagination.itemsPerPage;
            const endIndex = startIndex + pagination.itemsPerPage;
            const itemsToShow = items.slice(startIndex, endIndex);
            const totalPages = Math.ceil(items.length / pagination.itemsPerPage);

            // Render items
            container.innerHTML = itemsToShow.map((item, index) => {
                const realIndex = startIndex + index;
                const iconPath = type === 'goodPractices' ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12';

                return `
                    <div class="guideline-card ${cardClass}">
                        <div class="guideline-header">
                            <svg class="guideline-icon w-6 h-6 ${iconColorClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
                            </svg>
                            <div class="flex-1">
                                <h3 class="guideline-title">${item.title}</h3>
                            </div>
                            ${['admin', 'pedagogico', 'ap'].includes(currentUserRole) ? `
                            <button class="secondary-btn !text-xs !py-1 !px-2 ml-2" onclick="editGuidelineItem('${type}', ${realIndex})">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button class="danger-btn !text-xs !py-1 !px-2 ml-1" onclick="deleteGuidelineItem('${type}', ${realIndex})">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                        <p class="guideline-description">${item.description}</p>
                    </div>
                `;
            }).join('');

            // Render pagination controls
            if (totalPages > 1) {
                paginationContainer.innerHTML = `
                    <div class="flex justify-center items-center gap-2">
                        <button 
                            class="pagination-btn ${pagination.currentPage === 1 ? 'disabled' : ''}" 
                            onclick="changeGuidelinePage('${type}', ${pagination.currentPage - 1})"
                            ${pagination.currentPage === 1 ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>

                        <div class="flex gap-1">
                            ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
                                <button 
                                    class="pagination-number ${page === pagination.currentPage ? 'active' : ''}"
                                    onclick="changeGuidelinePage('${type}', ${page})">
                                    ${page}
                                </button>
                            `).join('')}
                        </div>

                        <button 
                            class="pagination-btn ${pagination.currentPage === totalPages ? 'disabled' : ''}" 
                            onclick="changeGuidelinePage('${type}', ${pagination.currentPage + 1})"
                            ${pagination.currentPage === totalPages ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="text-center text-sm text-stone-500 mt-2">
                        Mostrando ${Math.min(startIndex + 1, items.length)}-${Math.min(endIndex, items.length)} de ${items.length} itens
                    </div>
                `;
            } else {
                paginationContainer.innerHTML = '';
            }
        }

        function changeGuidelinePage(type, newPage) {
            const pagination = guidelinesPagination[type];
            const filteredItems = type === 'goodPractices' ? 
                guidelines.goodPractices.filter(item => 
                    item.title.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase()) || 
                    item.description.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase())
                ) :
                guidelines.prohibitedItems.filter(item => 
                    item.title.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase()) || 
                    item.description.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase())
                );

            const totalPages = Math.ceil(filteredItems.length / pagination.itemsPerPage);

            if (newPage >= 1 && newPage <= totalPages) {
                pagination.currentPage = newPage;
                renderGuidelines(document.getElementById('guidelines-search').value);
            }
        }

        function editGuidelineItem(type, realIndex) {
            openGuidelineForm(type, realIndex);
        }

        async function deleteGuidelineItem(type, realIndex) {
            const itemTitle = guidelines[type][realIndex].title;

            if (confirm(`Tem certeza que deseja excluir "${itemTitle}"?`)) {
                guidelines[type].splice(realIndex, 1);
                await saveGuidelines();

                // Adjust current page if necessary
                const pagination = guidelinesPagination[type];
                const totalPages = Math.ceil(guidelines[type].length / pagination.itemsPerPage);
                if (pagination.currentPage > totalPages && totalPages > 0) {
                    pagination.currentPage = totalPages;
                }

                renderGuidelines(document.getElementById('guidelines-search').value);
            }
        }

        function filterGuidelines(searchTerm) {
            renderGuidelines(searchTerm);
        }

        function openGuidelineForm(type = null, index = null) {
            const modal = document.getElementById('guideline-modal');
            const form = document.getElementById('guideline-form');
            const title = document.getElementById('guideline-modal-title');
            
            // Reset form
            form.reset();
            
            if (type !== null && index !== null) {
                // Edit mode
                title.textContent = 'Editar Diretriz';
                const guidelineType = type === 'goodPractices' ? 'good-practice' : 'prohibited';
                const item = guidelines[type][index];
                
                document.getElementById('guideline-type').value = guidelineType;
                document.getElementById('guideline-title').value = item.title;
                document.getElementById('guideline-description').value = item.description;
                
                // Store edit info for saving
                form.dataset.editType = type;
                form.dataset.editIndex = index;
            } else {
                // Add mode
                title.textContent = 'Nova Diretriz';
                delete form.dataset.editType;
                delete form.dataset.editIndex;
            }

            // Add submit event listener
            form.onsubmit = (e) => {
                e.preventDefault();
                saveGuideline(e);
            };

            modal.classList.add('visible');
        }

        // Legacy function kept for compatibility - redirects to new function
        function deleteGuideline(type, index) {
            deleteGuidelineItem(type, index);
        }





        // --- BRAINFLIP GAME SECTION ---
        const flashcardsData = [
            { front: "Teacher Talking Time (TTT)", back: "O tempo que o professor fala durante a aula. O ideal é minimizá-lo para maximizar o STT." },
            { front: "Student Talking Time (STT)", back: "O tempo que os alunos falam durante a aula. Um indicador chave de engajamento e prática." },
            { front: "Lexical Approach", back: "Metodologia que foca no ensino de 'chunks' de linguagem (collocations, fixed expressions) em vez de palavras isoladas." },
            { front: "Comprehensible Input", back: "Linguagem que os alunos conseguem entender, mesmo que contenha estruturas novas (i + 1, segundo Krashen)." },
            { front: "Teoria de Krashen", back: "Cinco hipóteses sobre a aquisição de segunda língua: Aquisição-Aprendizagem, Monitor, Ordem Natural, Input e Filtro Afetivo." },
            { front: "Scaffolding", back: "Suporte temporário dado pelo professor para ajudar o aluno a realizar uma tarefa que ele não faria sozinho, removido gradualmente." },
            { front: "Error Correction", back: "Estratégias para corrigir erros dos alunos, que podem ser diretas, indiretas, recasts, elicitation, etc., dependendo do estágio do erro." },
            { front: "CEFR (Common European Framework of Reference)", back: "Padrão internacional para descrever habilidades linguísticas, com níveis de A1 a C2 (Básico, Independente, Proficiente)." },
            { front: "PPP vs. TBL", back: "PPP é uma abordagem linear (apresenta, pratica, produz). TBL é mais comunicativa, focando em tarefas com um objetivo real." },
            { front: "Task-Based Learning (TBL)", back: "Abordagem onde a aprendizagem ocorre através da realização de tarefas significativas que envolvem a comunicação real da língua." },
            { front: "Dogme", back: "Abordagem de ensino 'unplugged', que minimiza materiais pré-fabricados e foca na linguagem emergente dos alunos." },
            { front: "Formative Assessment", back: "Avaliação contínua realizada durante o processo de aprendizagem para monitorar o progresso e fornecer feedback." },
            { front: "Andragogia", back: "Princípios da educação de adultos, que se diferenciam da pedagogia (educação de crianças) pela autonomia e experiência do aprendiz." },
            { front: "Metodologia ativa", back: "Abordagens de ensino que colocam o aluno no centro do processo, tornando-o protagonista da sua aprendizagem (ex: Aprendizagem Baseada em Projetos)." },
            { front: "Ensino híbrido (Blended Learning)", back: "Combinação de ensino presencial e online, utilizando diferentes modalidades para otimizar a aprendizagem." },
            { front: "CLIL (Content and Language Integrated Learning)", back: "Ensino de uma disciplina (ex: história, ciências) através de uma língua estrangeira, desenvolvendo conteúdo e habilidades linguísticas simultaneamente." },
            { front: "Warm-ups", back: "Atividades curtas no início da aula para engajar os alunos, ativar conhecimentos prévios e prepará-los para o tema." },
            { front: "Cool downs", back: "Atividades no final da aula para revisar o conteúdo, consolidar a aprendizagem ou relaxar e refletir." },
            { front: "ICQs / CCQs", back: "Perguntas curtas para verificar se os alunos entenderam as instruções (ICQs) ou o conceito (CCQs) apresentado." },
            { front: "Autonomy in Learning", back: "Capacidade do aluno de tomar controle de sua própria aprendizagem, definindo metas e escolhendo métodos." }
        ];

        let currentCardIndex = 0;
        let isFlipped = false;

        function renderBrainFlipSection() {
            document.getElementById('main-title').textContent = 'BrainFlip';
            document.getElementById('main-description').textContent = 'Flashcards pedagógicos para professores de inglês. Clique nas cartas para virar e aprender!';

            contentArea.innerHTML = `
                <section class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col items-center justify-center min-h-[70vh]">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-700 mb-8 mt-4 text-center">BrainFlip</h1>
                    <p class="text-lg text-stone-700 mb-8 text-center max-w-2xl">
                        Um jogo interativo de flashcards pedagógicos para professores de inglês. Clique nas cartas para virar e aprender!
                    </p>

                    <div class="flashcard-container mb-8">
                        <div id="flashcard" class="flashcard cursor-pointer" onclick="flipCard()">
                            <div id="flashcard-front" class="flashcard-face flashcard-front"></div>
                            <div id="flashcard-back" class="flashcard-face flashcard-back"></div>
                        </div>
                    </div>

                    <div class="flex items-center justify-center space-x-4 mb-8">
                        <button id="prev-btn" class="navigation-button-game" onclick="previousCard()">
                            Anterior
                        </button>
                        <span id="card-counter" class="text-xl font-semibold text-stone-800">1 / ${flashcardsData.length}</span>
                        <button id="next-btn" class="navigation-button-game" onclick="nextCard()">
                            Próximo
                        </button>
                    </div>
                </section>
            `;

            loadCard(0);
        }

        function loadCard(index) {
            currentCardIndex = index;
            isFlipped = false;

            const flashcard = document.getElementById('flashcard');
            const front = document.getElementById('flashcard-front');
            const back = document.getElementById('flashcard-back');
            const counter = document.getElementById('card-counter');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            // Reset flip state
            flashcard.classList.remove('flipped');

            // Load content
            front.textContent = flashcardsData[index].front;
            back.textContent = flashcardsData[index].back;

            // Update counter
            counter.textContent = `${index + 1} / ${flashcardsData.length}`;

            // Update button states
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === flashcardsData.length - 1;
        }

        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            flashcard.classList.toggle('flipped');
            isFlipped = !isFlipped;
        }

        function nextCard() {
            if (currentCardIndex < flashcardsData.length - 1) {
                loadCard(currentCardIndex + 1);
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                loadCard(currentCardIndex - 1);
            }
        }

        async function saveGuideline(event) {
            event.preventDefault();
            
            const form = event.target;
            const type = document.getElementById('guideline-type').value;
            const title = document.getElementById('guideline-title').value;
            const description = document.getElementById('guideline-description').value;

            const guidelineData = {
                title: title,
                description: description
            };
            
            if (form.dataset.editType && form.dataset.editIndex !== undefined) {
                // Edit mode
                const editIndex = parseInt(form.dataset.editIndex);
                guidelines[form.dataset.editType][editIndex] = {
                    ...guidelines[form.dataset.editType][editIndex],
                    ...guidelineData
                };
                showSuccessMessage("Sucesso!", "Diretriz atualizada com sucesso.");
            } else {
                // Add mode
                const newGuideline = {
                    id: Date.now().toString(),
                    ...guidelineData
                };
                
                if (type === 'good-practice') {
                    guidelines.goodPractices.push(newGuideline);
                } else {
                    guidelines.prohibitedItems.push(newGuideline);
                }
                showSuccessMessage("Sucesso!", "Diretriz adicionada com sucesso.");
            }

            await saveGuidelines();
            renderGuidelines(document.getElementById('guidelines-search').value);

            // Close modal and reset form
            document.getElementById('guideline-modal').classList.remove('visible');
            document.getElementById('guideline-form').reset();
        }

        function exportAlunosDoc() {
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);
            let studentsList = '';
            // Export all students (not just active ones) to have complete data
            const allStudents = students.sort((a, b) => a.name.localeCompare(b.name));
            
            if (canViewFinancialInfo) {
                studentsList = allStudents.map(s => `
                    <tr>
                        <td class="student-name">${s.name}</td>
                        <td>${s.status || 'N/A'}</td>
                        <td>${s.modalidade || 'TURMA'}</td>
                        <td>R$ ${parseFloat(s.amountPaid || 0).toFixed(2)}</td>
                        <td>${s.tipoAssinatura || 'N/A'}</td>
                        <td>${s.quantidadeParcelas || 'N/A'}</td>
                        <td>${s.responsibleName || 'N/A'}</td>
                        <td>${s.responsibleEmail || 'N/A'}</td>
                        <td>${s.responsiblePhone || 'N/A'}</td>
                        <td>${s.emergencyContact || 'N/A'}</td>
                        <td>${s.emergencyPhone || 'N/A'}</td>
                        <td>${s.level || 'N/A'}</td>
                        <td>${s.birthDate || 'N/A'}</td>
                        <td>${s.address || 'N/A'}</td>
                        <td>${s.indicacao || 'N/A'}</td>
                        <td>${s.observations || 'N/A'}</td>
                    </tr>
                `).join('');
                if (!studentsList) { studentsList = '<tr><td colspan="16">Nenhum aluno encontrado.</td></tr>'; }
            } else {
                studentsList = allStudents.map(s => `
                    <tr>
                        <td class="student-name">${s.name}</td>
                        <td>${s.status || 'N/A'}</td>
                        <td>${s.modalidade || 'TURMA'}</td>
                        <td>${s.responsibleName || 'N/A'}</td>
                        <td>${s.responsibleEmail || 'N/A'}</td>
                        <td>${s.responsiblePhone || 'N/A'}</td>
                        <td>${s.emergencyContact || 'N/A'}</td>
                        <td>${s.emergencyPhone || 'N/A'}</td>
                        <td>${s.level || 'N/A'}</td>
                        <td>${s.birthDate || 'N/A'}</td>
                        <td>${s.address || 'N/A'}</td>
                        <td>${s.indicacao || 'N/A'}</td>
                        <td>${s.observations || 'N/A'}</td>
                    </tr>
                `).join('');
                if (!studentsList) { studentsList = '<tr><td colspan="13">Nenhum aluno encontrado.</td></tr>'; }
            }

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Lista Completa de Alunos - SLAP</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; }
                        h1 { color: #333; text-align: center; margin-bottom: 30px; }
                        .header-info { text-align: center; margin-bottom: 20px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .student-name { font-weight: bold; }
                        @media print {
                            body { margin: 10px; }
                            table { font-size: 10px; }
                            th, td { padding: 4px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Lista Completa de Alunos - SLAP</h1>
                    <div class="header-info">
                        <p>Data de Exportação: ${formatDateBR(new Date())}</p>
                        <p>Total de Alunos: ${allStudents.length}</p>
                        <p>Ativos: ${allStudents.filter(s => s.status === 'Ativo').length} | Cancelados: ${allStudents.filter(s => s.status === 'Cancelado').length} | Outros: ${allStudents.filter(s => s.status !== 'Ativo' && s.status !== 'Cancelado').length}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome do Aluno</th>
                                <th>Status</th>
                                <th>Modalidade</th>
                                ${canViewFinancialInfo ? '<th>Valor Pago</th>' : ''}
                                ${canViewFinancialInfo ? '<th>Tipo Assinatura</th>' : ''}
                                ${canViewFinancialInfo ? '<th>Qtd. Parcelas</th>' : ''}
                                <th>Responsável</th>
                                <th>Email Responsável</th>
                                <th>Telefone Responsável</th>
                                <th>Contato Emergência</th>
                                <th>Tel. Emergência</th>
                                <th>Nível</th>
                                <th>Data Nascimento</th>
                                <th>Endereço</th>
                                <th>Indicação</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentsList}
                        </tbody>
                    </table>
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>Documento gerado pelo Hub SLAP - Speaking Like a Pro</p>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow("Lista Completa de Alunos", docHtml);
        }

        function exportGuidelinesDoc() {
            // Get all guidelines data
            let allGuidelines = [];
            
            // Add good practices
            if (guidelines.goodPractices && guidelines.goodPractices.length > 0) {
                allGuidelines = allGuidelines.concat(
                    guidelines.goodPractices.map(g => ({...g, type: 'Boa Prática', typeClass: 'good-practice'}))
                );
            }
            
            // Add prohibited items
            if (guidelines.prohibitedItems && guidelines.prohibitedItems.length > 0) {
                allGuidelines = allGuidelines.concat(
                    guidelines.prohibitedItems.map(g => ({...g, type: 'Item Proibido', typeClass: 'prohibited'}))
                );
            }

            // Sort alphabetically by title
            allGuidelines.sort((a, b) => a.title.localeCompare(b.title));

            let guidelinesList = '';
            if (allGuidelines.length > 0) {
                guidelinesList = allGuidelines.map(g => `
                    <tr class="${g.typeClass}">
                        <td class="guideline-type">${g.type}</td>
                        <td class="guideline-title">${g.title}</td>
                        <td class="guideline-description">${g.description}</td>
                    </tr>
                `).join('');
            } else {
                guidelinesList = '<tr><td colspan="3">Nenhuma diretriz encontrada.</td></tr>';
            }

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Diretrizes SLAP - Documento Completo</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; line-height: 1.6; }
                        h1 { color: #333; text-align: center; margin-bottom: 30px; }
                        .header-info { text-align: center; margin-bottom: 30px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 12px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .guideline-type { font-weight: bold; text-align: center; width: 120px; }
                        .guideline-title { font-weight: bold; width: 200px; }
                        .guideline-description { line-height: 1.5; }
                        .good-practice .guideline-type { color: #10B981; }
                        .prohibited .guideline-type { color: #EF4444; }
                        .good-practice { border-left: 4px solid #10B981; }
                        .prohibited { border-left: 4px solid #EF4444; }
                        .section-break { margin: 40px 0; text-align: center; color: #666; }
                        @media print {
                            body { margin: 10px; }
                            table { font-size: 12px; }
                            th, td { padding: 8px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Diretrizes SLAP - Documento Completo</h1>
                    <div class="header-info">
                        <p>Data de Exportação: ${formatDateBR(new Date())}</p>
                        <p>Total de Diretrizes: ${allGuidelines.length}</p>
                        <p>Boas Práticas: ${guidelines.goodPractices ? guidelines.goodPractices.length : 0} | Itens Proibidos: ${guidelines.prohibitedItems ? guidelines.prohibitedItems.length : 0}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Título</th>
                                <th>Descrição</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${guidelinesList}
                        </tbody>
                    </table>
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>Documento gerado pelo Hub SLAP - Speaking Like a Pro</p>
                        <p>Este documento contém as diretrizes oficiais da escola para orientação dos colaboradores.</p>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow("Diretrizes SLAP", docHtml);
        }

        function openVipNotasModal(vipId) {
            const vip = vips.find(v => v.id === vipId);
            if (!vip) { showErrorMessage("Erro", "Aluno VIP não encontrado."); return; }
            const student = students.find(s => s.id === vip.studentId);
            if (!student) { showErrorMessage("Erro", "Dados do aluno não encontrados."); return; }

            clearModalHeaderButtons();
            const modalTitle = document.getElementById('form-modal-title');
            modalTitle.textContent = `Notas: ${student.name}`;
            
            // Load existing grades or set defaults
            const grades = vip.grades || {
                midtermTest: 0,
                listeningTest: 0,
                grammarTest: 0,
                oralTest: 0,
                participacao: 0,
                assiduidade: 0
            };
            
            // Auto-calculate attendance for VIP if not manually set
            const autoAttendance = calculateVipAttendanceScore(vip.id);
            if (autoAttendance !== null && grades.assiduidade === 0) {
                grades.assiduidade = autoAttendance;
            }

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="notas-form" class="space-y-4">
                    <input type="hidden" id="vip-id" value="${vipId}">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="font-medium text-sm">Midterm Test (0-20)</label>
                            <input type="number" id="midterm-test" class="form-input" min="0" max="20" step="any" value="${grades.midtermTest}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Listening Test (0-20)</label>
                            <input type="number" id="listening-test" class="form-input" min="0" max="20" step="any" value="${grades.listeningTest}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Grammar Test (0-20)</label>
                            <input type="number" id="grammar-test" class="form-input" min="0" max="20" step="any" value="${grades.grammarTest}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Oral Test (0-20)</label>
                            <input type="number" id="oral-test" class="form-input" min="0" max="20" step="any" value="${grades.oralTest}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Participação (0-10)</label>
                            <input type="number" id="participacao" class="form-input" min="0" max="10" step="any" value="${grades.participacao}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Assiduidade (0-10) ${autoAttendance !== null ? `<small style="color: #6b7280;">Auto: ${autoAttendance.toFixed(1)}</small>` : ''}</label>
                            <input type="number" id="assiduidade" class="form-input" min="0" max="10" step="any" value="${grades.assiduidade}" 
                                   placeholder="${autoAttendance !== null ? `Auto: ${autoAttendance.toFixed(1)}` : '0.0'}"
                                   title="${autoAttendance !== null ? `Calculado automaticamente baseado nas presenças (${autoAttendance.toFixed(1)}). Você pode alterar manualmente se necessário.` : 'Insira a nota de assiduidade manualmente'}">
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-stone-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">Total:</span>
                            <span id="total-score" class="text-xl font-bold">0</span>
                        </div>
                        <div class="mt-2">
                            <span id="approval-status" class="font-medium"></span>
                        </div>
                        <div class="text-sm text-stone-600 mt-1">
                            Necessário 70 pontos para aprovação
                        </div>
                        ${autoAttendance !== null ? `
                        <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm">
                            <div class="flex items-center gap-2 text-yellow-800">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium">Assiduidade Calculada Automaticamente: ${autoAttendance.toFixed(1)}</span>
                            </div>
                            <div class="text-yellow-700 mt-1">
                                Baseado no registro de presenças. Você pode alterar manualmente se necessário.
                            </div>
                        </div>` : ''}
                    </div>
                    
                    <div class="flex justify-between gap-2">
                        <button type="button" id="export-vip-btn" data-vip-id="${vipId}" class="secondary-btn">Exportar Report Card</button>
                        <div class="flex gap-2">
                            <button type="button" data-action="close-modal" class="secondary-btn">Cancelar</button>
                            <button type="submit" class="primary-btn">Salvar Notas</button>
                        </div>
                    </div>
                </form>
            `;
            
            // Add event listeners to calculate total in real time
            setTimeout(() => {
                const inputs = ['midterm-test', 'listening-test', 'grammar-test', 'oral-test', 'participacao', 'assiduidade'];
                inputs.forEach(inputId => {
                    document.getElementById(inputId).addEventListener('input', calculateTotal);
                });
                calculateTotal(); // Initial calculation
            }, 100);

            document.getElementById('notas-form').onsubmit = saveVipGrades;
            
            // Add export button event listener
            setTimeout(() => {
                const exportBtn = document.getElementById('export-vip-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        exportVipReportCard(exportBtn.dataset.vipId);
                    });
                }
            }, 100);
            
            document.getElementById('form-modal').classList.add('visible');
        }

        function openTurmaNotasModal(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma não encontrada."); return; }

            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            modalTitle.textContent = `Notas: ${turma.name}`;
            
            // Get students in this class
            const turmaStudents = students.filter(s => 
                (turma.studentIds || []).includes(s.id) && (s.modalidade === 'TURMA' || s.modalidade === 'DUPLA')
            );

            // Add export buttons to modal header
            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar Report Card Completo';
            exportButton.id = 'export-turma-btn';
            exportButton.dataset.turmaId = turmaId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));

            // Dropdown de exportação individual por aluno
            const exportStudentDropdown = document.createElement('div');
            exportStudentDropdown.className = 'relative inline-block ml-2';
            exportStudentDropdown.innerHTML = `
                <button type="button" class="secondary-btn w-auto dropdown-toggle" id="export-student-btn-${turmaId}">
                    Exportar por Aluno
                    <svg class="w-4 h-4 ml-2 inline" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div class="dropdown-menu absolute left-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden" id="export-student-menu-${turmaId}">
                    ${turmaStudents.map(student => `
                        <button type="button" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded" 
                                data-action="export-student-report-card" 
                                data-turma-id="${turmaId}" 
                                data-student-id="${student.id}">
                            ${student.name}
                        </button>
                    `).join('')}
                </div>
            `;
            modalHeader.insertBefore(exportStudentDropdown, modalHeader.querySelector('.modal-close-btn'));

            // Add JavaScript for dropdown
            setTimeout(() => {
                const dropdownBtn = document.getElementById(`export-student-btn-${turmaId}`);
                const dropdownMenu = document.getElementById(`export-student-menu-${turmaId}`);
                
                if (dropdownBtn && dropdownMenu) {
                    dropdownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdownMenu.classList.toggle('hidden');
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!exportStudentDropdown.contains(e.target)) {
                            dropdownMenu.classList.add('hidden');
                        }
                    });
                }
            }, 100);

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-6 max-h-96 overflow-y-auto">
                    <input type="hidden" id="turma-id" value="${turmaId}">
                    
                    ${turmaStudents.length === 0 ? `
                        <div class="text-center py-8 text-stone-500">
                            Nenhum aluno encontrado nesta turma.
                        </div>
                    ` : turmaStudents.map(student => {
                        const grades = (turma.studentGrades && turma.studentGrades[student.id]) || {
                            midtermTest: 0,
                            listeningTest: 0,
                            grammarTest: 0,
                            oralTest: 0,
                            participacao: 0,
                            assiduidade: 0
                        };
                        
                        // Auto-calculate attendance score if not manually set
                        const autoAttendance = calculateAttendanceScore(student.id, turmaId);
                        if (autoAttendance !== null && grades.assiduidade === 0) {
                            grades.assiduidade = autoAttendance;
                        }
                        
                        return `
                        <div class="border border-stone-200 rounded-lg p-4">
                            <h4 class="font-semibold text-lg mb-4">${student.name}</h4>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="font-medium text-sm">Midterm Test (0-20)</label>
                                    <input type="number" id="midterm-${student.id}" class="form-input student-grade" min="0" max="20" step="any" value="${grades.midtermTest}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Listening Test (0-20)</label>
                                    <input type="number" id="listening-${student.id}" class="form-input student-grade" min="0" max="20" step="any" value="${grades.listeningTest}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Grammar Test (0-20)</label>
                                    <input type="number" id="grammar-${student.id}" class="form-input student-grade" min="0" max="20" step="any" value="${grades.grammarTest}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Oral Test (0-20)</label>
                                    <input type="number" id="oral-${student.id}" class="form-input student-grade" min="0" max="20" step="any" value="${grades.oralTest}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Participação (0-10)</label>
                                    <input type="number" id="participacao-${student.id}" class="form-input student-grade" min="0" max="10" step="any" value="${grades.participacao}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Assiduidade (0-10) ${autoAttendance !== null ? `<small style="color: #6b7280;">Auto: ${autoAttendance.toFixed(1)}</small>` : ''}</label>
                                    <input type="number" id="assiduidade-${student.id}" class="form-input student-grade" min="0" max="10" step="any" value="${grades.assiduidade}" data-student="${student.id}" 
                                           placeholder="${autoAttendance !== null ? `Auto: ${autoAttendance.toFixed(1)}` : '0.0'}"
                                           title="${autoAttendance !== null ? `Calculado automaticamente baseado nas presenças (${autoAttendance.toFixed(1)}). Você pode alterar manualmente se necessário.` : 'Insira a nota de assiduidade manualmente'}">
                                </div>
                            </div>
                            
                            <div class="p-3 bg-stone-50 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Total:</span>
                                    <span id="total-${student.id}" class="text-xl font-bold">0</span>
                                </div>
                                <div class="mt-1">
                                    <span id="status-${student.id}" class="font-medium"></span>
                                </div>

                            </div>
                        </div>
                        `;
                    }).join('')}
                    
                    ${turmaStudents.some(s => {
                        const autoAttendance = calculateAttendanceScore(s.id, turmaId);
                        return autoAttendance !== null;
                    }) ? `
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-center gap-2 text-yellow-800">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-medium">Sistema de Assiduidade Automática Ativo</span>
                        </div>
                        <div class="text-yellow-700 mt-1">
                            As notas de assiduidade foram calculadas automaticamente baseadas no registro de presenças. 
                            Você pode editá-las manualmente conforme necessário.
                        </div>
                    </div>` : ''}
                    
                    <div class="flex justify-end gap-2 pt-4 border-t">
                        <button type="button" data-action="close-modal" class="secondary-btn">Cancelar</button>
                        <button type="button" onclick="saveTurmaGrades()" class="primary-btn">Salvar Todas as Notas</button>
                    </div>
                </div>
            `;
            
            // Add event listeners to calculate totals in real time
            setTimeout(() => {
                document.querySelectorAll('.student-grade').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const studentId = e.target.dataset.student;
                        calculateStudentTotal(studentId);
                    });
                });
                
                // Initial calculations for all students
                turmaStudents.forEach(student => {
                    calculateStudentTotal(student.id);
                });
                
                // Add export button event listener
                const exportBtn = document.getElementById('export-turma-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        exportTurmaReportCard(exportBtn.dataset.turmaId);
                    });
                }
            }, 100);

            document.getElementById('form-modal').classList.add('visible');
        }

        function calculateTotal() {
            const midtermEl = document.getElementById('midterm-test');
            const listeningEl = document.getElementById('listening-test');
            const grammarEl = document.getElementById('grammar-test');
            const oralEl = document.getElementById('oral-test');
            const participacaoEl = document.getElementById('participacao');
            const assiduidadeEl = document.getElementById('assiduidade');

            const midterm = parseFloat(midtermEl.value) || 0;
            const listening = parseFloat(listeningEl.value) || 0;
            const grammar = parseFloat(grammarEl.value) || 0;
            const oral = parseFloat(oralEl.value) || 0;
            const participacao = parseFloat(participacaoEl.value) || 0;
            const assiduidade = parseFloat(assiduidadeEl.value) || 0;

            // Check if any field is empty or zero
            const hasEmptyFields = !midtermEl.value || !listeningEl.value || !grammarEl.value || 
                                 !oralEl.value || !participacaoEl.value || !assiduidadeEl.value;

            const total = midterm + listening + grammar + oral + participacao + assiduidade;
            
            document.getElementById('total-score').textContent = total.toFixed(1);
            
            const statusElement = document.getElementById('approval-status');
            if (hasEmptyFields) {
                statusElement.textContent = '⏳ PENDENTE';
                statusElement.className = 'font-medium text-yellow-600';
            } else if (total >= 70) {
                statusElement.textContent = '✓ APROVADO';
                statusElement.className = 'font-medium text-green-600';
            } else {
                statusElement.textContent = '✗ REPROVADO';
                statusElement.className = 'font-medium text-red-600';
            }
        }

        function calculateAttendanceScore(studentId, turmaId) {
            // Find attendance record for this turma
            const unitAttendance = attendance.find(a => a.id === turmaId);
            if (!unitAttendance || !unitAttendance.lessons) {
                return null; // No attendance data available
            }
            
            let totalLessons = 0;
            let presentLessons = 0;
            
            // Count all lessons that have been registered
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance.lessons[i];
                if (lessonData && lessonData.students && lessonData.students[studentId]) {
                    totalLessons++;
                    const status = lessonData.students[studentId];
                    // Count P (Presente) and PP (Presença Parcial) as attendance
                    if (status === 'P' || status === 'PP') {
                        presentLessons++;
                    }
                    // PP counts as 0.5 attendance
                    if (status === 'PP') {
                        presentLessons -= 0.5;
                    }
                }
            }
            
            if (totalLessons === 0) {
                return null; // No lessons registered yet
            }
            
            // Calculate attendance percentage and convert to 0-10 scale
            const attendancePercentage = presentLessons / totalLessons;
            const attendanceScore = Math.round(attendancePercentage * 10 * 10) / 10; // Round to 1 decimal
            
            return Math.min(10, Math.max(0, attendanceScore)); // Ensure within 0-10 range
        }

        function calculateVipAttendanceScore(vipId) {
            // Find attendance record for this VIP
            const unitAttendance = attendance.find(a => a.id === vipId);
            if (!unitAttendance || !unitAttendance.lessons) {
                return null; // No attendance data available
            }
            
            let totalLessons = 0;
            let presentLessons = 0;
            
            // Count all lessons that have been registered for VIP
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance.lessons[i];
                if (lessonData && lessonData.date) { // VIP lessons with date are considered registered
                    totalLessons++;
                    
                    // Check the actual status - VIPs use same structure as turmas but simpler
                    const status = lessonData.status;
                    if (status === 'P') {
                        presentLessons++;
                    } else if (status === 'PP') {
                        presentLessons += 0.5; // Partial presence counts as 0.5
                    }
                    // 'F' or undefined counts as 0 (absent)
                }
            }
            
            if (totalLessons === 0) {
                return null; // No lessons registered yet
            }
            
            // Calculate attendance percentage and convert to 0-10 scale
            const attendancePercentage = presentLessons / totalLessons;
            const attendanceScore = Math.round(attendancePercentage * 10 * 10) / 10; // Round to 1 decimal
            
            console.log(`VIP ${vipId}: ${presentLessons}/${totalLessons} = ${attendancePercentage.toFixed(2)} = ${attendanceScore}`);
            
            return Math.min(10, Math.max(0, attendanceScore)); // Ensure within 0-10 range
        }

        function calculateStudentTotal(studentId) {
            const midtermEl = document.getElementById(`midterm-${studentId}`);
            const listeningEl = document.getElementById(`listening-${studentId}`);
            const grammarEl = document.getElementById(`grammar-${studentId}`);
            const oralEl = document.getElementById(`oral-${studentId}`);
            const participacaoEl = document.getElementById(`participacao-${studentId}`);
            const assiduidadeEl = document.getElementById(`assiduidade-${studentId}`);

            const midterm = parseFloat(midtermEl.value) || 0;
            const listening = parseFloat(listeningEl.value) || 0;
            const grammar = parseFloat(grammarEl.value) || 0;
            const oral = parseFloat(oralEl.value) || 0;
            const participacao = parseFloat(participacaoEl.value) || 0;
            const assiduidade = parseFloat(assiduidadeEl.value) || 0;
            
            // Check if any field is empty
            const hasEmptyFields = !midtermEl.value || !listeningEl.value || !grammarEl.value || 
                                 !oralEl.value || !participacaoEl.value || !assiduidadeEl.value;
            
            const total = midterm + listening + grammar + oral + participacao + assiduidade;
            
            document.getElementById(`total-${studentId}`).textContent = total.toFixed(1);
            
            const statusElement = document.getElementById(`status-${studentId}`);
            if (hasEmptyFields) {
                statusElement.textContent = '⏳ PENDENTE';
                statusElement.className = 'font-medium text-yellow-600';
            } else if (total >= 70) {
                statusElement.textContent = '✓ APROVADO';
                statusElement.className = 'font-medium text-green-600';
            } else {
                statusElement.textContent = '✗ REPROVADO';
                statusElement.className = 'font-medium text-red-600';
            }
        }

        async function saveVipGrades(event) {
            if (event) event.preventDefault();
            console.log('saveVipGrades called');
            
            const vipIdInput = document.getElementById('vip-id');
            if (!vipIdInput) {
                console.error('vip-id input not found');
                showErrorMessage("Erro", "ID do VIP não encontrado.");
                return;
            }
            
            const vipId = vipIdInput.value;
            console.log('Saving grades for VIP:', vipId);
            
            const gradeElements = {
                midtermTest: document.getElementById('midterm-test'),
                listeningTest: document.getElementById('listening-test'),
                grammarTest: document.getElementById('grammar-test'),
                oralTest: document.getElementById('oral-test'),
                participacao: document.getElementById('participacao'),
                assiduidade: document.getElementById('assiduidade')
            };
            
            // Check if all grade elements exist
            const missingElements = Object.keys(gradeElements).filter(key => !gradeElements[key]);
            if (missingElements.length > 0) {
                console.error('Missing grade elements:', missingElements);
                showErrorMessage("Erro", "Alguns campos de nota não foram encontrados.");
                return;
            }
            
            const grades = {
                midtermTest: parseFloat(gradeElements.midtermTest.value) || 0,
                listeningTest: parseFloat(gradeElements.listeningTest.value) || 0,
                grammarTest: parseFloat(gradeElements.grammarTest.value) || 0,
                oralTest: parseFloat(gradeElements.oralTest.value) || 0,
                participacao: parseFloat(gradeElements.participacao.value) || 0,
                assiduidade: parseFloat(gradeElements.assiduidade.value) || 0
            };
            
            console.log('Collected VIP grades:', grades);
            
            try {
                if (!db) {
                    // Local storage mode
                    console.log('Using localStorage mode for VIP');
                    const vipIndex = vips.findIndex(v => v.id === vipId);
                    console.log('Found VIP at index:', vipIndex);
                    if (vipIndex !== -1) {
                        vips[vipIndex].grades = grades;
                        localStorage.setItem('demo-vips', JSON.stringify(vips));
                        console.log('VIP grades saved to localStorage');
                    } else {
                        throw new Error('VIP não encontrado');
                    }
                } else {
                    // Firebase mode
                    console.log('Using Firebase mode for VIP');
                    const docRef = doc(db, `artifacts/${appId}/public/data/vips`, vipId);
                    await updateDoc(docRef, { grades });
                    console.log('VIP grades saved to Firebase');
                }
                
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso", "Notas salvas com sucesso!");
                console.log('VIP save completed successfully');
                
            } catch (error) {
                console.error('Error saving VIP grades:', error);
                showErrorMessage("Erro", `Erro ao salvar as notas: ${error.message}`);
            }
        }

        async function saveTurmaGrades() {
            console.log('saveTurmaGrades called');
            const turmaIdInput = document.getElementById('turma-id');
            if (!turmaIdInput) {
                console.error('turma-id input not found');
                showErrorMessage("Erro", "ID da turma não encontrado.");
                return;
            }
            
            const turmaId = turmaIdInput.value;
            console.log('Saving grades for turma:', turmaId);
            
            const studentGrades = {};
            
            // Collect all student grades
            const gradeInputs = document.querySelectorAll('.student-grade');
            console.log('Found grade inputs:', gradeInputs.length);
            
            gradeInputs.forEach(input => {
                const studentId = input.dataset.student;
                const fieldType = input.id.split('-')[0];
                const value = parseFloat(input.value) || 0;
                
                console.log(`Processing ${fieldType} for student ${studentId}: ${value}`);
                console.log(`Input ID: ${input.id}, Input value: ${input.value}, Dataset student: ${input.dataset.student}`);
                
                if (!studentGrades[studentId]) {
                    studentGrades[studentId] = {};
                }
                
                if (fieldType === 'participacao' || fieldType === 'assiduidade') {
                    studentGrades[studentId][fieldType] = value;
                    console.log(`Saved ${fieldType} = ${value} for student ${studentId}`);
                } else {
                    studentGrades[studentId][fieldType + 'Test'] = value;
                    console.log(`Saved ${fieldType}Test = ${value} for student ${studentId}`);
                }
            });
            
            console.log('Collected student grades:', studentGrades);
            
            try {
                if (!db) {
                    // Local storage mode
                    console.log('Using localStorage mode');
                    const turmaIndex = turmas.findIndex(t => t.id === turmaId);
                    console.log('Found turma at index:', turmaIndex);
                    if (turmaIndex !== -1) {
                        turmas[turmaIndex].studentGrades = studentGrades;
                        localStorage.setItem('demo-turmas', JSON.stringify(turmas));
                        console.log('Saved to localStorage');
                    } else {
                        throw new Error('Turma não encontrada');
                    }
                } else {
                    // Firebase mode
                    console.log('Using Firebase mode');
                    const docRef = doc(db, `artifacts/${appId}/public/data/turmas`, turmaId);
                    await updateDoc(docRef, { studentGrades });
                    console.log('Saved to Firebase');
                }
                
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso", "Notas da turma salvas com sucesso!");
                console.log('Save completed successfully');
                
            } catch (error) {
                console.error('Error saving turma grades:', error);
                showErrorMessage("Erro", `Erro ao salvar as notas: ${error.message}`);
            }
        }

        function exportVipReportCard(vipId) {
            const vip = vips.find(v => v.id === vipId);
            if (!vip) { showErrorMessage("Erro", "Aluno VIP não encontrado."); return; }
            const student = students.find(s => s.id === vip.studentId);
            if (!student) { showErrorMessage("Erro", "Dados do aluno não encontrados."); return; }

            // Get current grades from form or stored data
            const grades = vip.grades || {
                midtermTest: 0,
                listeningTest: 0,
                grammarTest: 0,
                oralTest: 0,
                participacao: 0,
                assiduidade: 0
            };

            // Try to get current values from form if open
            const formElements = {
                midtermTest: document.getElementById('midterm-test'),
                listeningTest: document.getElementById('listening-test'),
                grammarTest: document.getElementById('grammar-test'),
                oralTest: document.getElementById('oral-test'),
                participacao: document.getElementById('participacao'),
                assiduidade: document.getElementById('assiduidade')
            };

            // Update grades with current form values if available
            Object.keys(formElements).forEach(key => {
                if (formElements[key]) {
                    grades[key] = parseFloat(formElements[key].value) || 0;
                }
            });

            const total = grades.midtermTest + grades.listeningTest + grades.grammarTest + grades.oralTest + grades.participacao + grades.assiduidade;
            
            // Check if any grade is missing or zero (indicating incomplete assessment)
            const hasIncompleteGrades = grades.midtermTest === 0 || grades.listeningTest === 0 || grades.grammarTest === 0 || 
                                       grades.oralTest === 0 || grades.participacao === 0 || grades.assiduidade === 0;
            
            const status = hasIncompleteGrades ? 'PENDENTE' : (total >= 70 ? 'APROVADO' : 'REPROVADO');
            const teacher = collaborators.find(c => c.id === vip.teacherId);

            const reportHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Report Card - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'DM Sans', 'Arial', sans-serif; line-height: 1.5; color: #2d3748; background: #ffffff; }
                        .container { max-width: 800px; margin: 0 auto; background: white; }
                        .header { background: #F1D24B; padding: 40px 40px 30px 40px; position: relative; }
                        .logo-section { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .logo svg { width: 50px; height: 50px; fill: #F1D24B; }
                        .school-info { text-align: left; }
                        .school-name { font-size: 2.2em; font-weight: 700; color: #1a202c; letter-spacing: -0.02em; }
                        .school-subtitle { font-size: 1.1em; color: #4a5568; font-weight: 400; margin-top: 5px; }
                        .report-title { text-align: center; font-size: 1.4em; font-weight: 600; color: #1a202c; margin-top: 25px; letter-spacing: 0.05em; }
                        .content { padding: 40px; }
                        .student-info { border: 2px solid #F1D24B; padding: 25px; margin-bottom: 30px; }
                        .student-info h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
                        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
                        .info-label { color: #4a5568; font-weight: 500; }
                        .info-value { color: #1a202c; font-weight: 600; }
                        .grades-section { margin-bottom: 30px; }
                        .grades-section h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .grades-table { width: 100%; border-collapse: collapse; }
                        .grades-table th { background: #F1D24B; color: #1a202c; font-weight: 600; padding: 15px 12px; text-align: left; font-size: 0.95em; }
                        .grades-table td { padding: 15px 12px; border-bottom: 1px solid #e2e8f0; }
                        .grades-table tr:last-child td { border-bottom: none; }
                        .score { font-weight: 600; color: #1a202c; }
                        .percentage { color: #4a5568; font-size: 0.9em; }
                        .total-section { border: 2px solid #F1D24B; padding: 30px; text-align: center; margin: 30px 0; background: #fffdf0; }
                        .total-label { font-size: 1.1em; color: #4a5568; margin-bottom: 10px; }
                        .total-score { font-size: 3em; font-weight: 700; color: #1a202c; margin-bottom: 15px; }
                        .status { font-size: 1.3em; font-weight: 600; margin-bottom: 15px; }
                        .status.aprovado { color: #38a169; }
                        .status.reprovado { color: #e53e3e; }
                        .status-description { color: #4a5568; font-size: 0.95em; line-height: 1.4; }
                        .footer { border-top: 1px solid #e2e8f0; padding: 30px; text-align: center; color: #4a5568; }
                        .footer-title { font-weight: 600; font-size: 1em; margin-bottom: 5px; }
                        .footer-date { font-size: 0.9em; }
                        .print-btn { background: #F1D24B; color: #1a202c; border: none; padding: 12px 24px; font-weight: 600; cursor: pointer; margin: 20px 0; transition: all 0.2s; }
                        .print-btn:hover { background: #ecc94b; }
                        @media print { .print-btn { display: none; } }
                        .divider { height: 2px; background: #F1D24B; margin: 30px 0; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12 2L13.09 6.26L18 4L15.74 8.74L21 9L16.74 12L21 15L15.74 15.26L18 20L13.09 17.74L12 22L10.91 17.74L6 20L8.26 15.26L3 15L7.26 12L3 9L8.26 8.74L6 4L10.91 6.26L12 2Z"/>
                                    </svg>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                    <div class="school-subtitle">English School</div>
                                </div>
                            </div>
                            <div class="report-title">STUDENT REPORT CARD</div>
                        </div>
                        
                        <div class="content">
                            <div class="student-info">
                                <h3>Student Information</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Name:</span>
                                        <span class="info-value">${student.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Course Type:</span>
                                        <span class="info-value">VIP Private Lessons</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Teacher:</span>
                                        <span class="info-value">${teacher?.name || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Level:</span>
                                        <span class="info-value">${vip.level || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Report Date:</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>

                            <div class="grades-section">
                                <h3>Assessment Details</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>Assessment</th>
                                            <th>Max Score</th>
                                            <th>Score Obtained</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Midterm Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.midtermTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.midtermTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Listening Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.listeningTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.listeningTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Grammar Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.grammarTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.grammarTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Oral Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.oralTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.oralTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Class Participation</td>
                                            <td>10.0</td>
                                            <td class="score">${grades.participacao.toFixed(1)}</td>
                                            <td class="percentage">${(grades.participacao / 10 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Attendance</td>
                                            <td>10.0</td>
                                            <td class="score">${grades.assiduidade.toFixed(1)}</td>
                                            <td class="percentage">${(grades.assiduidade / 10 * 100).toFixed(1)}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="total-section">
                                <div class="total-label">Final Score</div>
                                <div class="total-score">${total.toFixed(1)}</div>
                                <div class="status ${status.toLowerCase()}">${status === 'APROVADO' ? 'APPROVED' : 'NOT APPROVED'}</div>
                                <div class="status-description">
                                    ${status === 'APROVADO' ? 
                                        'Congratulations! The student has achieved the minimum score for approval.' : 
                                        'The student has not achieved the minimum score of 70 points required for approval.'}
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="print-btn" onclick="window.print()">Print Report Card</button>
                            </div>
                        </div>

                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Generated on ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Report Card - ${student.name}`, reportHtml);
        }

        function exportStudentReportCardFromTurma(studentId, turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            const student = students.find(s => s.id === studentId);
            
            if (!turma || !student) {
                showErrorMessage("Erro", "Dados não encontrados.");
                return;
            }

            // Get student grades from turma
            const grades = (turma.studentGrades && turma.studentGrades[studentId]) || {
                midtermTest: 0,
                listeningTest: 0,
                grammarTest: 0,
                oralTest: 0,
                participacao: 0,
                assiduidade: 0
            };

            const total = grades.midtermTest + grades.listeningTest + grades.grammarTest + grades.oralTest + grades.participacao + grades.assiduidade;
            
            // Check if any grade is missing or zero (indicating incomplete assessment)
            const hasIncompleteGrades = grades.midtermTest === 0 || grades.listeningTest === 0 || grades.grammarTest === 0 || 
                                       grades.oralTest === 0 || grades.participacao === 0 || grades.assiduidade === 0;
            
            const status = hasIncompleteGrades ? 'PENDENTE' : (total >= 70 ? 'APROVADO' : 'REPROVADO');

            const reportHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Report Card - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'DM Sans', 'Arial', sans-serif; line-height: 1.5; color: #2d3748; background: #ffffff; }
                        .container { max-width: 800px; margin: 0 auto; background: white; }
                        .header { background: #F1D24B; padding: 40px 40px 30px 40px; position: relative; }
                        .logo-section { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .school-info { text-align: left; }
                        .school-name { font-size: 2.2em; font-weight: 700; color: #1a202c; letter-spacing: -0.02em; }
                        .school-subtitle { font-size: 1.1em; color: #4a5568; font-weight: 400; margin-top: 5px; }
                        .report-title { text-align: center; font-size: 1.4em; font-weight: 600; color: #1a202c; margin-top: 25px; letter-spacing: 0.05em; }
                        .content { padding: 40px; }
                        .student-info { border: 2px solid #F1D24B; padding: 25px; margin-bottom: 30px; }
                        .student-info h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
                        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
                        .info-label { color: #4a5568; font-weight: 500; }
                        .info-value { color: #1a202c; font-weight: 600; }
                        .grades-section { margin-bottom: 30px; }
                        .grades-section h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .grades-table { width: 100%; border-collapse: collapse; }
                        .grades-table th { background: #F1D24B; color: #1a202c; font-weight: 600; padding: 15px 12px; text-align: left; font-size: 0.95em; }
                        .grades-table td { padding: 15px 12px; border-bottom: 1px solid #e2e8f0; }
                        .grades-table tr:last-child td { border-bottom: none; }
                        .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
                        .status-aprovado { background: #c6f6d5; color: #276749; }
                        .status-reprovado { background: #fed7d7; color: #c53030; }
                        .status-pendente { background: #fef5e7; color: #b7791f; }
                        .footer { text-align: center; padding: 30px; color: #718096; border-top: 1px solid #e2e8f0; margin-top: 30px; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <div style="font-size: 2em; font-weight: bold; color: #F1D24B;">S</div>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP English</div>
                                    <div class="school-subtitle">School of Language and Professional Skills</div>
                                </div>
                            </div>
                            <div class="report-title">BOLETIM INDIVIDUAL</div>
                        </div>
                        
                        <div class="content">
                            <div class="student-info">
                                <h3>Informações do Aluno</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Nome:</span>
                                        <span class="info-value">${student.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Turma:</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Professor:</span>
                                        <span class="info-value">${turma.teacherName}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nível:</span>
                                        <span class="info-value">${turma.level}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grades-section">
                                <h3>Avaliações</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>Componente</th>
                                            <th>Nota</th>
                                            <th>Peso</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Midterm Test</td>
                                            <td>${grades.midtermTest}</td>
                                            <td>/20</td>
                                        </tr>
                                        <tr>
                                            <td>Listening Test</td>
                                            <td>${grades.listeningTest}</td>
                                            <td>/20</td>
                                        </tr>
                                        <tr>
                                            <td>Grammar Test</td>
                                            <td>${grades.grammarTest}</td>
                                            <td>/20</td>
                                        </tr>
                                        <tr>
                                            <td>Oral Test</td>
                                            <td>${grades.oralTest}</td>
                                            <td>/20</td>
                                        </tr>
                                        <tr>
                                            <td>Participação</td>
                                            <td>${grades.participacao}</td>
                                            <td>/10</td>
                                        </tr>
                                        <tr>
                                            <td>Assiduidade</td>
                                            <td>${grades.assiduidade}</td>
                                            <td>/10</td>
                                        </tr>
                                        <tr style="background: #f7fafc; font-weight: 600;">
                                            <td><strong>TOTAL</strong></td>
                                            <td><strong>${total.toFixed(1)}</strong></td>
                                            <td><strong>/100</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div style="margin-top: 25px; text-align: center;">
                                    <span class="status-badge status-${status.toLowerCase()}">${status}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p>SLAP English - Sistema de Avaliação Acadêmica</p>
                            <p>Relatório gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Report Card - ${student.name}`, reportHtml);
        }

        function exportTurmaReportCard(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma não encontrada."); return; }

            const turmaStudents = students.filter(s => 
                (turma.studentIds || []).includes(s.id) && (s.modalidade === 'TURMA' || s.modalidade === 'DUPLA')
            );

            if (turmaStudents.length === 0) {
                showErrorMessage("Erro", "Nenhum aluno encontrado nesta turma.");
                return;
            }

            // Collect current grades from form or stored data
            const studentsWithGrades = turmaStudents.map(student => {
                const storedGrades = (turma.studentGrades && turma.studentGrades[student.id]) || {
                    midtermTest: 0,
                    listeningTest: 0,
                    grammarTest: 0,
                    oralTest: 0,
                    participacao: 0,
                    assiduidade: 0
                };

                // Try to get current values from form if open
                const formElements = {
                    midtermTest: document.getElementById(`midterm-${student.id}`),
                    listeningTest: document.getElementById(`listening-${student.id}`),
                    grammarTest: document.getElementById(`grammar-${student.id}`),
                    oralTest: document.getElementById(`oral-${student.id}`),
                    participacao: document.getElementById(`participacao-${student.id}`),
                    assiduidade: document.getElementById(`assiduidade-${student.id}`)
                };

                const grades = { ...storedGrades };
                Object.keys(formElements).forEach(key => {
                    if (formElements[key]) {
                        grades[key] = parseFloat(formElements[key].value) || 0;
                    }
                });

                const total = grades.midtermTest + grades.listeningTest + grades.grammarTest + grades.oralTest + grades.participacao + grades.assiduidade;
                
                // Check if any grade is missing or zero
                const hasIncompleteGrades = grades.midtermTest === 0 || grades.listeningTest === 0 || grades.grammarTest === 0 || 
                                           grades.oralTest === 0 || grades.participacao === 0 || grades.assiduidade === 0;
                
                const status = hasIncompleteGrades ? 'PENDENTE' : (total >= 70 ? 'APROVADO' : 'REPROVADO');

                return { student, grades, total, status };
            });

            const reportHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Report Card - ${turma.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'DM Sans', 'Arial', sans-serif; line-height: 1.5; color: #2d3748; background: #ffffff; }
                        .container { max-width: 1200px; margin: 0 auto; background: white; }
                        .header { background: #F1D24B; padding: 40px 40px 30px 40px; position: relative; }
                        .logo-section { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .logo svg { width: 50px; height: 50px; fill: #F1D24B; }
                        .school-info { text-align: left; }
                        .school-name { font-size: 2.2em; font-weight: 700; color: #1a202c; letter-spacing: -0.02em; }
                        .school-subtitle { font-size: 1.1em; color: #4a5568; font-weight: 400; margin-top: 5px; }
                        .report-title { text-align: center; font-size: 1.4em; font-weight: 600; color: #1a202c; margin-top: 25px; letter-spacing: 0.05em; }
                        .content { padding: 40px; }
                        .turma-info { border: 2px solid #F1D24B; padding: 25px; margin-bottom: 30px; }
                        .turma-info h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
                        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
                        .info-label { color: #4a5568; font-weight: 500; }
                        .info-value { color: #1a202c; font-weight: 600; }
                        .grades-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85em; }
                        .grades-table th { background: #F1D24B; color: #1a202c; font-weight: 600; padding: 12px 8px; text-align: center; }
                        .grades-table td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #e2e8f0; }
                        .grades-table tr:last-child td { border-bottom: none; }
                        .student-name { text-align: left !important; font-weight: 600; color: #1a202c; }
                        .score { font-weight: 600; color: #1a202c; }
                        .total-column { background: #fffdf0 !important; font-weight: 700; color: #1a202c; }
                        .status { font-weight: 600; }
                        .status.aprovado { color: #38a169; }
                        .status.reprovado { color: #e53e3e; }
                        .summary { border: 2px solid #F1D24B; padding: 25px; margin: 30px 0; background: #fffdf0; }
                        .summary h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center; }
                        .stat-item { background: white; padding: 20px; border: 1px solid #e2e8f0; }
                        .stat-number { font-size: 2.5em; font-weight: 700; color: #1a202c; margin-bottom: 5px; }
                        .stat-label { color: #4a5568; font-weight: 500; }
                        .footer { border-top: 1px solid #e2e8f0; padding: 30px; text-align: center; color: #4a5568; }
                        .footer-title { font-weight: 600; font-size: 1em; margin-bottom: 5px; }
                        .footer-date { font-size: 0.9em; }
                        .print-btn { background: #F1D24B; color: #1a202c; border: none; padding: 12px 24px; font-weight: 600; cursor: pointer; margin: 20px 0; transition: all 0.2s; }
                        .print-btn:hover { background: #ecc94b; }
                        @media print { .print-btn { display: none; } }
                        .divider { height: 2px; background: #F1D24B; margin: 30px 0; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12 2L13.09 6.26L18 4L15.74 8.74L21 9L16.74 12L21 15L15.74 15.26L18 20L13.09 17.74L12 22L10.91 17.74L6 20L8.26 15.26L3 15L7.26 12L3 9L8.26 8.74L6 4L10.91 6.26L12 2Z"/>
                                    </svg>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                    <div class="school-subtitle">English School</div>
                                </div>
                            </div>
                            <div class="report-title">CLASS REPORT CARD</div>
                        </div>
                        
                        <div class="content">
                            <div class="turma-info">
                                <h3>Class Information</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Class Name:</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Teacher:</span>
                                        <span class="info-value">${turma.teacherName}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Level:</span>
                                        <span class="info-value">${turma.level}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Semester:</span>
                                        <span class="info-value">${turma.semestre || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Total Students:</span>
                                        <span class="info-value">${studentsWithGrades.length}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Report Date:</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>

                            <div class="grades-section">
                                <h3>Detailed Grades by Student</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Midterm<br>(0-20)</th>
                                            <th>Listening<br>(0-20)</th>
                                            <th>Grammar<br>(0-20)</th>
                                            <th>Oral<br>(0-20)</th>
                                            <th>Participation<br>(0-10)</th>
                                            <th>Attendance<br>(0-10)</th>
                                            <th>Final Score<br>(0-100)</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${studentsWithGrades.map(({ student, grades, total, status }) => `
                                            <tr>
                                                <td class="student-name">${student.name}</td>
                                                <td class="score">${grades.midtermTest.toFixed(1)}</td>
                                                <td class="score">${grades.listeningTest.toFixed(1)}</td>
                                                <td class="score">${grades.grammarTest.toFixed(1)}</td>
                                                <td class="score">${grades.oralTest.toFixed(1)}</td>
                                                <td class="score">${grades.participacao.toFixed(1)}</td>
                                                <td class="score">${grades.assiduidade.toFixed(1)}</td>
                                                <td class="total-column">${total.toFixed(1)}</td>
                                                <td class="status ${status.toLowerCase()}">${status === 'APROVADO' ? 'APPROVED' : 'NOT APPROVED'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>

                            <div class="summary">
                                <h3>Class Summary</h3>
                                <div class="summary-stats">
                                    <div class="stat-item">
                                        <div class="stat-number">${studentsWithGrades.filter(s => s.status === 'APROVADO').length}</div>
                                        <div class="stat-label">Approved</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${studentsWithGrades.filter(s => s.status === 'REPROVADO').length}</div>
                                        <div class="stat-label">Not Approved</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${(studentsWithGrades.reduce((sum, s) => sum + s.total, 0) / studentsWithGrades.length).toFixed(1)}</div>
                                        <div class="stat-label">Class Average</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${((studentsWithGrades.filter(s => s.status === 'APROVADO').length / studentsWithGrades.length) * 100).toFixed(1)}%</div>
                                        <div class="stat-label">Approval Rate</div>
                                    </div>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="print-btn" onclick="window.print()">Print Report Card</button>
                            </div>
                        </div>

                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Generated on ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Report Card - ${turma.name}`, reportHtml);
        }
        
        function exportIndividualStudentFromTurma(studentId, turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            const student = students.find(s => s.id === studentId);
            
            if (!turma || !student) {
                showErrorMessage("Erro", "Dados não encontrados.");
                return;
            }
            
            // Get student grades from turma data
            const grades = (turma.studentGrades && turma.studentGrades[studentId]) || {
                midtermTest: 0,
                listeningTest: 0,
                grammarTest: 0,
                oralTest: 0,
                participacao: 0,
                assiduidade: 0
            };
            
            const total = grades.midtermTest + grades.listeningTest + grades.grammarTest + grades.oralTest + grades.participacao + grades.assiduidade;
            
            // Check if any grade is missing or zero
            const hasIncompleteGrades = grades.midtermTest === 0 || grades.listeningTest === 0 || grades.grammarTest === 0 || 
                                       grades.oralTest === 0 || grades.participacao === 0 || grades.assiduidade === 0;
            
            const status = hasIncompleteGrades ? 'PENDENTE' : (total >= 70 ? 'APROVADO' : 'REPROVADO');
            
            const teacher = employees.find(emp => emp.name === turma.teacherName);
            
            const reportHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Report Card - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'DM Sans', 'Arial', sans-serif; line-height: 1.5; color: #2d3748; background: #ffffff; }
                        .container { max-width: 800px; margin: 0 auto; background: white; }
                        .header { background: #F1D24B; padding: 40px 40px 30px 40px; position: relative; }
                        .logo-section { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .logo svg { width: 50px; height: 50px; fill: #F1D24B; }
                        .school-info { text-align: left; }
                        .school-name { font-size: 2.2em; font-weight: 700; color: #1a202c; letter-spacing: -0.02em; }
                        .school-subtitle { font-size: 1.1em; color: #4a5568; font-weight: 400; margin-top: 5px; }
                        .report-title { text-align: center; font-size: 1.4em; font-weight: 600; color: #1a202c; margin-top: 25px; letter-spacing: 0.05em; }
                        .content { padding: 40px; }
                        .student-info { border: 2px solid #F1D24B; padding: 25px; margin-bottom: 30px; }
                        .student-info h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
                        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
                        .info-label { color: #4a5568; font-weight: 500; }
                        .info-value { color: #1a202c; font-weight: 600; }
                        .grades-section { margin-bottom: 30px; }
                        .grades-section h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .grades-table { width: 100%; border-collapse: collapse; }
                        .grades-table th { background: #F1D24B; color: #1a202c; font-weight: 600; padding: 15px 12px; text-align: left; font-size: 0.95em; }
                        .grades-table td { padding: 15px 12px; border-bottom: 1px solid #e2e8f0; }
                        .grades-table tr:last-child td { border-bottom: none; }
                        .score { font-weight: 600; color: #1a202c; }
                        .percentage { color: #4a5568; font-size: 0.9em; }
                        .total-section { border: 2px solid #F1D24B; padding: 30px; text-align: center; margin: 30px 0; background: #fffdf0; }
                        .total-label { font-size: 1.1em; color: #4a5568; margin-bottom: 10px; }
                        .total-score { font-size: 3em; font-weight: 700; color: #1a202c; margin-bottom: 15px; }
                        .status { font-size: 1.3em; font-weight: 600; margin-bottom: 15px; }
                        .status.aprovado { color: #38a169; }
                        .status.reprovado { color: #e53e3e; }
                        .status-description { color: #4a5568; font-size: 0.95em; line-height: 1.4; }
                        .footer { border-top: 1px solid #e2e8f0; padding: 30px; text-align: center; color: #4a5568; }
                        .footer-title { font-weight: 600; font-size: 1em; margin-bottom: 5px; }
                        .footer-date { font-size: 0.9em; }
                        .print-btn { background: #F1D24B; color: #1a202c; border: none; padding: 12px 24px; font-weight: 600; cursor: pointer; margin: 20px 0; transition: all 0.2s; }
                        .print-btn:hover { background: #ecc94b; }
                        @media print { .print-btn { display: none; } }
                        .divider { height: 2px; background: #F1D24B; margin: 30px 0; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12 2L13.09 6.26L18 4L15.74 8.74L21 9L16.74 12L21 15L15.74 15.26L18 20L13.09 17.74L12 22L10.91 17.74L6 20L8.26 15.26L3 15L7.26 12L3 9L8.26 8.74L6 4L10.91 6.26L12 2Z"/>
                                    </svg>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                    <div class="school-subtitle">English School</div>
                                </div>
                            </div>
                            <div class="report-title">STUDENT REPORT CARD</div>
                        </div>
                        
                        <div class="content">
                            <div class="student-info">
                                <h3>Student Information</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Name:</span>
                                        <span class="info-value">${student.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Course Type:</span>
                                        <span class="info-value">Group Classes</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Class:</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Teacher:</span>
                                        <span class="info-value">${teacher?.name || turma.teacherName}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Level:</span>
                                        <span class="info-value">${turma.level || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Report Date:</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>

                            <div class="grades-section">
                                <h3>Assessment Details</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>Assessment</th>
                                            <th>Max Score</th>
                                            <th>Score Obtained</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Midterm Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.midtermTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.midtermTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Listening Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.listeningTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.listeningTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Grammar Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.grammarTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.grammarTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Oral Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.oralTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.oralTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Class Participation</td>
                                            <td>10.0</td>
                                            <td class="score">${grades.participacao.toFixed(1)}</td>
                                            <td class="percentage">${(grades.participacao / 10 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Attendance</td>
                                            <td>10.0</td>
                                            <td class="score">${grades.assiduidade.toFixed(1)}</td>
                                            <td class="percentage">${(grades.assiduidade / 10 * 100).toFixed(1)}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="total-section">
                                <div class="total-label">Final Score</div>
                                <div class="total-score">${total.toFixed(1)}</div>
                                <div class="status ${status.toLowerCase()}">${status === 'APROVADO' ? 'APPROVED' : 'NOT APPROVED'}</div>
                                <div class="status-description">
                                    ${status === 'APROVADO' ? 
                                        'Congratulations! The student has achieved the minimum score for approval.' : 
                                        'The student has not achieved the minimum score of 70 points required for approval.'}
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="print-btn" onclick="window.print()">Print Report Card</button>
                            </div>
                        </div>

                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Generated on ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Report Card - ${student.name}`, reportHtml);
        }

        // Make functions globally accessible
        window.filterGuidelines = filterGuidelines;
        window.changeMonth = changeMonth;
        window.viewCalendarEvent = viewCalendarEvent;
        window.openCalendarEventForm = openCalendarEventForm;
        window.openGuidelineForm = openGuidelineForm;
        window.saveGuideline = saveGuideline;
        window.deleteGuideline = deleteGuideline;
        window.deleteGuidelineItem = deleteGuidelineItem;
        window.editGuidelineItem = editGuidelineItem;
        window.changeGuidelinePage = changeGuidelinePage;
        window.exportAlunosDoc = exportAlunosDoc;
        window.exportGuidelinesDoc = exportGuidelinesDoc;
        window.selectAnswer = selectAnswer;
        window.nextQuestion = nextQuestion;
        window.startQuiz = startQuiz;
        window.checkTimeConflict = checkTimeConflict;
        window.toggleCampanhaFinalizada = toggleCampanhaFinalizada;
        // Fluxos functions removed
        window.saveTurmaGrades = saveTurmaGrades;

        window.switchTaskTab = switchTaskTab;
        window.openTaskModal = openTaskModal;
        window.toggleTaskCompletion = toggleTaskCompletion;
        window.showSection = function(sectionName) {
            const navItem = document.querySelector(`[data-target="${sectionName}"]`);
            if (navItem) navItem.click();
        };

        async function saveGuidelines() {
            try {
                console.log('saveGuidelines called, db is:', !!db, 'appId:', appId);
                console.log('Firebase detection for save - db type:', typeof db, 'db value:', db);
                if (!db) {
                    // Local storage fallback
                    console.log('Using localStorage fallback for guidelines');
                    localStorage.setItem('slap-guidelines', JSON.stringify(guidelines));
                } else {
                    // Save to Firebase
                    console.log('Attempting to save guidelines to Firebase...');
                    const docRef = doc(db, `artifacts/${appId}/public/data`, 'guidelines');
                    await setDoc(docRef, guidelines);
                    console.log('Guidelines saved to Firebase successfully');
                }
            } catch (error) {
                console.error('Error saving guidelines:', error);
                // Fallback to localStorage if Firebase fails
                console.log('Falling back to localStorage due to error');
                localStorage.setItem('slap-guidelines', JSON.stringify(guidelines));
            }
        }

        // --- Fortune Cookie Functions ---
        // Fortune cookie phrases - 60 phrases for daily rotation
        const fortuneCookiePhrases = [
            "O sucesso é a soma de pequenos esforços repetidos dia após dia.",
            "Acredite em si mesmo e tudo será possível.",
            "Cada novo dia é uma oportunidade de crescer e aprender.",
            "A persistência é o caminho do êxito.",
            "Grandes conquistas exigem grandes sonhos.",
            "O otimismo é a fé em ação.",
            "Seja a mudança que você quer ver no mundo.",
            "O conhecimento é o único bem que cresce quando compartilhado.",
            "A educação é a arma mais poderosa para mudar o mundo.",
            "Ensinar é tocar vidas para sempre.",
            "A paciência é amarga, mas seus frutos são doces.",
            "O futuro pertence àqueles que acreditam na beleza de seus sonhos.",
            "Nunca deixe que ninguém diga que você não pode fazer algo.",
            "A única forma de fazer um excelente trabalho é amar o que você faz.",
            "O impossível é apenas uma opinião.",
            "Cada estudante que você inspira pode mudar o mundo.",
            "A motivação te leva ao início, o hábito te leva ao fim.",
            "Seja grato pelo que você tem enquanto trabalha pelo que você quer.",
            "O fracasso é apenas o primeiro passo para o sucesso.",
            "Acreditar em si mesmo é o primeiro segredo do sucesso.",
            "A diferença entre o possível e o impossível está na determinação.",
            "Um professor afeta a eternidade; nunca se sabe onde sua influência termina.",
            "A educação não é preparação para a vida; a educação é a própria vida.",
            "Seja você mesmo, todos os outros já existem.",
            "O que não nos mata, nos fortalece.",
            "A criatividade é a inteligência se divertindo.",
            "Grandes mentes discutem ideias, mentes pequenas discutem pessoas.",
            "O aprendizado nunca esgota a mente.",
            "A única constante na vida é a mudança.",
            "Seja a pessoa que você precisava quando era mais jovem.",
            "O sucesso é ir de fracasso em fracasso sem perder o entusiasmo.",
            "A educação é o passaporte para o futuro.",
            "Investir em conhecimento rende sempre os melhores juros.",
            "A mente que se abre a uma nova ideia jamais volta ao tamanho original.",
            "Não espere por oportunidades, crie-as.",
            "A coragem não é a ausência do medo, mas agir apesar dele.",
            "Cada erro é uma oportunidade de aprendizado.",
            "O professor medíocre conta, o bom professor explica, o professor superior demonstra, o grande professor inspira.",
            "Seja gentil, pois cada pessoa está enfrentando uma batalha difícil.",
            "A única competição real é com a pessoa que você foi ontem.",
            "Sonhe grande e ouse falhar.",
            "A gratidão transforma o que temos em suficiente.",
            "O conhecimento é poder, mas o conhecimento compartilhado é poder multiplicado.",
            "Seja curioso, não julgador.",
            "A perfeição não existe, mas a excelência sim.",
            "Cada dia é uma página em branco, escreva uma história bonita.",
            "A bondade é um idioma que os surdos podem ouvir e os cegos podem ver.",
            "O sucesso é medido não pelo que você conquista, mas pelo que você supera.",
            "Seja a luz que você quer ver no mundo.",
            "A vida recompensa a ação, não a intenção.",
            "Transforme obstáculos em oportunidades.",
            "A felicidade não é destino, é jornada.",
            "Seja paciente com seu progresso e gentil com seus erros.",
            "A educação é a chave que abre todas as portas.",
            "Inspire-se para inspirar outros.",
            "O hoje é resultado das escolhas de ontem, o amanhã será resultado das de hoje.",
            "Celebre pequenas vitórias, elas levam a grandes conquistas.",
            "A humildade é a base de toda verdadeira grandeza.",
            "Seja alguém que faz a diferença na vida dos outros.",
            "O sucesso não é sobre perfeição, é sobre progresso."
        ];

        // Get daily fortune cookie phrase based on current date
        function getDailyFortune() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
            const phraseIndex = dayOfYear % fortuneCookiePhrases.length;
            return fortuneCookiePhrases[phraseIndex];
        }



        function renderFortuneCookie() {
            const container = document.getElementById('fortune-cookie-content');
            if (!container) return;

            const dailyFortune = getDailyFortune();
            
            container.innerHTML = `
                <div class="fortune-card">
                    <div class="fortune-cookie-icon mb-3 text-center">
                        <svg class="w-12 h-12 mx-auto text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                    <div class="fortune-text">
                        <p class="text-center text-white font-medium leading-relaxed italic text-base">
                            "${dailyFortune}"
                        </p>
                    </div>
                    <div class="fortune-footer mt-3 text-center">
                        <span class="text-xs text-gray-300">
                            Frase do dia ${formatDateBR(new Date())}
                        </span>
                    </div>
                </div>
            `;
        }





        // --- Welcome Message Functions ---
        function extractNameFromEmail(email) {
            if (!email) return 'Usuário';
            const name = email.split('@')[0];
            return name.split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
        }

        function updateWelcomeMessages(name) {
            // Wait for DOM to be fully ready
            function tryUpdate() {
                const firstName = (name || '').split(' ')[0];
                const welcomeMsg = document.getElementById('welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.textContent = `Bem-vindo(a), ${firstName}`;
                }
                const headerWelcome = document.getElementById('header-welcome-message');
                if (headerWelcome) {
                    headerWelcome.innerHTML = `
                        <div class="text-sm font-medium">Bem-vindo(a),</div>
                        <div class="text-lg font-bold">${firstName}</div>
                    `;
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', tryUpdate);
            } else {
                tryUpdate();
            }
        }

        // --- Calendar Event Functions ---
        function openCalendarEventForm(eventId = null) {
            // Check if user has permission to create/edit events
            if (currentUserRole === 'teacher') {
                showErrorMessage("Acesso Negado", "Usuários com role 'teacher' não podem criar ou editar eventos.");
                return;
            }

            const modal = document.getElementById('calendar-event-modal');
            const form = document.getElementById('calendar-event-form');
            const title = document.getElementById('event-modal-title');

            title.textContent = eventId ? 'Editar Evento' : 'Novo Evento';

            if (eventId) {
                const event = calendarEvents.find(e => e.id === eventId);
                if (event) {
                    document.getElementById('event-title').value = event.title;
                    document.getElementById('event-date').value = event.date;
                    document.getElementById('event-time').value = event.time || '';
                    document.getElementById('event-type').value = event.type;
                    document.getElementById('event-description').value = event.description || '';
                }
            } else {
                form.reset();
            }

            modal.classList.add('visible');

            form.onsubmit = (e) => {
                e.preventDefault();
                saveCalendarEvent(eventId);
                modal.classList.remove('visible');
            };
        }

        // Initialize marketing form handler when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if marketing event form exists and add handler
            const setupMarketingFormHandler = () => {
                const marketingForm = document.getElementById('marketing-event-form');
                if (marketingForm && !marketingForm.dataset.handlerAdded) {
                    marketingForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const title = document.getElementById('marketing-event-title').value;
                        const date = document.getElementById('marketing-event-date').value;
                        const time = document.getElementById('marketing-event-time').value;
                        const link = document.getElementById('marketing-event-link').value;
                        const description = document.getElementById('marketing-event-description').value;
                        
                        // Get selected tipos
                        const checkedTipos = Array.from(document.querySelectorAll('#marketing-event-form input[name="tipos"]:checked'))
                            .map(cb => cb.value);
                        
                        const eventId = this.dataset.eventId;
                        if (eventId) {
                            // Update existing event
                            const eventIndex = marketingEvents.findIndex(e => e.id === eventId);
                            if (eventIndex !== -1) {
                                marketingEvents[eventIndex] = { 
                                    id: eventId, 
                                    title, 
                                    date, 
                                    time, 
                                    tipos: checkedTipos, 
                                    link, 
                                    description 
                                };
                            }
                        } else {
                            // Create new event
                            const newEvent = {
                                id: Date.now().toString(),
                                title,
                                date,
                                time,
                                tipos: checkedTipos,
                                link,
                                description
                            };
                            marketingEvents.push(newEvent);
                        }
                        
                        saveMarketingEvents();
                        renderMarketingCalendar();
                        
                        document.getElementById('marketing-event-modal').classList.remove('visible');
                        showSuccessMessage("Sucesso!", "Evento de marketing salvo com sucesso.");
                    });
                    marketingForm.dataset.handlerAdded = 'true';
                }
            };

            // Setup handler when page loads
            setupMarketingFormHandler();
            
            // Also setup handler whenever calendar marketing section is rendered
            const originalRenderMarketingSection = renderCalendarioMarketingSection;
            renderCalendarioMarketingSection = function() {
                originalRenderMarketingSection.apply(this, arguments);
                setTimeout(setupMarketingFormHandler, 100);
            };
        });

        async function saveCalendarEvent(eventId = null) {
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value;

            if (!title || !date) {
                showErrorMessage("Erro", "Título e data são obrigatórios.");
                return;
            }

            const eventData = { title, date, time, type, description };

            try {
                if (!db) {
                    // Development mode - save to localStorage
                    let localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
                    
                    if (eventId) {
                        const eventIndex = localEvents.findIndex(e => e.id === eventId);
                        if (eventIndex !== -1) {
                            localEvents[eventIndex] = { id: eventId, ...eventData };
                        }
                    } else {
                        const newEvent = {
                            id: Date.now().toString(),
                            ...eventData
                        };
                        localEvents.push(newEvent);
                    }
                    
                    localStorage.setItem('calendarEvents', JSON.stringify(localEvents));
                    calendarEvents = localEvents;
                    showSuccessMessage("Sucesso", "Evento salvo com sucesso.");
                } else {
                    // Firebase mode - save to database
                    if (eventId) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/calendar-events`, eventId), eventData);
                        showSuccessMessage("Sucesso", "Evento atualizado com sucesso.");
                    } else {
                        eventData.createdAt = serverTimestamp();
                        await addDoc(collection(db, `artifacts/${appId}/public/data/calendar-events`), eventData);
                        showSuccessMessage("Sucesso", "Evento criado com sucesso.");
                    }
                }
                
                closeFormModal();
                renderCalendar();
            } catch (error) {
                console.error("Error saving calendar event:", error);
                showErrorMessage("Erro", "Falha ao salvar o evento. Tente novamente.");
            }
        }

        function viewCalendarEvent(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (!event) return;

            const timeText = event.time ? `<strong>Horário:</strong> ${event.time}` : '';
            const descriptionText = event.description ? `<strong>Descrição:</strong> ${event.description}` : 'Nenhuma descrição disponível';
            const typeText = getEventTypeLabel(event.type);

            const modal = document.getElementById('form-modal');
            modal.innerHTML = `
                <div class="modal-content max-w-lg">
                    <div class="modal-header">
                        <h4>Detalhes do Evento</h4>
                        <button class="modal-close-btn" data-action="close-modal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <h3 class="text-xl font-semibold text-stone-800 mb-4">${event.title}</h3>
                        </div>
                        <div class="grid grid-cols-1 gap-3 text-sm">
                            <div><strong>Data:</strong> ${formatDateBR(event.date)}</div>
                            ${timeText ? `<div>${timeText}</div>` : ''}
                            <div><strong>Tipo:</strong> <span class="inline-block px-2 py-1 rounded text-xs bg-${getEventTypeColor(event.type)}-100 text-${getEventTypeColor(event.type)}-700">${typeText}</span></div>
                            <div class="mt-4">
                                <div>${descriptionText}</div>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2 pt-4 border-t">
                            ${['admin', 'pedagogico'].includes(currentUserRole) ? `
                                <button class="danger-btn" data-action="delete-calendar-event" data-id="${event.id}">Excluir</button>
                                <button class="secondary-btn" data-action="edit-calendar-event" data-id="${event.id}">Editar</button>
                            ` : ''}
                            <button class="primary-btn w-auto" data-action="close-modal">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.add('visible');
        }

        function getEventTypeLabel(type) {
            const types = {
                'evento': 'Evento Geral',
                'gravacao': 'Gravação',
                'lembrete': 'Lembrete',
                'aula-extra': 'Aula Extra',
                'data-comemorativa': 'Data Comemorativa',
                'reuniao': 'Reunião'
            };
            return types[type] || type;
        }

        function getEventTypeColor(type) {
            const colors = {
                'evento': 'purple',
                'gravacao': 'green',
                'lembrete': 'yellow',
                'aula-extra': 'red',
                'data-comemorativa': 'blue',
                'reuniao': 'gray'
            };
            return colors[type] || 'gray';
        }

        function renderMenu() {
            const mainNav = document.getElementById('main-navigation');
            const menuItems = [
                { key: 'inicio', label: 'Início', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'financeiro', 'teacher', 'am'] },
                { key: 'dojo', label: 'Dojo', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am'] },
                
                { key: 'alunos', label: 'Alunos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'financeiro', 'teacher', 'am'] },
                { key: 'turmas', label: 'Turmas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am'] },
                { key: 'vips', label: 'VIPs', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'am'] },
                { key: 'grade', label: 'Grade', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am'] },
                { key: 'calendario-pedagogico', label: 'Calendário Pedagógico', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am'] },
                { key: 'calendario-marketing', label: 'Calendário Marketing', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>', roles: ['admin', 'ap', 'am'] },
                { key: 'desafio-pedagogico', label: 'Desafio Pedagógico', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am'] },
                
                { key: 'campanhas', label: 'Campanhas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>', roles: ['admin', 'ap', 'am'] },
                
                { key: 'colaboradores', label: 'Colaboradores', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'ap'] },
                
                { key: 'folha-pagamento', label: 'Despesas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', roles: ['admin', 'financeiro'] }
            ];

            const menuItemsHTML = menuItems
                .filter(item => hasAccessToPage(item.key, currentUserRole))
                .map(item => `<button data-target="${item.key}" class="nav-item w-full text-left px-4 py-2.5 rounded-lg flex items-center font-semibold">${item.icon}${item.label}</button>`)
                .join('');

            mainNav.innerHTML = menuItemsHTML;
        }

        // --- SUBTLE MOUSE CLICK SOUND SYSTEM ---
        let audioContext;
        let clickSoundEnabled = true;

        // Initialize audio context
        function initializeClickSound() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (error) {
                console.log('Web Audio API not supported');
                clickSoundEnabled = false;
            }
        }

        // Generate subtle mouse click sound using Web Audio API
        function playClickSound() {
            if (!clickSoundEnabled || !audioContext) return;

            try {
                // Resume audio context if it's suspended (required for some browsers)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                // Create a very short, subtle click sound like a mouse click
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                // Connect nodes
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Configure sound - very short, low volume mouse-like click
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.02);
                
                // Very low volume and very short duration
                gainNode.gain.setValueAtTime(0.03, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.02);

                // Play very short sound (20ms)
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.02);
            } catch (error) {
                console.log('Error playing click sound:', error);
            }
        }

        // Generate error sound - low frequency, descending tone
        function playErrorSound() {
            if (!clickSoundEnabled || !audioContext) return;

            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Error sound - descending low tone
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Error playing error sound:', error);
            }
        }

        // Generate success sound - ascending tone, pleasant
        function playSuccessSound() {
            if (!clickSoundEnabled || !audioContext) return;

            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Success sound - ascending pleasant tone
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(900, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.04, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('Error playing success sound:', error);
            }
        }

        // Add click sound to interactive elements
        function addClickSoundToElement(element) {
            if (element && !element.hasClickSound) {
                element.addEventListener('click', playClickSound);
                element.hasClickSound = true;
            }
        }

        // Add click sounds only to specific button elements (more selective)
        function initializeClickSounds() {
            const selectors = [
                'button:not(input)',  // Buttons but not input buttons
                '.nav-item',          // Navigation items
                '.primary-btn',       // Primary buttons
                '.secondary-btn',     // Secondary buttons
                '.danger-btn'         // Danger buttons
            ];

            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(addClickSoundToElement);
            });
        }

        // Observer to add click sounds to dynamically created elements
        function observeNewElements() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            // Check if the added node itself is interactive
                            const selectors = ['button', '.nav-item', '[data-action]', 'input[type="checkbox"]', 'input[type="radio"]', '.clickable', 'a[href]'];
                            selectors.forEach(selector => {
                                if (node.matches && node.matches(selector)) {
                                    addClickSoundToElement(node);
                                }
                                // Also check children
                                node.querySelectorAll && node.querySelectorAll(selector).forEach(addClickSoundToElement);
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Role-based access control
        function hasAccessToPage(pageKey, userRole) {
            const pagePermissions = {
                'inicio': ['admin', 'pedagogico', 'ap', 'financeiro', 'teacher', 'am'], // Dashboard - everyone
                'alunos': ['admin', 'pedagogico', 'ap', 'financeiro', 'teacher', 'am'], // Students - everyone  
                'turmas': ['admin', 'pedagogico', 'ap', 'teacher', 'am'], // Classes - no financeiro
                'vips': ['admin', 'pedagogico', 'ap', 'am'], // VIPs - restricted (no teacher, no financeiro)
                'campanhas': ['admin', 'ap', 'am'], // Campaigns - marketing only
                'grade': ['admin', 'pedagogico', 'ap', 'teacher', 'am'], // Schedule - no financeiro
                'folha-pagamento': ['admin', 'financeiro'], // Payroll/Expenses - FINANCIAL ONLY
                'colaboradores': ['admin', 'ap'], // Collaborators - admin and AP only
                'dojo': ['admin', 'pedagogico', 'ap', 'teacher', 'am'], // Dojo - everyone except financeiro
                'calendario-pedagogico': ['admin', 'pedagogico', 'ap', 'teacher', 'am'], // Pedagogical calendar
                'calendario-marketing': ['admin', 'ap', 'am'], // Marketing calendar
                'desafio-pedagogico': ['admin', 'pedagogico', 'ap', 'teacher', 'am'] // Pedagogical challenges
            };
            
            return pagePermissions[pageKey]?.includes(userRole) || false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const pageRenderers = { 'inicio': renderInicioSection, 'alunos': renderAlunosSection, 'turmas': renderTurmasSection, 'vips': renderVipsSection, 'campanhas': renderCampanhasSection, 'tarefas': renderTarefasSection, 'grade': renderGradeSection, 'folha-pagamento': renderFolhaPagamentoSection, 'colaboradores': renderColaboradoresSection, 'dojo': renderDojoSection, 'calendario-pedagogico': renderCalendarioPedagogicoSection, 'calendario-marketing': renderCalendarioMarketingSection, 'desafio-pedagogico': renderDesafioPedagogicoSection };

            document.body.addEventListener('click', (event) => {
                // Close modals when clicking overlay or close button
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-calendar-modal"]')) {
                    document.getElementById('calendar-event-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-guideline-modal"]')) {
                    document.getElementById('guideline-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-highlight-modal"]')) {
                    document.getElementById('monthly-highlight-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-challenge-modal"]')) {
                    document.getElementById('challenge-edit-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-fluxo-modal"]')) {
                    const fluxoModal = document.getElementById('fluxo-modal');
                    if (fluxoModal) fluxoModal.classList.remove('visible');
                }

                const navTarget = event.target.closest('.nav-item');
                if (navTarget && !navTarget.disabled && !event.target.closest('[data-action]')) {
                    const pageKey = navTarget.dataset.target;
                    
                    if (pageKey && pageRenderers[pageKey]) {
                        // CRITICAL SECURITY: Check role-based access before allowing navigation
                        if (!hasAccessToPage(pageKey, currentUserRole)) {
                            console.warn(`Access denied: User role '${currentUserRole}' cannot access page '${pageKey}'`);
                            showErrorMessage("Acesso Negado", `Você não tem permissão para acessar esta seção.`);
                            return;
                        }
                        
                        // Clear any existing timeouts or intervals that might interfere
                        clearTimeout(window.navigationTimeout);
                        
                        // Reset pagination and render the new section
                        resetPagination();
                        pageRenderers[pageKey]();
                        setActiveNavItem(navTarget);
                        
                        // Prevent any further event bubbling
                        event.stopPropagation();
                        event.preventDefault();
                    }
                }

                const actionTarget = event.target.closest('[data-action]');
                if (actionTarget) {
                    // Prevent navigation interference with action buttons
                    event.stopPropagation();
                    
                    if(actionTarget.closest('.modal-content') && !['close-modal', 'export-vip-pef', 'export-turma-pef'].includes(actionTarget.dataset.action)) event.stopPropagation();

                    const { action, id, collection, nivelId, aulaIndex, direction, unitId, lessonNumber, status } = actionTarget.dataset;
                    console.log('Action triggered:', action, 'ID:', id);
                    const actionHandlers = {
                        'open-signup': openSignUpModal,
                        'add-aluno': () => openAlunoForm(),
                        'view-aluno': () => openAlunoModal(id),
                        'edit-aluno': () => openAlunoForm(id),
                        'add-turma': () => openTurmaForm(),
                        'open-turma-pef': () => openTurmaPefModal(id),
                        'edit-turma': () => openTurmaForm(id),

                        'add-vip': () => openVipForm(),
                        'edit-vip': () => openVipForm(id),
                        'open-vip-pef': () => openVipPefModal(id),
                        'open-vip-notas': () => openVipNotasModal(id),
                        'open-turma-notas': () => openTurmaNotasModal(id),
                        'mark-attendance': () => {
                            const button = actionTarget;
                            const group = button.closest('.pef-status-btn-group');
                            if (!group) return;

                            if (button.classList.contains('active')) {
                                button.classList.remove('active', 'P', 'F', 'PP');
                            } else {
                                group.querySelectorAll('button').forEach(btn => btn.classList.remove('active', 'P', 'F', 'PP'));
                                button.classList.add('active', status);
                            }
                        },
                        'save-pef-lesson': () => savePefLesson(unitId, lessonNumber),
                        'save-all-pef-lessons': () => {
                            console.log("save-all-pef-lessons handler triggered");
                            console.log("actionTarget:", actionTarget);
                            const unitId = actionTarget.getAttribute('data-unit-id');
                            const pefType = actionTarget.getAttribute('data-pef-type');
                            console.log("unitId:", unitId, "pefType:", pefType);
                            saveAllPefLessons(unitId, pefType);
                        },
                        'add-campanha': () => {
                            console.log('add-campanha action triggered');
                            openCampanhaForm();
                        },
                        'view-campanha': () => openCampanhaModal(id),
                        'edit-campanha': () => openCampanhaForm(id),


                        // Fluxo modal handler removed
                        'add-passo': () => addPasso(),
                        'add-documento': () => addDocumento(),
                        'remove-passo': () => {
                            event.target.closest('.flex.items-center.space-x-2').remove();
                            updatePassoNumbers();
                        },
                        'remove-documento': () => {
                            event.target.closest('.flex.items-center.space-x-2').remove();
                        },

                        'add-task': openTaskForm,
                        'edit-task': () => openTaskForm(id),
                        'view-task': () => openTaskModal(id),
                        'add-collaborator': () => openCollaboratorForm(),
                        'edit-collaborator': () => openCollaboratorForm(id),
                        'edit-monthly-highlight': openMonthlyHighlightForm,


                        'add-schedule': openScheduleForm,
                        'add-break': openBreakForm,
                        'view-schedule': () => openScheduleForm(id),
                        'add-expense': openExpenseForm,
                        'view-expense': () => openExpenseForm(id),

                        'delete-item': () => safeDeleteItem(collection, id),
                        'close-modal': closeFormModal,


                        'add-dojo-competitor': () => openDojoCompetitorForm(),
                        'edit-dojo-points': () => openDojoPointsForm(id),
                        'edit-dojo-competitor': () => openDojoCompetitorForm(id),
                        'add-dojo-mission': openDojoMissionForm,
                        'export-alunos-doc': exportAlunosDoc,
                        'export-vip-pef': () => exportVipPef(id),
                        'export-turma-pef': () => exportTurmaPef(id),
                        'export-student-pef': () => {
                            const turmaId = actionTarget.dataset.turmaId;
                            const studentId = actionTarget.dataset.studentId;
                            exportStudentPef(turmaId, studentId);
                        },
                        'export-student-report-card': () => {
                            const turmaId = actionTarget.dataset.turmaId;
                            const studentId = actionTarget.dataset.studentId;
                            exportStudentReportCardFromTurma(studentId, turmaId);
                        },

                        'add-calendar-event': openCalendarEventForm,
                        'view-calendar-event': () => viewCalendarEvent(id),
                        'edit-calendar-event': () => {
                            if (currentUserRole === 'teacher') {
                                showErrorMessage("Acesso Negado", "Usuários com role 'teacher' não podem editar eventos.");
                                return;
                            }
                            openCalendarEventForm(id);
                        },
                        'add-marketing-event': openMarketingEventForm,
                        'view-marketing-event': () => viewMarketingEvent(id),
                        'edit-marketing-event': () => {
                            if (!['admin', 'am', 'pedagogico', 'financeiro'].includes(currentUserRole)) {
                                showErrorMessage("Acesso Negado", "Apenas admins, marketing managers, pedagógico e financeiro podem editar eventos de marketing.");
                                return;
                            }
                            // Close any existing modal first
                            document.getElementById('form-modal').classList.remove('visible');
                            // Wait a moment for the closing animation
                            setTimeout(() => {
                                openMarketingEventForm(id);
                            }, 300);
                        },
                        'change-marketing-month': () => changeMarketingMonth(parseInt(direction) || 0),
                        'close-marketing-modal': () => {
                            document.getElementById('marketing-event-modal').classList.remove('visible');
                        },
                        'add-guideline': openGuidelineForm,
                        'export-guidelines': exportGuidelinesDoc,
                        'edit-monthly-highlight': openMonthlyHighlightForm,
                        'edit-challenge-content': openChallengeContentForm,
                        'delete-calendar-event': () => {
                            if (id) {
                                deleteCalendarEvent(id);
                            } else {
                                console.error('Event ID not found for deletion');
                                showErrorMessage("Erro", "ID do evento não encontrado.");
                            }
                        },
                        'delete-vip': () => deleteVip(id),
                        'delete-all-vips': deleteAllVips,

                        'debug-sync-status': debugSyncStatus,
                    };
                    if (actionHandlers[action]) {
                        console.log('Executing action:', action);
                        actionHandlers[action]();
                    } else {
                        console.warn('No handler found for action:', action);
                    }
                }

                if(event.target.matches('input[type="checkbox"][data-action="toggle-task"]')) {
                    const taskId = event.target.dataset.id;
                    const isCompleted = event.target.checked;
                    toggleTaskCompletion(taskId, isCompleted);
                }
                 if(event.target.matches('input[type="checkbox"][data-action="toggle-expense"]')) {
                    const expenseId = event.target.dataset.id;
                    const isPaid = event.target.checked;
                    toggleExpensePaid(expenseId, isPaid);
                }
            });

            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('pending-logout').addEventListener('click', handleLogout);
            
            // Always load dashboard on startup - FORCE INICIO SECTION
            window.navigationTimeout = setTimeout(() => {
                // Force dashboard render regardless of other listeners
                renderInicioSection(); 
                setActiveNavItem(document.querySelector('[data-target="inicio"]'));
                console.log('Dashboard forced to load on startup');
            }, 200);
            
            // Initialize click sound system
            initializeClickSound();
            initializeClickSounds();
            observeNewElements();
            
            initializeFirebase();
        });
    </script>
</body>
</html>
